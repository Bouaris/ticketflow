---
phase: 24-validation-generation-ux
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/ai-health.ts
  - src/components/settings/ProviderCard.tsx
autonomous: true

must_haves:
  truths:
    - "User can click 'Test Connection' on an active ProviderCard and see latency or error details"
    - "Health check uses minimal tokens (maxTokens: 5) with 10s timeout to avoid rate-limit consumption"
    - "Error classification distinguishes auth, rate_limit, timeout, network, and unknown errors"
    - "Gemini ProviderCard shows free tier recommendation info (15 req/min, 1M tokens/day)"
    - "Health check result auto-clears after 3 seconds on success"
  artifacts:
    - path: "src/lib/ai-health.ts"
      provides: "Provider health check with error classification"
      exports: ["testProviderHealth", "HealthCheckResult"]
    - path: "src/components/settings/ProviderCard.tsx"
      provides: "Test Connection button and Gemini tooltip in provider cards"
  key_links:
    - from: "src/components/settings/ProviderCard.tsx"
      to: "src/lib/ai-health.ts"
      via: "testProviderHealth() import"
      pattern: "testProviderHealth"
    - from: "src/lib/ai-health.ts"
      to: "src/lib/abort.ts"
      via: "createTimeoutController, clearControllerTimeout, isAbortError imports"
      pattern: "createTimeoutController|clearControllerTimeout|isAbortError"
    - from: "src/lib/ai-health.ts"
      to: "src/lib/ai.ts"
      via: "generateCompletion call for minimal test request"
      pattern: "generateCompletion"
---

<objective>
Create the provider health check module and integrate it into ProviderCard with a "Test Connection" button. Add Gemini free tier recommendation info.

Purpose: Fulfill PROV-04 (test provider connection with latency/error details) and GENX-04 (Gemini free tier tooltip). These are the provider-facing improvements users see in AI Settings.

Output: `src/lib/ai-health.ts` (new), updated `src/components/settings/ProviderCard.tsx`
</objective>

<execution_context>
@C:/Users/Boris/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Boris/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/24-validation-generation-ux/24-RESEARCH.md
@src/lib/abort.ts
@src/lib/ai.ts
@src/components/settings/ProviderCard.tsx
@src/components/settings/AISettingsModal.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ai-health.ts with testProviderHealth function</name>
  <files>src/lib/ai-health.ts</files>
  <action>
Create a NEW file `src/lib/ai-health.ts` with the following:

1. **Import** `createTimeoutController`, `clearControllerTimeout`, `isAbortError` from `./abort`.

2. **Export interface `HealthCheckResult`:**
   ```typescript
   export interface HealthCheckResult {
     success: boolean;
     latencyMs?: number;
     error?: string;
     errorType?: 'network' | 'auth' | 'rate_limit' | 'timeout' | 'unknown';
   }
   ```

3. **Export async function `testProviderHealth(providerId: string, timeoutMs = 10000): Promise<HealthCheckResult>`:**
   - Record `startTime = Date.now()`
   - Create timeout controller via `createTimeoutController(timeoutMs)`
   - **IMPORTANT:** Cannot directly import `generateCompletion` from `./ai` because it's NOT exported (it's a private function). Instead, import `getClientConfig`, `getEffectiveAIConfig`, and the provider-specific client getters are also private.
   - **Solution:** Export a new `testCompletion` wrapper from `ai.ts` that takes a provider ID, sends a minimal "Test" prompt with maxTokens: 5, and returns the response. OR, simply re-implement a minimal test inline using the SDK clients directly.
   - **Better approach:** Add a new exported function `generateTestCompletion(providerId: string): Promise<string>` to `ai.ts` that calls `generateCompletion("Test", { provider: providerId, maxTokens: 5 })` internally. This avoids exposing `generateCompletion` broadly.

   **WAIT — actually `generateCompletion` is module-private but we can still use a public function. Looking at the code: `generateCompletionWithRetry` is exported. But for health check, we want NO retry and minimal overhead.**

   **REVISED APPROACH:** Instead of importing a private function, the health check will use the *existing public* AI functions. Specifically:
   - Import `getClientConfig`, `getProvider`, `getProviderDisplayName` from `./ai`
   - Import `getProviderById` from `./ai-provider-registry`
   - Import SDK clients: `Groq` from `groq-sdk`, `GoogleGenerativeAI` from `@google/generative-ai`, `OpenAI` from `openai`
   - Import `AI_CONFIG` from `../constants/config`
   - Build a minimal completion request directly against the SDK (same pattern as `generateCompletion` but stripped down)

   **Actually, the cleanest approach:** Add a small exported helper to `ai.ts`. Add this at the bottom of the UNIFIED COMPLETION API section:

   In `src/lib/ai.ts`, add a new exported function:
   ```typescript
   /**
    * Test provider connectivity with minimal token usage.
    * Used by health check — no retry, no telemetry, no context.
    */
   export async function testProviderConnection(providerId?: string): Promise<string> {
     return generateCompletion('Test', { provider: providerId, maxTokens: 5 });
   }
   ```

   Then in `ai-health.ts`:
   ```typescript
   import { testProviderConnection } from './ai';
   import { createTimeoutController, clearControllerTimeout, isAbortError } from './abort';
   ```

   The `testProviderHealth` function:
   - try block: call `testProviderConnection(providerId)`, return `{ success: true, latencyMs: Date.now() - startTime }`
   - catch block: classify error:
     - `isAbortError(error)` → `{ success: false, latencyMs, error: 'Connection timeout', errorType: 'timeout' }`
     - Regex `/\b(401|403)\b|unauthorized|forbidden|invalid.*api.*key/i` → `errorType: 'auth'`
     - Regex `/\b429\b|rate.?limit|resource.?exhausted/i` → `errorType: 'rate_limit'`
     - Regex `/network|fetch|ECONNREFUSED|ENOTFOUND|ERR_NAME/i` → `errorType: 'network'`
     - Default → `errorType: 'unknown'`
   - finally block: `clearControllerTimeout(controller)`

   **NOTE:** The timeout controller's signal is not currently passed to `testProviderConnection` because `generateCompletion` doesn't accept a signal yet (that's Plan 24-02). For now, the timeout controller serves as a local safety net — if the operation hangs beyond 10s, we detect it via timing. The actual cancellation of the underlying HTTP request will be added in Plan 02 when signal propagation is implemented. The health check will still work correctly: it measures latency and classifies errors.

4. Add JSDoc documentation to the module and function.
  </action>
  <verify>
`pnpm build` passes. `src/lib/ai-health.ts` exists and exports `testProviderHealth` and `HealthCheckResult`. `src/lib/ai.ts` exports `testProviderConnection`.
  </verify>
  <done>
ai-health.ts module exists with testProviderHealth that calls testProviderConnection, classifies errors into 5 types, measures latency, and uses timeout controller for safety.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add Test Connection button and Gemini tooltip to ProviderCard</name>
  <files>src/components/settings/ProviderCard.tsx</files>
  <action>
Update `src/components/settings/ProviderCard.tsx`:

1. **Import** `testProviderHealth` and `HealthCheckResult` from `../../lib/ai-health`.
2. **Import** `Spinner` from `../ui/Spinner`.

3. **Add state** for health check:
   ```typescript
   const [healthCheck, setHealthCheck] = useState<{
     loading: boolean;
     result: HealthCheckResult | null;
   }>({ loading: false, result: null });
   ```

4. **Add `handleTestConnection` function:**
   - Set `healthCheck` to `{ loading: true, result: null }`
   - Call `const result = await testProviderHealth(provider.id)`
   - Set `healthCheck` to `{ loading: false, result }`
   - If `result.success`, auto-clear after 3 seconds: `setTimeout(() => setHealthCheck({ loading: false, result: null }), 3000)`

5. **Add Test Connection UI** inside the `{isActive && (...)}` block, AFTER the API key action buttons div and BEFORE the closing `</div>` of the active section:
   ```tsx
   {/* Health Check */}
   <div className="pt-3 border-t border-outline">
     <button
       onClick={handleTestConnection}
       disabled={!isConfigured || healthCheck.loading}
       className="text-sm text-accent-text hover:underline disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2"
     >
       {healthCheck.loading && <Spinner size="sm" />}
       {healthCheck.loading ? t.settings.testing : t.settings.testConnection}
     </button>

     {healthCheck.result && (
       <div className={`mt-2 px-3 py-2 rounded-lg text-xs ${
         healthCheck.result.success
           ? 'bg-green-50 text-green-700 dark:bg-green-900/20 dark:text-green-400'
           : 'bg-red-50 text-red-700 dark:bg-red-900/20 dark:text-red-400'
       }`}>
         {healthCheck.result.success ? (
           <span>{t.settings.connectionSuccess} ({healthCheck.result.latencyMs}ms)</span>
         ) : (
           <span>
             {healthCheck.result.errorType === 'auth' && t.settings.healthErrorAuth}
             {healthCheck.result.errorType === 'rate_limit' && t.settings.healthErrorRateLimit}
             {healthCheck.result.errorType === 'timeout' && t.settings.healthErrorTimeout}
             {healthCheck.result.errorType === 'network' && t.settings.healthErrorNetwork}
             {healthCheck.result.errorType === 'unknown' && (healthCheck.result.error || t.settings.healthErrorUnknown)}
           </span>
         )}
       </div>
     )}
   </div>
   ```

6. **Update Gemini description** to include free tier recommendation (GENX-04):
   Change the Gemini description line from:
   ```
   {provider.id === 'gemini' && (locale === 'fr' ? '15 req/min, 1M tokens/jour (Gemini 2.0 Flash)' : '15 req/min, 1M tokens/day (Gemini 2.0 Flash)')}
   ```
   To use i18n keys and add a recommendation badge. Replace the description section with:
   ```tsx
   <p className="text-sm text-on-surface-muted mb-3">
     {provider.id === 'groq' && t.settings.groqDescription}
     {provider.id === 'gemini' && (
       <span>
         {t.settings.geminiDescription}
         <span className="ml-2 inline-flex items-center px-1.5 py-0.5 rounded text-xs font-medium bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-400">
           {t.settings.geminiRecommended}
         </span>
       </span>
     )}
     {provider.id === 'openai' && t.settings.openaiDescription}
   </p>
   ```

7. **Add i18n keys** — since Plan 24-02 handles i18n file updates, use hardcoded strings with `// TODO: i18n` comments for now. Actually, looking at the plan structure, i18n is in Plan 24-02. Use hardcoded strings temporarily:
   - For health check strings, use direct English fallbacks wrapped in the pattern the codebase uses
   - Actually, let's just add the i18n keys directly here since we're modifying the i18n files anyway

**UPDATE: Since i18n files are handled in Plan 02, use hardcoded strings here and Plan 02 will replace them with proper i18n keys. Mark with `// TODO: 24-02 i18n` comments.**

Actually, re-reading the plan structure: Plan 02 handles i18n for the entire phase. So use hardcoded English strings in this plan, and Plan 02 will add the proper keys. This matches the 23-01 pattern where hardcoded strings were used with TODO comments, then Plan 02 added i18n.

However, looking more carefully, i18n is part of INTL-03 requirement. Let me assign i18n to THIS plan instead, since ProviderCard needs the keys immediately.

**FINAL DECISION:** Add all needed i18n keys for Phase 24 in this task. This covers:
- Health check keys (testing, testConnection, connectionSuccess, healthError*)
- Provider description keys (groqDescription, geminiDescription, openaiDescription, geminiRecommended)
- Generation progress keys (for Plan 24-03 to consume): analyzing, generatingStructure, finalizing, cancelGeneration (some already exist)
- Error feedback keys: retryGeneration, generationCancelled

Add these keys to `src/i18n/types.ts` (in the settings section), `src/i18n/locales/en.ts`, and `src/i18n/locales/fr.ts`.

**Wait — this would change the files_modified list and create conflicts with Plan 02.** Let me keep it simple: this plan adds ONLY the strings it directly needs. Use the `settings` section for health-check and description strings. Plan 03 (wave 2) will add generation UX i18n since it modifies the editor components.

Add to the `settings` section in types.ts/en.ts/fr.ts:
```
testConnection: string;
testing: string;
connectionSuccess: string;
healthErrorAuth: string;
healthErrorRateLimit: string;
healthErrorTimeout: string;
healthErrorNetwork: string;
healthErrorUnknown: string;
groqDescription: string;
geminiDescription: string;
openaiDescription: string;
geminiRecommended: string;
```

EN values:
```
testConnection: 'Test Connection',
testing: 'Testing...',
connectionSuccess: 'Connection successful',
healthErrorAuth: 'Invalid API key. Check your key and try again.',
healthErrorRateLimit: 'Rate limit reached. Wait a moment and retry.',
healthErrorTimeout: 'Connection timed out. Check your network or provider status.',
healthErrorNetwork: 'Network error. Check your internet connection.',
healthErrorUnknown: 'Connection failed. Try again later.',
groqDescription: '14,400 req/day free, ultra fast (Llama 3.3 70B)',
geminiDescription: '15 req/min, 1M tokens/day free (Gemini 2.0 Flash)',
openaiDescription: 'GPT-4o and GPT-4o Mini, paid',
geminiRecommended: 'Recommended free tier',
```

FR values:
```
testConnection: 'Tester la connexion',
testing: 'Test en cours...',
connectionSuccess: 'Connexion reussie',
healthErrorAuth: 'Cle API invalide. Verifiez votre cle et reessayez.',
healthErrorRateLimit: 'Limite de requetes atteinte. Patientez un instant.',
healthErrorTimeout: 'Connexion expiree. Verifiez votre reseau ou le statut du fournisseur.',
healthErrorNetwork: 'Erreur reseau. Verifiez votre connexion internet.',
healthErrorUnknown: 'Echec de connexion. Reessayez plus tard.',
groqDescription: '14 400 req/jour gratuit, ultra rapide (Llama 3.3 70B)',
geminiDescription: '15 req/min, 1M tokens/jour gratuit (Gemini 2.0 Flash)',
openaiDescription: 'GPT-4o et GPT-4o Mini, payant',
geminiRecommended: 'Gratuit recommande',
```
  </action>
  <verify>
`pnpm build` passes. ProviderCard shows "Test Connection" button when active and configured. Gemini card shows "Recommended free tier" badge. i18n keys added in types.ts, en.ts, fr.ts.
  </verify>
  <done>
ProviderCard has a "Test Connection" button that calls testProviderHealth, shows spinner while testing, displays success with latency or classified error message. Gemini card has green "Recommended free tier" badge. All new i18n keys for health check and provider descriptions added (FR + EN).
  </done>
</task>

</tasks>

<verification>
1. `pnpm build` passes without TypeScript errors
2. `src/lib/ai-health.ts` exports `testProviderHealth` and `HealthCheckResult`
3. `src/lib/ai.ts` exports `testProviderConnection`
4. `ProviderCard.tsx` imports and uses `testProviderHealth`
5. Gemini card shows recommendation badge
6. i18n keys for health check exist in types.ts, en.ts, fr.ts
7. No unused imports in any modified file
</verification>

<success_criteria>
- Health check module testable via ProviderCard "Test Connection" button
- Error types classified: auth, rate_limit, timeout, network, unknown
- Latency displayed on success, auto-clears after 3s
- Gemini free tier info visible in provider card
- All strings internationalized (FR + EN)
- `pnpm build` passes
</success_criteria>

<output>
After completion, create `.planning/phases/24-validation-generation-ux/24-01-SUMMARY.md`
</output>
