---
phase: 36-security-dependencies-cleanup
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - .github/workflows/ci.yml
  - SECURITY.md
autonomous: true
requirements: [FIX-14]

must_haves:
  truths:
    - "All CI actions in ci.yml reference commit SHAs, not mutable tags"
    - "SECURITY.md documents the ph_send_batch IPC api_key accepted risk with rationale"
    - "SECURITY.md documents the devtools:true accepted risk with rationale"
  artifacts:
    - path: ".github/workflows/ci.yml"
      provides: "SHA-pinned GitHub Actions"
      contains: "actions/checkout@"
    - path: "SECURITY.md"
      provides: "Accepted risk documentation for SEC-D2 and SEC-D10"
      contains: "ph_send_batch"
  key_links:
    - from: ".github/workflows/ci.yml"
      to: "GitHub Actions runners"
      via: "SHA-pinned action references"
      pattern: "uses: .+@[a-f0-9]{40}"
---

<objective>
Harden CI supply chain by SHA-pinning all GitHub Actions, and document accepted security risks (IPC api_key pass-through, devtools always enabled) in SECURITY.md.

Purpose: Closes SEC-D2, SEC-D8, SEC-D10 from AUDIT-REPORT.md — eliminates CI tag-mutation risk and formally documents the two low-risk security findings as accepted.
Output: SHA-pinned ci.yml, updated SECURITY.md with accepted risk section.
</objective>

<execution_context>
@C:/Users/Boris/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Boris/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.github/workflows/ci.yml
@SECURITY.md
@AUDIT-REPORT.md
@src-tauri/src/telemetry.rs
@src-tauri/tauri.conf.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: SHA-pin all GitHub Actions in ci.yml</name>
  <files>.github/workflows/ci.yml</files>
  <action>
Replace all tag-pinned action references with SHA-pinned versions. Keep the tag as a trailing comment for readability.

Current tag-pinned actions to replace:
1. `actions/checkout@v4` -> `actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4`
2. `pnpm/action-setup@v2` -> `pnpm/action-setup@a7487c7e89a18df77c0e7e2bc951ccc38161f834 # v2`
3. `actions/setup-node@v4` -> `actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4`

IMPORTANT: Look up the actual latest SHA for each action's tag on GitHub before pinning. Use `gh api` to resolve the SHAs:
- `gh api repos/actions/checkout/git/ref/tags/v4 --jq '.object.sha'`
- `gh api repos/pnpm/action-setup/git/ref/tags/v2 --jq '.object.sha'`
- `gh api repos/actions/setup-node/git/ref/tags/v4 --jq '.object.sha'`

If the tag points to an annotated tag (object.type == "tag"), dereference to get the commit SHA:
- `gh api repos/{owner}/{repo}/git/tags/{tag_sha} --jq '.object.sha'`

Keep the `# v4` / `# v2` comment suffix so humans can tell which version the SHA corresponds to.
  </action>
  <verify>
Grep ci.yml for `@v` — should return zero matches. Grep for `@[a-f0-9]` — should match all 3 `uses:` lines. Validate YAML syntax with `python -c "import yaml; yaml.safe_load(open('.github/workflows/ci.yml'))"` or similar.
  </verify>
  <done>All 3 GitHub Actions in ci.yml use SHA-pinned references with human-readable tag comments. No mutable tag references remain.</done>
</task>

<task type="auto">
  <name>Task 2: Document accepted security risks in SECURITY.md</name>
  <files>SECURITY.md</files>
  <action>
Add a new section "## Accepted Risks" after the "Secure Development Practices" section and before the footer. Document two items:

**1. IPC api_key Pass-Through (SEC-D2)**
- The `ph_send_batch` Rust command accepts `api_key: String` from the frontend webview without validating it against the compiled-in `POSTHOG_API_KEY` constant.
- Risk: A malicious script in the webview could invoke the command with an arbitrary PostHog key to redirect telemetry data.
- Mitigations: (a) Tauri CSP prevents external script injection; (b) telemetry is opt-in and disabled by default; (c) the PostHog key is write-only and contains no sensitive data; (d) the webview is a trusted execution context in Tauri's security model.
- Accepted because: The attack requires bypassing CSP to inject code into the Tauri webview, which is already a complete compromise. Validating the key would add complexity without meaningfully reducing the attack surface.

**2. DevTools Always Enabled (SEC-D10)**
- `devtools: true` in `src-tauri/tauri.conf.json` enables browser DevTools in all build modes (dev and production).
- Risk: Users can inspect localStorage where XOR-obfuscated API keys are stored.
- Mitigations: (a) BYOK model means users own their keys and already have them; (b) XOR obfuscation prevents casual inspection; (c) desktop app runs on user's own machine where they already have full disk access; (d) disabling DevTools would hinder debugging for advanced users.
- Accepted because: TicketFlow is a local-first desktop app where the user is the sole operator. Disabling DevTools provides no security benefit against the actual threat model (user's own machine).

Also update the "Security Audits" section to reference the Phase 31 audit (2026-02-18) as the most recent audit, mentioning the Phase 36 hardening.

Update the footer version to 2.2.1 and last updated date to 2026-02-19.
  </action>
  <verify>
Read SECURITY.md and confirm:
1. "Accepted Risks" section exists with SEC-D2 and SEC-D10 entries
2. Each entry has risk description, mitigations list, and acceptance rationale
3. Security Audits section references Phase 31
4. Footer shows version 2.2.1, date 2026-02-19
  </verify>
  <done>SECURITY.md documents both SEC-D2 (IPC api_key) and SEC-D10 (devtools) as accepted risks with full rationale. Security audit history updated.</done>
</task>

</tasks>

<verification>
1. `grep -c '@v' .github/workflows/ci.yml` returns 0
2. `grep -cP '@[a-f0-9]{7,}' .github/workflows/ci.yml` returns 3
3. SECURITY.md contains "Accepted Risks" section
4. SECURITY.md contains "ph_send_batch" and "devtools" in the accepted risks section
5. `pnpm build` passes (no source changes, just config and docs)
</verification>

<success_criteria>
- ci.yml has zero tag-pinned actions, all 3 are SHA-pinned with comment tags
- SECURITY.md formally documents SEC-D2 and SEC-D10 as accepted risks
- Both files pass validation (YAML syntax for ci.yml, markdown renders correctly)
</success_criteria>

<output>
After completion, create `.planning/phases/36-security-dependencies-cleanup/36-01-SUMMARY.md`
</output>
