---
phase: 34-dead-code-sweep
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/ai.ts
  - src/lib/ai-bulk.ts
  - src/lib/ai-chat.ts
  - src/lib/ai-dependencies.ts
  - src/lib/ai-questioning.ts
  - src/hooks/useAIFeedback.ts
  - src/lib/telemetry.ts
autonomous: true
gap_closure: true
requirements: [FIX-06, FIX-07]
must_haves:
  truths:
    - "getEffectiveAIConfig() no longer accepts any parameter — function signature is bare `(): { provider, modelId }`"
    - "All 16+ call sites pass zero arguments to getEffectiveAIConfig() — no `options?.projectPath` passed anywhere"
    - "shutdownTelemetry export is removed from telemetry.ts with a comment explaining Rust WAL persistence"
    - "Magic number 200 is extracted to MAX_ERROR_MESSAGE_CHARS constant in telemetry.ts"
    - "shouldPromptConsent() uses hasBeenDismissedTooManyTimes named boolean for readability"
    - "Error severity policy is documented as a code comment in telemetry.ts"
    - "pnpm build passes with zero TypeScript errors"
  artifacts:
    - path: "src/lib/ai.ts"
      provides: "getEffectiveAIConfig with no parameters; all internal call sites updated"
    - path: "src/lib/ai-bulk.ts"
      provides: "getEffectiveAIConfig call sites updated (no projectPath arg)"
    - path: "src/lib/ai-chat.ts"
      provides: "getEffectiveAIConfig call site updated (no projectPath arg)"
    - path: "src/lib/ai-dependencies.ts"
      provides: "getEffectiveAIConfig call sites updated (no projectPath arg)"
    - path: "src/lib/ai-questioning.ts"
      provides: "getEffectiveAIConfig call sites updated (no projectPath arg)"
    - path: "src/hooks/useAIFeedback.ts"
      provides: "getEffectiveAIConfig call site updated (no projectPath arg)"
    - path: "src/lib/telemetry.ts"
      provides: "MAX_ERROR_MESSAGE_CHARS constant, simplified consent boolean, error policy comment, shutdownTelemetry removed"
  key_links:
    - from: "src/lib/ai-bulk.ts"
      to: "src/lib/ai.ts"
      via: "import { getEffectiveAIConfig }"
      pattern: "getEffectiveAIConfig\\(\\)"
    - from: "src/lib/ai-chat.ts"
      to: "src/lib/ai.ts"
      via: "import { getEffectiveAIConfig }"
      pattern: "getEffectiveAIConfig\\(\\)"
---

<objective>
Remove the unused `_projectPath` parameter from `getEffectiveAIConfig` and update all 16+ call sites (FIX-06, DEAD-010, SMELL-018). Remove `shutdownTelemetry` dead export (DEAD-004). Improve telemetry code quality: extract magic number, simplify consent boolean, document error severity policy (FIX-07, SMELL-011, SMELL-016, SMELL-017).

Purpose: Eliminate the misleading `_projectPath` parameter that suggests per-project AI config is still supported (removed in v2.1). Improve telemetry readability and maintainability.
Output: 7 files modified, zero TypeScript errors, all DEAD-004/010 + SMELL-011/016/017/018 findings closed.
</objective>

<execution_context>
@C:/Users/Boris/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Boris/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@AUDIT-REPORT.md
@src/lib/ai.ts
@src/lib/ai-bulk.ts
@src/lib/ai-chat.ts
@src/lib/ai-dependencies.ts
@src/lib/ai-questioning.ts
@src/hooks/useAIFeedback.ts
@src/lib/telemetry.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Remove _projectPath parameter from getEffectiveAIConfig and update all call sites (DEAD-010, SMELL-018, FIX-06)</name>
  <files>
    src/lib/ai.ts
    src/lib/ai-bulk.ts
    src/lib/ai-chat.ts
    src/lib/ai-dependencies.ts
    src/lib/ai-questioning.ts
    src/hooks/useAIFeedback.ts
  </files>
  <action>
    **Step 1: Update function definition in ai.ts (line 263)**

    Change:
    ```typescript
    export function getEffectiveAIConfig(_projectPath?: string): {
    ```
    To:
    ```typescript
    export function getEffectiveAIConfig(): {
    ```

    Also update the JSDoc above the function — remove the `@param _projectPath` line and the "kept for backward compatibility" note. Update the description to:
    ```typescript
    /**
     * Get effective AI configuration.
     * Uses global settings only (project-level config removed in v2.1).
     */
    ```

    **Step 2: Update all internal call sites in ai.ts**

    There are 7 internal call sites in ai.ts. Each passes `options?.projectPath` — change every one to pass no argument:

    - Line ~848: `getEffectiveAIConfig(options?.projectPath)` → `getEffectiveAIConfig()`
    - Line ~1229: `getEffectiveAIConfig(options?.projectPath)` → `getEffectiveAIConfig()`
    - Line ~1404: `getEffectiveAIConfig(options?.projectPath)` → `getEffectiveAIConfig()`
    - Line ~1704: `getEffectiveAIConfig(options?.projectPath)` → `getEffectiveAIConfig()`
    - Line ~1757: `getEffectiveAIConfig(options?.projectPath)` → `getEffectiveAIConfig()`
    - Line ~2075: `getEffectiveAIConfig(options?.projectPath)` → `getEffectiveAIConfig()`
    - Line ~2204: `getEffectiveAIConfig(options?.projectPath)` → `getEffectiveAIConfig()`

    Use a find-and-replace approach: replace ALL occurrences of `getEffectiveAIConfig(options?.projectPath)` with `getEffectiveAIConfig()` in ai.ts.

    **Step 3: Update external call sites**

    - `ai-bulk.ts` (2 sites): Lines ~473 and ~615 — `getEffectiveAIConfig(options?.projectPath)` → `getEffectiveAIConfig()`
    - `ai-chat.ts` (1 site): Line ~192 — `getEffectiveAIConfig(projectPath)` → `getEffectiveAIConfig()`
    - `ai-dependencies.ts` (2 sites): Lines ~195 and ~246 — `getEffectiveAIConfig(options?.projectPath)` → `getEffectiveAIConfig()`
    - `ai-questioning.ts` (2 sites): Lines ~213 and ~278 — `getEffectiveAIConfig(options?.projectPath)` → `getEffectiveAIConfig()`
    - `useAIFeedback.ts` (1 site): Line ~94 — `getEffectiveAIConfig(projectPath)` → `getEffectiveAIConfig()`

    **Step 4: Clean up projectPath from options types if they ONLY exist to pass to getEffectiveAIConfig**

    Check each file's options type (e.g., `RefineOptions`, `GenerateOptions`, etc.):
    - If `projectPath` in the options type is ONLY used for `getEffectiveAIConfig`, do NOT remove it from the type — it may be used elsewhere (e.g., for context loading, database access). Just stop passing it to `getEffectiveAIConfig`.
    - The refactor is ONLY about the getEffectiveAIConfig call sites. Do not remove projectPath from other usages.
  </action>
  <verify>
    Run `pnpm build` — must pass with zero errors.
    Grep for `getEffectiveAIConfig(` — all matches should show `getEffectiveAIConfig()` with empty parens (except the definition itself which has no params).
    Grep for `_projectPath` — should appear nowhere in the codebase.
  </verify>
  <done>
    `getEffectiveAIConfig` accepts zero parameters. All 16+ call sites across 6 files pass no arguments. No `_projectPath` parameter exists anywhere. Build passes cleanly.
  </done>
</task>

<task type="auto">
  <name>Task 2: Telemetry code quality — extract constant, simplify boolean, document policy, remove shutdownTelemetry (DEAD-004, SMELL-011, SMELL-016, SMELL-017)</name>
  <files>
    src/lib/telemetry.ts
  </files>
  <action>
    **SMELL-016: Extract magic number 200**

    Add a named constant near the top of the file (in the constants section, after the existing constants like `POSTHOG_HOST`):
    ```typescript
    /** Maximum characters captured from error messages (privacy: limit PII exposure per PRIVACY.md) */
    const MAX_ERROR_MESSAGE_CHARS = 200;
    ```

    Then replace all 3 occurrences of the literal `200` in `setupErrorTracking()`:
    - `.slice(0, 200)` → `.slice(0, MAX_ERROR_MESSAGE_CHARS)` (appears 3 times in the error tracking handlers around lines 220, 221, 228)

    **SMELL-017: Simplify consent boolean**

    In `shouldPromptConsent()` (around line 105-108), change:
    ```typescript
    export function shouldPromptConsent(): boolean {
      if (getConsentState() !== null) return false;
      return getDismissCount() <= 1;
    }
    ```
    To:
    ```typescript
    export function shouldPromptConsent(): boolean {
      if (getConsentState() !== null) return false; // already decided
      const hasBeenDismissedTooManyTimes = getDismissCount() > 1;
      return !hasBeenDismissedTooManyTimes;
    }
    ```

    **SMELL-011: Document error severity policy**

    Add a policy comment block at the top of the error handling section (before `setupErrorTracking`), or near the module header. Place it above the `// ERROR TRACKING` section header:
    ```typescript
    /**
     * Error severity policy:
     * - console.error: User-visible failures that degrade functionality (e.g., screenshot failed, file save failed)
     * - console.warn: Best-effort background operations where silent failure is acceptable (e.g., telemetry flush, analytics)
     *
     * Telemetry operations intentionally use console.warn — telemetry is non-critical
     * and must never block or alarm users. See PRIVACY.md for data handling details.
     */
    ```

    **DEAD-004: Remove shutdownTelemetry**

    Delete the entire `shutdownTelemetry` function (lines ~258-279) including its JSDoc. Replace it with a comment:
    ```typescript
    // shutdownTelemetry removed (DEAD-004): Rust-side WAL persistence in telemetry.rs
    // ensures events survive app quit without explicit JS-side shutdown. If needed in
    // the future, wire to window 'beforeunload' or Tauri 'close-requested' event.
    ```

    Also verify no other file imports `shutdownTelemetry` (grep should confirm only the definition exists).
  </action>
  <verify>
    Run `pnpm build` — must pass with zero errors.
    Grep for `shutdownTelemetry` — should appear only in the removal comment, not as an export or function.
    Grep for `\.slice(0, 200)` in telemetry.ts — should return zero matches (all replaced with MAX_ERROR_MESSAGE_CHARS).
    Grep for `MAX_ERROR_MESSAGE_CHARS` — should appear 4 times (1 definition + 3 usages).
  </verify>
  <done>
    Magic number 200 extracted to MAX_ERROR_MESSAGE_CHARS (3 usages). shouldPromptConsent uses named boolean hasBeenDismissedTooManyTimes. Error severity policy documented as code comment. shutdownTelemetry removed with explanatory comment about Rust WAL persistence. Build passes.
  </done>
</task>

</tasks>

<verification>
1. `pnpm build` passes with zero TypeScript errors
2. `getEffectiveAIConfig` signature is `(): { provider: AIProvider; modelId: string }` — no parameters
3. Grep confirms zero occurrences of `_projectPath` in src/
4. `shutdownTelemetry` not exported from telemetry.ts
5. `MAX_ERROR_MESSAGE_CHARS` used in all error message truncation sites
6. `shouldPromptConsent` uses named intermediate boolean
7. Error severity policy comment exists in telemetry.ts
</verification>

<success_criteria>
- FIX-06 complete: `_projectPath` removed from `getEffectiveAIConfig` and all 16+ call sites
- FIX-07 complete: telemetry magic number extracted, consent boolean simplified, error policy documented
- DEAD-004 resolved: `shutdownTelemetry` removed
- DEAD-010 + SMELL-018 resolved: no misleading parameter at call sites
- SMELL-011, SMELL-016, SMELL-017 resolved: telemetry code quality improved
- Zero TypeScript build errors
</success_criteria>

<output>
After completion, create `.planning/phases/34-dead-code-sweep/34-02-SUMMARY.md`
</output>
