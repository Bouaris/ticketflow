---
phase: 26-infrastructure-transport-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - vitest.config.ts
  - src/test-utils/setup.ts
  - src/test-utils/tauri-mocks.ts
autonomous: true
requirements:
  - TINF-01
  - TINF-02

must_haves:
  truths:
    - "`pnpm test` runs with Vitest 4.x and exits 0"
    - "No `__TAURI_INTERNALS__ is not defined` errors from the SQL plugin in test output"
    - "A shared `setupTauriMocks()` function exists and is called in the test setup file"
  artifacts:
    - path: "src/test-utils/tauri-mocks.ts"
      provides: "Shared IPC-level Tauri mocking for all tests"
      exports: ["setupTauriMocks"]
    - path: "src/test-utils/setup.ts"
      provides: "Vitest setup file importing and calling setupTauriMocks()"
      contains: "setupTauriMocks"
    - path: "package.json"
      provides: "Vitest 4.x and @vitest/coverage-v8 4.x versions"
      contains: "vitest"
  key_links:
    - from: "src/test-utils/setup.ts"
      to: "src/test-utils/tauri-mocks.ts"
      via: "import { setupTauriMocks }"
      pattern: "import.*setupTauriMocks.*tauri-mocks"
    - from: "src/test-utils/tauri-mocks.ts"
      to: "@tauri-apps/api/mocks"
      via: "mockIPC and mockWindows calls"
      pattern: "mockIPC|mockWindows"
---

<objective>
Upgrade Vitest from 2.x to 4.x and create a shared `setupTauriMocks()` that intercepts `plugin:sql|*` IPC commands, eliminating `__TAURI_INTERNALS__ is not defined` errors in all tests.

Purpose: Modernize the test runner to be compatible with Vite 7 and fix the root cause of SQL plugin test failures by mocking at the IPC transport layer (not the JS module layer).
Output: Vitest 4.x running all existing tests, new `src/test-utils/tauri-mocks.ts` with `setupTauriMocks()` integrated into `setup.ts`.
</objective>

<execution_context>
@C:/Users/Boris/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Boris/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/26-infrastructure-transport-foundation/26-RESEARCH.md

@vitest.config.ts
@src/test-utils/setup.ts
@src/test-utils/tauri-mock.ts
@src/test-utils/mocks/tauri.ts
@package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Upgrade Vitest to 4.x and verify config compatibility</name>
  <files>package.json, vitest.config.ts</files>
  <action>
1. Run `pnpm add -D vitest@^4.0.18 @vitest/coverage-v8@^4.0.18` to upgrade both packages.

2. Review `vitest.config.ts` for any Vitest 4 breaking changes:
   - `coverage.all` is removed in v4 — this project does NOT use it (uses `coverage.include` instead), so no change needed.
   - `basic` reporter is removed — not used here, no change needed.
   - `workspace` renamed to `projects` — not used here, no change needed.
   - `poolMatchGlobs` removed — not used here, no change needed.

3. The current config should work as-is with Vitest 4. Do NOT change the config unless the upgrade reveals a specific incompatibility.

4. Do NOT upgrade jsdom beyond ^25.0.1 — jsdom 27+ has Blob constructor incompatibility with Vitest 4.

5. Run `pnpm test` to verify existing tests still pass (some may fail due to `__TAURI_INTERNALS__` — that is expected and fixed in Task 2).

**Key constraint:** The `vi.clearAllMocks()` call in `setup.ts` afterEach is the correct pattern for Vitest 4 (NOT `vi.restoreAllMocks()` which changed behavior in v4 for `vi.fn()` mocks).
  </action>
  <verify>
- `pnpm list vitest @vitest/coverage-v8` shows 4.x versions
- `pnpm test` runs without Vitest framework errors (individual test failures from `__TAURI_INTERNALS__` are acceptable at this stage)
  </verify>
  <done>Vitest 4.x and @vitest/coverage-v8 4.x installed; vitest.config.ts compatible; `pnpm test` executes without framework-level errors.</done>
</task>

<task type="auto">
  <name>Task 2: Create shared setupTauriMocks() with plugin:sql IPC handlers</name>
  <files>src/test-utils/tauri-mocks.ts, src/test-utils/setup.ts</files>
  <action>
1. **Rename** the existing `src/test-utils/tauri-mock.ts` (singular) to avoid naming confusion — it mocks `tauri-bridge.ts` functions, NOT the IPC layer. This file stays as-is; the new file has a different concern.

2. **Create** `src/test-utils/tauri-mocks.ts` (note: different file from existing `tauri-mock.ts`) with the following:

```typescript
/**
 * Tauri IPC-Level Mocks
 *
 * Uses @tauri-apps/api/mocks to intercept Tauri IPC commands at the transport layer.
 * This prevents __TAURI_INTERNALS__ errors from @tauri-apps/plugin-sql and other plugins.
 *
 * Called in setup.ts (Vitest setupFiles) to run BEFORE any test module imports.
 */

import { mockIPC, mockWindows, clearMocks } from '@tauri-apps/api/mocks';
import { beforeAll, afterEach } from 'vitest';

export interface TauriMockOptions {
  /** Custom handler for plugin:sql|select — return rows array per query */
  selectHandler?: (query: string, bindValues: unknown[]) => unknown[];
  /** Custom result for plugin:sql|execute */
  executeResult?: { lastInsertId: number; rowsAffected: number };
}

/**
 * Set up IPC-level mocks for Tauri commands.
 * Must be called at module level in setup.ts (not inside describe blocks)
 * so mocks are in place BEFORE any test module side effects run.
 */
export function setupTauriMocks(options: TauriMockOptions = {}): void {
  beforeAll(() => {
    // Step 1: Create fake window context — establishes __TAURI_INTERNALS__
    mockWindows('main');

    // Step 2: Intercept all IPC commands at the transport layer
    mockIPC((cmd: string, payload: Record<string, unknown>) => {
      // plugin:sql|load — return a fake database handle
      if (cmd === 'plugin:sql|load') {
        return 'sqlite:mock';
      }
      // plugin:sql|execute — INSERT/UPDATE/DELETE success
      if (cmd === 'plugin:sql|execute') {
        return options.executeResult ?? { lastInsertId: 1, rowsAffected: 1 };
      }
      // plugin:sql|select — empty rows by default, or custom handler
      if (cmd === 'plugin:sql|select') {
        if (options.selectHandler) {
          const query = (payload as Record<string, unknown>).query as string;
          const bindValues = ((payload as Record<string, unknown>).values ?? []) as unknown[];
          return options.selectHandler(query, bindValues);
        }
        return [];
      }
      // plugin:sql|close — no-op
      if (cmd === 'plugin:sql|close') {
        return null;
      }
      // ph_send_batch — stub for telemetry relay (Phase 26)
      if (cmd === 'ph_send_batch') {
        const events = (payload as Record<string, unknown>).events as unknown[] | undefined;
        return { queued: 0, sent: events?.length ?? 0 };
      }
      // Default: return null for unknown commands
      return null;
    });
  });

  afterEach(() => {
    clearMocks();
  });
}
```

3. **Update** `src/test-utils/setup.ts` to import and call `setupTauriMocks()`:
   - Add `import { setupTauriMocks } from './tauri-mocks';` after the existing imports
   - Call `setupTauriMocks();` BEFORE the localStorage mock (it must run first to establish `__TAURI_INTERNALS__` before any plugin imports)
   - The existing `afterEach` with `vi.clearAllMocks()` stays — `clearMocks()` from tauri-mocks handles Tauri-specific cleanup separately

4. Run `pnpm test` — all tests should now pass without `__TAURI_INTERNALS__ is not defined` errors.

**Important:** Do NOT remove or modify `src/test-utils/tauri-mock.ts` or `src/test-utils/mocks/tauri.ts` — those mock the `tauri-bridge.ts` module (higher-level file/dialog operations) and are still needed by tests that use `vi.mock('../lib/tauri-bridge', ...)`. The new `tauri-mocks.ts` operates at a lower level (IPC transport layer).
  </action>
  <verify>
- `src/test-utils/tauri-mocks.ts` exists and exports `setupTauriMocks`
- `src/test-utils/setup.ts` imports and calls `setupTauriMocks()`
- `pnpm test` passes with zero `__TAURI_INTERNALS__` errors
- `pnpm build` still passes (no production code changed)
  </verify>
  <done>Shared `setupTauriMocks()` created with `plugin:sql|*` IPC handlers; integrated in setup.ts; all existing tests pass without `__TAURI_INTERNALS__` errors; `pnpm test` exits 0.</done>
</task>

</tasks>

<verification>
1. `pnpm list vitest` shows version 4.x
2. `pnpm list @vitest/coverage-v8` shows version 4.x
3. `pnpm test` exits 0 with no `__TAURI_INTERNALS__` errors in output
4. `pnpm build` passes (production code unchanged)
5. `src/test-utils/tauri-mocks.ts` exists and exports `setupTauriMocks`
6. `src/test-utils/setup.ts` imports from `./tauri-mocks`
</verification>

<success_criteria>
- Vitest upgraded from 2.x to 4.x with matching @vitest/coverage-v8
- All existing tests pass on Vitest 4.x
- `setupTauriMocks()` properly intercepts `plugin:sql|*` IPC commands via `mockIPC`
- No `__TAURI_INTERNALS__ is not defined` errors in any test run
- `pnpm build` still succeeds
</success_criteria>

<output>
After completion, create `.planning/phases/26-infrastructure-transport-foundation/26-01-SUMMARY.md`
</output>
