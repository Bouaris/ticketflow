---
phase: 22-provider-registry-core-refactor
plan: 03
type: execute
wave: 3
depends_on: ["22-02"]
files_modified:
  - src/types/projectAIConfig.ts
  - src/hooks/useProjectAIConfig.ts
  - src/components/ui/ProviderToggle.tsx
  - src/types/index.ts
  - src/lib/index.ts
autonomous: true

must_haves:
  truths:
    - "projectAIConfig.ts is marked deprecated but still exports types for backward compatibility"
    - "useProjectAIConfig hook returns global config without project-level override logic"
    - "ProviderToggle still renders Groq/Gemini/OpenAI buttons for built-in providers"
    - "All existing consumers compile without changes (backward compatible exports)"
    - "No dead imports or unused variables remain across modified files"
  artifacts:
    - path: "src/types/projectAIConfig.ts"
      provides: "Deprecated types redirecting to registry"
      exports: ["AVAILABLE_MODELS", "DEFAULT_MODELS", "ProjectAIConfig"]
    - path: "src/hooks/useProjectAIConfig.ts"
      provides: "Simplified hook using global config only"
      exports: ["useProjectAIConfig"]
    - path: "src/components/ui/ProviderToggle.tsx"
      provides: "Provider toggle using registry for built-in providers"
      exports: ["ProviderToggle", "getProviderLabel"]
  key_links:
    - from: "src/hooks/useProjectAIConfig.ts"
      to: "src/lib/ai.ts"
      via: "import getProvider, getEffectiveAIConfig"
      pattern: "import.*from.*ai"
    - from: "src/components/ui/ProviderToggle.tsx"
      to: "src/lib/ai-provider-registry.ts"
      via: "import BUILT_IN_PROVIDERS for rendering"
      pattern: "import.*from.*ai-provider-registry"
---

<objective>
Migrate consumers of the old provider system to use the registry: deprecate projectAIConfig, simplify useProjectAIConfig hook to global-only, update ProviderToggle to be registry-aware.

Purpose: Complete the migration by ensuring all downstream consumers are compatible with the new registry. Keep backward-compatible exports so Phase 23 (UI split) can cleanly remove deprecated code.

Output: Updated `src/types/projectAIConfig.ts`, `src/hooks/useProjectAIConfig.ts`, `src/components/ui/ProviderToggle.tsx`, barrel files
</objective>

<execution_context>
@C:/Users/Boris/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Boris/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/22-provider-registry-core-refactor/22-RESEARCH.md
@.planning/phases/22-provider-registry-core-refactor/22-01-SUMMARY.md
@.planning/phases/22-provider-registry-core-refactor/22-02-SUMMARY.md
@src/types/projectAIConfig.ts
@src/hooks/useProjectAIConfig.ts
@src/components/ui/ProviderToggle.tsx
@src/types/index.ts
@src/lib/index.ts
@src/lib/ai-provider-registry.ts
@src/types/aiProvider.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Deprecate projectAIConfig.ts and redirect to registry types</name>
  <files>src/types/projectAIConfig.ts</files>
  <action>
Refactor `src/types/projectAIConfig.ts` to be a thin backward-compatibility shim over the registry:

1. **Add deprecation header comment**:
   ```typescript
   /**
    * @deprecated This module is deprecated since v2.1. Use ai-provider-registry instead.
    * Kept for backward compatibility — will be removed in v2.2.
    */
   ```

2. **Keep all existing exports** so consumers don't break:
   - `AIModelSchema`, `ProjectAIConfigSchema`, `AIModel`, `ProjectAIConfig`, `ProjectAIProvider`
   - `DEFAULT_PROJECT_AI_CONFIG`
   - `AVAILABLE_MODELS`, `DEFAULT_MODELS`

3. **Import BUILT_IN_PROVIDERS from registry** and derive `AVAILABLE_MODELS` and `DEFAULT_MODELS` from it:
   ```typescript
   import { BUILT_IN_PROVIDERS } from '../lib/ai-provider-registry';
   import type { BuiltInProviderId } from './aiProvider';

   /** @deprecated Use BUILT_IN_PROVIDERS from ai-provider-registry instead */
   export const AVAILABLE_MODELS: Record<BuiltInProviderId, AIModel[]> = {
     groq: BUILT_IN_PROVIDERS.find(p => p.id === 'groq')!.models.map(m => ({ ...m, provider: 'groq' as const })),
     gemini: BUILT_IN_PROVIDERS.find(p => p.id === 'gemini')!.models.map(m => ({ ...m, provider: 'gemini' as const })),
     openai: BUILT_IN_PROVIDERS.find(p => p.id === 'openai')!.models.map(m => ({ ...m, provider: 'openai' as const })),
   };

   /** @deprecated Use getProviderById(id).defaultModel from ai-provider-registry instead */
   export const DEFAULT_MODELS: Record<BuiltInProviderId, string> = {
     groq: BUILT_IN_PROVIDERS.find(p => p.id === 'groq')!.defaultModel,
     gemini: BUILT_IN_PROVIDERS.find(p => p.id === 'gemini')!.defaultModel,
     openai: BUILT_IN_PROVIDERS.find(p => p.id === 'openai')!.defaultModel,
   };
   ```

   This ensures the registry is the single source of truth — if models are updated in the registry, these deprecated exports automatically reflect the change.

4. **Keep Zod schemas intact** — `AIModelSchema`, `ProjectAIConfigSchema`, `DEFAULT_PROJECT_AI_CONFIG` stay as-is. They are still used by consumers that haven't migrated yet.
  </action>
  <verify>
`pnpm build` passes. All existing imports of `AVAILABLE_MODELS` and `DEFAULT_MODELS` from this file still resolve correctly.
  </verify>
  <done>
projectAIConfig.ts marked deprecated with AVAILABLE_MODELS and DEFAULT_MODELS derived from registry. All existing exports preserved for backward compatibility.
  </done>
</task>

<task type="auto">
  <name>Task 2: Simplify useProjectAIConfig hook and update ProviderToggle</name>
  <files>src/hooks/useProjectAIConfig.ts, src/components/ui/ProviderToggle.tsx, src/types/index.ts, src/lib/index.ts</files>
  <action>
**A. Simplify `src/hooks/useProjectAIConfig.ts`:**

The hook currently supports project-level AI config override. Simplify it to always use global config:

1. Remove imports of `loadProjectAIConfig`, `saveProjectAIConfig` from `ai.ts`.
2. Remove import of `ProjectAIConfigSchema`, `DEFAULT_PROJECT_AI_CONFIG`, `DEFAULT_MODELS` from `projectAIConfig.ts`.
3. Import from registry instead:
   ```typescript
   import { getProviderById } from '../lib/ai-provider-registry';
   ```

4. Simplify the hook body:
   ```typescript
   export function useProjectAIConfig(_projectPath: string | null): UseProjectAIConfigReturn {
     // v2.1: Project-level AI config removed — always use global settings
     const globalProvider = getProvider();
     const providerConfig = getProviderById(globalProvider);

     const effectiveModelId = providerConfig?.defaultModel ?? globalProvider;

     // Keep setProvider and setModelId as no-ops with deprecation warnings
     const setProviderFn = useCallback((_provider: ProjectAIProvider) => {
       console.warn('[useProjectAIConfig] Project-level AI config removed in v2.1. Use global settings.');
     }, []);

     const setModelId = useCallback((_modelId: string) => {
       console.warn('[useProjectAIConfig] Project-level AI config removed in v2.1. Use global settings.');
     }, []);

     return {
       config: { provider: 'global', version: 1 },
       setProvider: setProviderFn,
       setModelId,
       isGlobal: true,
       effectiveProvider: globalProvider,
       effectiveModelId,
     };
   }
   ```

   Keep the `UseProjectAIConfigReturn` interface unchanged for backward compatibility. Keep the `_projectPath` parameter with underscore prefix.

**B. Update `src/components/ui/ProviderToggle.tsx`:**

1. Add import from registry:
   ```typescript
   import { BUILT_IN_PROVIDERS } from '../../lib/ai-provider-registry';
   ```

2. Update `getProviderLabel` to use registry:
   ```typescript
   export function getProviderLabel(provider: string): string {
     const config = BUILT_IN_PROVIDERS.find(p => p.id === provider);
     if (config) return config.name;
     return provider.charAt(0).toUpperCase() + provider.slice(1);
   }
   ```

3. The ProviderToggle component itself stays mostly unchanged — it renders Groq/Gemini/OpenAI buttons for built-in providers. Phase 23 will add custom provider display. For now, keep the component functional but update the `getProviderLabel` function.

4. Update the `ProviderToggleProps` to accept `string` for value (not just `AIProvider`), with backward-compatible type:
   ```typescript
   interface ProviderToggleProps {
     value: AIProvider | string;
     onChange: (provider: AIProvider) => void;
     size?: 'sm' | 'md';
     showLabel?: boolean;
   }
   ```

**C. Update barrel exports (`src/types/index.ts`, `src/lib/index.ts`):**

1. In `src/types/index.ts`, add export for the new types:
   ```typescript
   export type { ProviderConfig, BuiltInProviderId, CustomProviderInput } from './aiProvider';
   ```

2. In `src/lib/index.ts`, add export for the registry:
   ```typescript
   export {
     BUILT_IN_PROVIDERS,
     getAllProviders,
     getProviderById,
     addCustomProvider,
     removeCustomProvider,
     validateCustomProvider,
     isBuiltInProvider,
   } from './ai-provider-registry';
   ```

**D. Final cleanup:**

Check all modified files for:
- Unused imports (remove them)
- `any` types (replace with `unknown` or specific types)
- Console.log statements that should be console.warn (deprecation warnings are acceptable)
  </action>
  <verify>
`pnpm build` passes without errors or warnings about unused variables. Verify:
- `useProjectAIConfig(null)` returns global config with `isGlobal: true`
- `getProviderLabel('groq')` returns 'Groq'
- `getProviderLabel('custom-ollama')` returns 'Custom-ollama'
- Barrel exports include new registry types and functions
  </verify>
  <done>
useProjectAIConfig simplified to global-only, ProviderToggle uses registry for labels, barrel exports updated with new registry types and functions. All backward-compatible exports preserved.
  </done>
</task>

</tasks>

<verification>
1. `pnpm build` passes without errors
2. No unused imports or dead code in modified files
3. All existing consumers of projectAIConfig.ts still compile (backward compat)
4. useProjectAIConfig returns global provider settings regardless of projectPath
5. ProviderToggle renders correctly for built-in providers
6. Barrel exports include new registry types and functions
7. AVAILABLE_MODELS and DEFAULT_MODELS in projectAIConfig.ts derive from registry (single source of truth)
</verification>

<success_criteria>
- All modified files compile cleanly
- projectAIConfig.ts exports backward-compatible AVAILABLE_MODELS and DEFAULT_MODELS derived from registry
- useProjectAIConfig ignores projectPath and returns global config
- ProviderToggle still renders 3 built-in provider buttons
- New types and registry functions available via barrel exports
- No `any` types, no dead imports, no console.log (only console.warn for deprecation)
</success_criteria>

<output>
After completion, create `.planning/phases/22-provider-registry-core-refactor/22-03-SUMMARY.md`
</output>
