---
phase: 23-settings-ui-split-provider-config
plan: 02
type: execute
wave: 2
depends_on: ["23-01"]
files_modified:
  - src/App.tsx
  - src/components/layout/Header.tsx
  - src/components/workspace/ProjectWorkspace.tsx
  - src/components/settings/ProjectSettingsModal.tsx
  - src/components/settings/SettingsModal.tsx
  - src/lib/command-registry.ts
  - src/i18n/types.ts
  - src/i18n/locales/fr.ts
  - src/i18n/locales/en.ts
  - src/hooks/useProjectAIConfig.ts
  - src/types/projectAIConfig.ts
  - src/hooks/index.ts
  - src/types/index.ts
  - src/lib/ai.ts
autonomous: true
must_haves:
  truths:
    - "User can open App Settings from command palette or Cmd+, shortcut and sees language, theme, updates"
    - "User can open AI Settings from header button (sparkle icon) and sees provider configuration"
    - "Header shows amber badge dot on AI Settings button when no provider is configured"
    - "Project-level AI provider selector is completely removed from ProjectSettingsModal"
    - "Old SettingsModal is no longer rendered — fully replaced by AppSettingsModal + AISettingsModal"
    - "All new UI strings are translated in both FR and EN locales"
  artifacts:
    - path: "src/App.tsx"
      provides: "Wiring for AppSettingsModal + AISettingsModal state, replacing SettingsModal"
      contains: "AppSettingsModal|AISettingsModal"
    - path: "src/components/layout/Header.tsx"
      provides: "AI Settings button with amber badge indicator"
      contains: "onOpenAISettings|SparklesIcon"
    - path: "src/components/settings/ProjectSettingsModal.tsx"
      provides: "Project settings without AI provider selector"
    - path: "src/i18n/types.ts"
      provides: "New i18n keys for settings split"
      contains: "appSettings|aiSettings|customProviders"
  key_links:
    - from: "src/App.tsx"
      to: "src/components/settings/AppSettingsModal.tsx"
      via: "isAppSettingsOpen state + import"
      pattern: "AppSettingsModal.*isOpen"
    - from: "src/App.tsx"
      to: "src/components/settings/AISettingsModal.tsx"
      via: "isAISettingsOpen state + import"
      pattern: "AISettingsModal.*isOpen"
    - from: "src/components/layout/Header.tsx"
      to: "src/App.tsx"
      via: "onOpenAISettings callback prop"
      pattern: "onOpenAISettings"
    - from: "src/components/workspace/ProjectWorkspace.tsx"
      to: "src/App.tsx"
      via: "onOpenSettings and onOpenAISettings callbacks"
      pattern: "onOpenAISettings"
---

<objective>
Wire the new AppSettingsModal and AISettingsModal into the application, add AI Settings button to Header, update i18n, remove project-level AI selector, and delete the old SettingsModal.

Purpose: Complete the settings split by connecting all components, adding navigation entry points, and cleaning up deprecated code.

Output: Fully functional settings split with App Settings (Cmd+,) and AI Settings (header button) accessible separately.
</objective>

<execution_context>
@C:/Users/Boris/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Boris/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Plan 01 summary (new component files)
@.planning/phases/23-settings-ui-split-provider-config/23-01-SUMMARY.md

# Files to modify
@src/App.tsx
@src/components/layout/Header.tsx
@src/components/workspace/ProjectWorkspace.tsx
@src/components/settings/ProjectSettingsModal.tsx
@src/lib/command-registry.ts
@src/i18n/types.ts
@src/i18n/locales/fr.ts
@src/i18n/locales/en.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wire modals in App.tsx, update Header with AI Settings button</name>
  <files>
    src/App.tsx
    src/components/layout/Header.tsx
    src/components/workspace/ProjectWorkspace.tsx
    src/lib/command-registry.ts
  </files>
  <action>
**App.tsx changes:**

1. Replace `SettingsModal` import with `AppSettingsModal` and `AISettingsModal`:
   ```typescript
   import { AppSettingsModal } from './components/settings/AppSettingsModal';
   import { AISettingsModal } from './components/settings/AISettingsModal';
   ```
   Remove the old `import { SettingsModal }` line.

2. Replace `isSettingsOpen` state with two separate states:
   ```typescript
   const [isAppSettingsOpen, setIsAppSettingsOpen] = useState(false);
   const [isAISettingsOpen, setIsAISettingsOpen] = useState(false);
   ```

3. Update `onOpenSettings` prop to `onOpenAppSettings`:
   - Change `onOpenSettings={() => setIsSettingsOpen(true)}` to `onOpenSettings={() => setIsAppSettingsOpen(true)}`
   - Add `onOpenAISettings={() => setIsAISettingsOpen(true)}` prop to ProjectWorkspace

4. Replace the `<SettingsModal ... />` block with:
   ```tsx
   <AppSettingsModal
     isOpen={isAppSettingsOpen}
     onClose={() => setIsAppSettingsOpen(false)}
     updater={updater}
     projectPath={typeConfig.projectPath || undefined}
   />
   <AISettingsModal
     isOpen={isAISettingsOpen}
     onClose={() => setIsAISettingsOpen(false)}
     projectPath={typeConfig.projectPath || undefined}
   />
   ```

5. Add import for `hasApiKey` from `./lib/ai` to compute badge state:
   ```typescript
   import { initSecureStorage, hasApiKey } from './lib/ai';
   ```

6. In the floating settings button (top-right corner, shown when no project selected), keep `onClick={() => setIsAppSettingsOpen(true)}`.

**Header.tsx changes:**

1. Add new props to HeaderProps:
   ```typescript
   onOpenAISettings: () => void;
   showAISettingsBadge?: boolean;
   ```

2. Add SparklesIcon import (already imported in ProjectWorkspace, need to add to Header's icon imports).

3. Add AI Settings button BEFORE the project settings button in the Right Actions area:
   ```tsx
   <button
     onClick={onOpenAISettings}
     className="relative px-2.5 py-2 xl:px-4 text-sm font-medium text-on-surface-secondary bg-surface border border-outline-strong rounded-lg hover:bg-surface-alt transition-colors"
     aria-label={t.settings.aiSettings}
   >
     <span className="flex items-center gap-2">
       <SparklesIcon className="w-4 h-4" />
       <span className="hidden xl:inline">{t.settings.aiSettings}</span>
     </span>
     {showAISettingsBadge && (
       <span className="absolute -top-1 -right-1 w-2.5 h-2.5 bg-amber-500 rounded-full" />
     )}
   </button>
   ```
   This button should be ALWAYS visible (not gated by hasProject), placed before the existing project settings button.

4. Add the new props to the destructured props and the component signature.

**ProjectWorkspace.tsx changes:**

1. Add `onOpenAISettings: () => void;` to `ProjectWorkspaceProps` interface.
2. Destructure `onOpenAISettings` from props.
3. Pass `onOpenAISettings` to `Header` component:
   ```tsx
   <Header
     ...existing props
     onOpenAISettings={onOpenAISettings}
     showAISettingsBadge={!hasApiKey(getProvider())}
   />
   ```
   Import `hasApiKey, getProvider` from `../../lib/ai`.
4. In the workspaceActions object (where `openSettings: onOpenSettings`), keep `openSettings: onOpenSettings` — the command palette "Settings" command still opens App Settings.

**command-registry.ts changes:**
No changes needed — `openSettings` already maps to App Settings (which is the correct default). The command palette "Settings" command will continue to open App Settings via `actions.openSettings`.
  </action>
  <verify>
Run `pnpm build` — must pass.

Manually verify:
- Header should show the AI Settings sparkle button
- Clicking it should open AISettingsModal
- Cmd+, (via command palette) should open AppSettingsModal
- The amber badge should appear when no API key is configured for the current provider
  </verify>
  <done>
App.tsx renders AppSettingsModal and AISettingsModal instead of SettingsModal. Header has AI Settings button with amber badge. ProjectWorkspace passes onOpenAISettings callback. Command palette "Settings" opens App Settings.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add i18n keys, remove project-level AI selector, delete deprecated files</name>
  <files>
    src/i18n/types.ts
    src/i18n/locales/fr.ts
    src/i18n/locales/en.ts
    src/components/settings/ProjectSettingsModal.tsx
    src/hooks/useProjectAIConfig.ts
    src/types/projectAIConfig.ts
    src/hooks/index.ts
    src/types/index.ts
    src/lib/ai.ts
  </files>
  <action>
**i18n/types.ts** — Add new keys to the `settings` section:
```typescript
// Add after existing settings keys:
appSettings: string;
aiSettings: string;
providers: string;
customProviders: string;
addProvider: string;
editProvider: string;
deleteProvider: string;
deleteProviderConfirm: string;
providerName: string;
endpointURL: string;
endpointHint: string;
defaultModel: string;
apiKeyOptional: string;
apiKeyHintLocal: string;
providerConfigured: string;
providerNotConfigured: string;
noCustomProviders: string;
providerAdded: string;
providerDeleted: string;
saveProvider: string;
```

**i18n/locales/fr.ts** — Add French translations for all new keys:
```typescript
appSettings: 'Parametres generaux',
aiSettings: 'Parametres IA',
providers: 'Fournisseurs',
customProviders: 'Fournisseurs personnalises',
addProvider: 'Ajouter un fournisseur',
editProvider: 'Modifier',
deleteProvider: 'Supprimer',
deleteProviderConfirm: 'Supprimer ce fournisseur personnalise ?',
providerName: 'Nom du fournisseur',
endpointURL: 'URL de l\'endpoint',
endpointHint: 'Doit etre HTTPS ou localhost',
defaultModel: 'Modele par defaut',
apiKeyOptional: 'Cle API (optionnelle)',
apiKeyHintLocal: 'Laisser vide pour les fournisseurs localhost',
providerConfigured: 'Configure',
providerNotConfigured: 'Non configure',
noCustomProviders: 'Aucun fournisseur personnalise. Ajoutez Ollama, LM Studio ou d\'autres endpoints compatibles OpenAI.',
providerAdded: 'Fournisseur ajoute',
providerDeleted: 'Fournisseur supprime',
saveProvider: 'Enregistrer',
```

**i18n/locales/en.ts** — Add English translations for all new keys:
```typescript
appSettings: 'General Settings',
aiSettings: 'AI Settings',
providers: 'Providers',
customProviders: 'Custom Providers',
addProvider: 'Add Provider',
editProvider: 'Edit',
deleteProvider: 'Delete',
deleteProviderConfirm: 'Delete this custom provider?',
providerName: 'Provider Name',
endpointURL: 'Endpoint URL',
endpointHint: 'Must be HTTPS or localhost',
defaultModel: 'Default Model',
apiKeyOptional: 'API Key (optional)',
apiKeyHintLocal: 'Leave empty for localhost providers',
providerConfigured: 'Configured',
providerNotConfigured: 'Not configured',
noCustomProviders: 'No custom providers. Add Ollama, LM Studio, or other OpenAI-compatible endpoints.',
providerAdded: 'Provider added',
providerDeleted: 'Provider deleted',
saveProvider: 'Save',
```

**ProjectSettingsModal.tsx** — Remove AI provider selector section:
1. Remove the import of `useProjectAIConfig` from `../../hooks/useProjectAIConfig`
2. Remove the import of `AVAILABLE_MODELS, DEFAULT_MODELS, type ProjectAIProvider` from `../../types/projectAIConfig`
3. Remove the import of `hasApiKey, getProvider, type AIProvider` from `../../lib/ai`
4. Remove the `PROVIDERS` constant array (line 35-40)
5. Remove the `useProjectAIConfig(projectPath)` hook call and all destructured values
6. Remove the `getProvider()` call
7. Remove the `availableProviders` useMemo
8. Remove the `availableModels` computation
9. Remove the `handleProviderChange` function
10. Remove the `renderProviderIcon` function
11. Remove the entire "AI Provider Selection" section (the grid with provider buttons)
12. Remove the "Model Selection" section (the select dropdown)
13. Remove the "Effective Configuration Summary" section (the summary box)
14. Keep: Project name display, Context Files section, GSD Integration section, Link to Type Config
15. Remove now-unused imports: `useMemo`, `GroqIcon`, `GeminiIcon`, `OpenAIIcon`, `ChevronDownIcon`

**Delete old SettingsModal:**
- **Delete** `src/components/settings/SettingsModal.tsx` — fully replaced by AppSettingsModal + AISettingsModal. All functionality extracted in Plan 01.

**Delete deprecated files and clean barrel exports:**

1. **Delete** `src/hooks/useProjectAIConfig.ts` — no longer needed (ProjectSettingsModal was the only consumer)
2. **Delete** `src/types/projectAIConfig.ts` — deprecated shim, no longer needed
3. **Update** `src/hooks/index.ts` — Remove the export lines for `useProjectAIConfig` and `UseProjectAIConfigReturn`
4. **Update** `src/types/index.ts` — Remove the export lines for `AIModel`, `ProjectAIConfig`, `ProjectAIProvider`, `AVAILABLE_MODELS`, `DEFAULT_MODELS`, `DEFAULT_PROJECT_AI_CONFIG`, `AIModelSchema`, `ProjectAIConfigSchema`
5. **Update** `src/lib/ai.ts`:
   - Remove `import type { ProjectAIConfig } from '../types/projectAIConfig'`
   - Remove `import { DEFAULT_PROJECT_AI_CONFIG } from '../types/projectAIConfig'`
   - Remove the `loadProjectAIConfig` function (deprecated stub)
   - Remove the `saveProjectAIConfig` function (deprecated stub)
   - Update `getEffectiveAIConfig` to remove the `_projectPath` parameter if it takes one, or leave it if other callers still use it (check callers first). The function should simply return global config.

**IMPORTANT before deleting:**
- Search for ALL imports of `useProjectAIConfig`, `projectAIConfig`, `AVAILABLE_MODELS`, `DEFAULT_MODELS`, `DEFAULT_PROJECT_AI_CONFIG`, `loadProjectAIConfig`, `saveProjectAIConfig` across the codebase.
- If any file besides ProjectSettingsModal.tsx still imports them, update those imports to use registry equivalents instead.
- The only known consumers are: ProjectSettingsModal (updated above), useProjectAIConfig (deleted), ai.ts (cleaned up), barrel exports (cleaned up).

**Also update the Plan 01 components:**
After adding i18n keys, go back through the five Plan 01 components and replace any `// TODO: i18n` hardcoded strings with proper `t.settings.*` calls using the newly added translation keys.
  </action>
  <verify>
Run `pnpm build` — must pass with zero errors.

Verify:
- No imports of `useProjectAIConfig`, `projectAIConfig.ts`, `AVAILABLE_MODELS`, `DEFAULT_MODELS` remain in codebase
- ProjectSettingsModal no longer shows AI provider selector
- All new UI strings use i18n (no hardcoded strings remain)
- `src/hooks/useProjectAIConfig.ts` and `src/types/projectAIConfig.ts` are deleted
  </verify>
  <done>
i18n keys added for all new settings UI strings in both FR and EN. ProjectSettingsModal stripped of AI provider selector (only shows project name, context files, GSD, type config link). Deprecated files deleted (useProjectAIConfig.ts, projectAIConfig.ts). Barrel exports cleaned. ai.ts deprecated stubs removed. All Plan 01 components updated to use i18n keys. pnpm build passes.
  </done>
</task>

</tasks>

<verification>
1. `pnpm build` passes without errors
2. App Settings opens via command palette "Settings" or Cmd+, — shows language, theme, updates, changelog, export, backups
3. AI Settings opens via header sparkle button — shows provider cards with status badges, custom provider CRUD
4. Amber badge on AI Settings button when no provider configured
5. ProjectSettingsModal shows only project name, context files, GSD, type config link (no AI selector)
6. No deprecated files remain (useProjectAIConfig.ts, projectAIConfig.ts)
7. No imports of deprecated modules in any file
8. All user-facing strings use i18n with FR and EN translations
</verification>

<success_criteria>
- Both modals fully wired and accessible from their respective entry points
- Header has AI Settings button with amber badge indicator
- Project-level AI selector completely removed (SETT-03)
- All deprecated Phase 22 stubs fully removed
- i18n complete for all new strings
- `pnpm build` passes
</success_criteria>

<output>
After completion, create `.planning/phases/23-settings-ui-split-provider-config/23-02-SUMMARY.md`
</output>
