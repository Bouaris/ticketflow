---
phase: 35-architecture-performance
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/ai-client.ts
  - src/lib/ai-config.ts
  - src/lib/ai-maintenance.ts
  - src/lib/ai-analysis.ts
  - src/lib/ai-prompts.ts
  - src/lib/ai.ts
  - src/lib/index.ts
autonomous: true
requirements: [FIX-09]
must_haves:
  truths:
    - "No single ai-*.ts file in src/lib/ exceeds 800 lines"
    - "All existing imports from '../lib/ai' and './ai' continue to resolve without error"
    - "pnpm build passes with zero TypeScript errors"
    - "Existing test suite remains green"
  artifacts:
    - path: "src/lib/ai-client.ts"
      provides: "SDK singletons, API key CRUD, secure storage init, resetClient"
      min_lines: 100
    - path: "src/lib/ai-config.ts"
      provides: "getProvider, setProvider, getEffectiveAIConfig, resolveModelForProvider, getProviderDisplayName, getSelectedModel, setSelectedModel"
      min_lines: 80
    - path: "src/lib/ai-maintenance.ts"
      provides: "analyzeBacklogFormat, correctBacklogFormat, BacklogMaintenanceResult, suggestImprovements"
      min_lines: 200
    - path: "src/lib/ai-analysis.ts"
      provides: "analyzeBacklog, AnalyzeBacklogResult, AnalyzeBacklogOptions, ANALYZE_BACKLOG_PROMPT_FR, ANALYZE_BACKLOG_PROMPT_EN"
      min_lines: 300
    - path: "src/lib/ai-prompts.ts"
      provides: "GENERATE_ITEM_PROMPT_FR, GENERATE_ITEM_PROMPT_EN, getGenerateItemPrompt, REFINE_ITEM_PROMPT_FR, REFINE_ITEM_PROMPT_EN, getRefineItemPrompt"
      min_lines: 250
    - path: "src/lib/ai.ts"
      provides: "Thin composition layer re-exporting from sub-modules + keeping completion/generation/refinement core logic"
      max_lines: 800
  key_links:
    - from: "src/lib/ai.ts"
      to: "src/lib/ai-client.ts"
      via: "import { getGroqClient, getGeminiClient, getOpenAIClient, getClientConfig } from './ai-client'"
      pattern: "from './ai-client'"
    - from: "src/lib/ai.ts"
      to: "src/lib/ai-config.ts"
      via: "import { getProvider, getEffectiveAIConfig, resolveModelForProvider } from './ai-config'"
      pattern: "from './ai-config'"
    - from: "src/lib/ai.ts"
      to: "src/lib/ai-analysis.ts"
      via: "import { analyzeBacklog } from './ai-analysis'"
      pattern: "from './ai-analysis'"
    - from: "src/lib/ai.ts"
      to: "src/lib/ai-prompts.ts"
      via: "import { getGenerateItemPrompt, getRefineItemPrompt } from './ai-prompts'"
      pattern: "from './ai-prompts'"
    - from: "src/lib/index.ts"
      to: "src/lib/ai.ts"
      via: "Barrel re-exports still resolve through ai.ts"
      pattern: "from './ai'"
---

<objective>
Split the 2235-line `ai.ts` god file into 5 focused modules plus a thin composition layer.

Purpose: Resolve SMELL-006 (god file at 2235 lines causing merge conflicts and cognitive overload). Ensure no single file exceeds 800 lines while preserving all existing import paths.

Output: `ai-client.ts` (SDK singletons + key management ~166 lines), `ai-config.ts` (provider/model configuration ~72 lines), `ai-maintenance.ts` (backlog format analysis/correction + bulk suggestions ~450 lines), `ai-analysis.ts` (backlog analysis with bilingual prompts ~433 lines), `ai-prompts.ts` (generation + refinement prompt template literals ~320 lines), and a slimmed `ai.ts` (completion core, generation, refinement logic + re-exports, target ~700 lines).
</objective>

<execution_context>
@C:/Users/Boris/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Boris/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/lib/ai.ts
@src/lib/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extract ai-client.ts and ai-config.ts from ai.ts</name>
  <files>src/lib/ai-client.ts, src/lib/ai-config.ts, src/lib/ai.ts</files>
  <action>
Create `src/lib/ai-client.ts` containing:
- All imports needed by client code: `groq-sdk`, `@google/generative-ai`, `openai`, `secure-storage`, `STORAGE_KEYS`, `getCustomProviderApiKeyKey`, `getModelStorageKey`, `ai-provider-registry`
- The `AIClientConfig` interface
- Functions: `getApiKeyStorageKey` (private), `getApiKey`, `setApiKey`, `clearApiKey`, `initSecureStorage`, `hasApiKey`, `getClientConfig`
- Singleton client management: `groqClient`, `geminiClient`, `openaiClientCache` module-level vars + `getGroqClient`, `getGeminiClient`, `getOpenAIClient` (private), `getOpenAICacheKey` (private), `resetClient`
- Export `getGroqClient`, `getGeminiClient`, `getOpenAIClient` for internal use by ai.ts generation functions (these were previously private in ai.ts; now they must be exported from ai-client.ts but NOT from the public barrel)

Create `src/lib/ai-config.ts` containing:
- Imports: `STORAGE_KEYS`, `getModelStorageKey` from storage, `AI_CONFIG` from config, `getProviderById` from ai-provider-registry
- Type re-exports: `AIProvider`, `ProviderId`
- Functions: `getProvider`, `setProvider`, `getSelectedModel`, `setSelectedModel`, `getEffectiveAIConfig`, `resolveModelForProvider`, `getProviderDisplayName`

Update `src/lib/ai.ts`:
- Remove all code that was extracted to ai-client.ts and ai-config.ts
- Add imports from `./ai-client` and `./ai-config`
- Re-export everything from ai-client and ai-config so existing `import { X } from '../lib/ai'` paths continue to work: `export { getProvider, setProvider, getApiKey, setApiKey, clearApiKey, hasApiKey, getClientConfig, resetClient, initSecureStorage, getEffectiveAIConfig, resolveModelForProvider, getProviderDisplayName, getSelectedModel, setSelectedModel } from './ai-config'` and similar for ai-client exports
- Re-export types: `export type { AIProvider, ProviderId }` from ai-config
- Keep in ai.ts: `AIOptions` interface, `ImageData` interface, `CompletionOptions`, `generateCompletion` (uses client getters from ai-client), `ChatCompletionMessage`, `generateChatCompletion`, `generateCompletionWithRetry`, `testProviderConnection`, `refineItem`, `generateItemFromDescription`, `suggestImprovements`, `buildTypeClassificationSection`, `buildTypeEnum`, `analyzeBacklog` and related types/functions, all re-exports from ai-telemetry/ai-retry
- The `generateCompletion` function calls `getGroqClient`, `getGeminiClient`, `getOpenAIClient` — import these from `./ai-client`
- Similarly `generateChatCompletion` calls the same client getters
  </action>
  <verify>Run `pnpm build` — must pass with zero errors. Verify ai.ts is under 1600 lines (after this task, before maintenance extraction).</verify>
  <done>ai-client.ts and ai-config.ts exist with the extracted code. ai.ts re-exports all public symbols. No import path changes needed in any consumer file. Build passes.</done>
</task>

<task type="auto">
  <name>Task 2: Extract ai-maintenance.ts, ai-analysis.ts, and ai-prompts.ts; verify line counts</name>
  <files>src/lib/ai-maintenance.ts, src/lib/ai-analysis.ts, src/lib/ai-prompts.ts, src/lib/ai.ts, src/lib/index.ts</files>
  <action>
**Extraction 1: ai-maintenance.ts (~450 lines)**

Create `src/lib/ai-maintenance.ts` containing:
- The "BACKLOG MAINTENANCE" section from ai.ts (lines ~1468-1802): `BacklogMaintenanceResult` interface, `MAINTENANCE_PROMPT_FR`, `MAINTENANCE_PROMPT_EN`, `analyzeBacklogFormat` function, `correctBacklogFormat` function
- The "BULK SUGGESTIONS" section from ai.ts (lines ~1352-1467): `SUGGESTIONS_PROMPT_FR` / `SUGGESTIONS_PROMPT_EN` template literals, `suggestImprovements` function — logically related to maintenance
- Required imports from ai.ts: `generateCompletionWithRetry` (import from './ai'), `getEffectiveAIConfig` (import from './ai-config'), `resolveModelForProvider` (import from './ai-config')
- Required imports from types/ai: `MaintenanceResponseSchema`, `SuggestionsResponseSchema`, `safeParseAIResponse`, `type MaintenanceIssue`
- Import `getCurrentLocale`, `getTranslations` from i18n
- Import `recordTelemetry`, `type TelemetryErrorType` from ai-telemetry
- Import `BacklogItem` from types/backlog, `AIOptions` from current module (import from './ai')
- Import `buildPromptWithContext` from ai-context, `getCriteriaInstructions` from ai-criteria

**Extraction 2: ai-analysis.ts (~433 lines)**

Create `src/lib/ai-analysis.ts` containing:
- The entire "BACKLOG ANALYSIS (LT-002)" section from ai.ts (lines ~1803-2235): `AnalyzeBacklogResult` interface, `AnalyzeBacklogOptions` interface, `ANALYZE_BACKLOG_PROMPT_FR`, `ANALYZE_BACKLOG_PROMPT_EN`, `getAnalyzeBacklogPrompt()` helper, `analyzeBacklog` function
- The re-export block at the bottom: `export type { BacklogAnalysisResponse, ItemPriorityScore, ItemGroup, BlockingBug }` (these types are re-exported from `../types/ai`)
- Required imports: `generateCompletionWithRetry` from './ai', `getEffectiveAIConfig`, `resolveModelForProvider` from './ai-config'
- Imports from types/ai: `BacklogAnalysisResponseSchema`, `safeParseAIResponse`, and the type imports for `BacklogAnalysisResponse`, `ItemPriorityScore`, `ItemGroup`, `BlockingBug`
- Import `getCurrentLocale`, `getTranslations` from i18n
- Import `recordTelemetry`, `type TelemetryErrorType` from ai-telemetry
- Import `BacklogItem` from types/backlog, `TypeDefinition` from types/typeConfig
- Import `track` from telemetry

**Extraction 3: ai-prompts.ts (~320 lines)**

Create `src/lib/ai-prompts.ts` containing:
- `GENERATE_ITEM_PROMPT_FR` and `GENERATE_ITEM_PROMPT_EN` template literals (lines ~1067-1221, ~155 lines)
- `getGenerateItemPrompt()` function that returns the locale-appropriate prompt (line ~1222)
- `REFINE_ITEM_PROMPT_FR` and `REFINE_ITEM_PROMPT_EN` template literals (from refinement section, lines ~750-843, ~94 lines)
- `getRefineItemPrompt()` function that returns the locale-appropriate refinement prompt
- Imports: `getCurrentLocale` from i18n
- These are pure string constants with no runtime dependencies beyond locale

**Update ai.ts:**
- Remove all code that was extracted to the three new modules
- Add imports from `./ai-maintenance`, `./ai-analysis`, `./ai-prompts`
- In `generateItemFromDescription`, replace inline prompt reference with `import { getGenerateItemPrompt } from './ai-prompts'`
- In `refineItem`, replace inline prompt reference with `import { getRefineItemPrompt } from './ai-prompts'`
- Add re-exports to preserve all existing import paths:
  - `export { analyzeBacklogFormat, correctBacklogFormat, type BacklogMaintenanceResult, suggestImprovements } from './ai-maintenance'`
  - `export { analyzeBacklog, type AnalyzeBacklogResult, type AnalyzeBacklogOptions } from './ai-analysis'`
  - `export type { BacklogAnalysisResponse, ItemPriorityScore, ItemGroup, BlockingBug } from './ai-analysis'`
  - `export { getGenerateItemPrompt, getRefineItemPrompt } from './ai-prompts'` (only if these were previously exported; if not, no re-export needed)

**Update src/lib/index.ts:**
- No changes needed (barrel already imports from './ai', and the re-exports chain through)

**Line count verification (mandatory):**
After all extractions, ai.ts should contain approximately:
- Imports + types (~65 lines)
- Re-exports block (~15 lines)
- generateCompletion (~177 lines)
- generateChatCompletion (~204 lines)
- generateCompletionWithRetry + testProviderConnection (~56 lines)
- refineItem function body without prompt (~140 lines, down from ~238 after prompt extraction)
- generateItemFromDescription function body without prompt (~90 lines, down from ~127 after prompt extraction)
- buildTypeClassificationSection + buildTypeEnum (~30 lines)
- Total: ~700-780 lines — under 800 ceiling

If ai.ts still exceeds 800 lines after all five extractions, additionally extract `generateChatCompletion` (~204 lines) into `ai-client.ts` (it is a low-level completion function closely related to client management). This is a fallback only.
  </action>
  <verify>Run `pnpm build` — must pass. Run `pnpm test` — all tests must pass. Count lines of each file: `wc -l src/lib/ai.ts src/lib/ai-client.ts src/lib/ai-config.ts src/lib/ai-maintenance.ts src/lib/ai-analysis.ts src/lib/ai-prompts.ts` — no file exceeds 800 lines.</verify>
  <done>ai-maintenance.ts, ai-analysis.ts, and ai-prompts.ts exist with their extracted code. ai.ts is definitively under 800 lines. All 6 ai module files compile. Build and tests pass. No external import paths changed.</done>
</task>

</tasks>

<verification>
1. `pnpm build` passes with zero TypeScript errors
2. `pnpm test` — existing test suite remains green
3. Line count verification: `ai.ts` < 800, `ai-client.ts` < 800, `ai-config.ts` < 800, `ai-maintenance.ts` < 800, `ai-analysis.ts` < 800, `ai-prompts.ts` < 800
4. Grep for `from '../lib/ai'` and `from './ai'` — all existing imports still resolve
5. No new exports leak internal client getters (getGroqClient etc.) through the barrel `lib/index.ts`
</verification>

<success_criteria>
- ai.ts split into 5 focused modules (ai-client.ts, ai-config.ts, ai-maintenance.ts, ai-analysis.ts, ai-prompts.ts)
- No single file in the ai module family exceeds 800 lines
- All existing import paths continue to work without changes to consumer files
- Build passes; tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/35-architecture-performance/35-01-SUMMARY.md`
</output>
