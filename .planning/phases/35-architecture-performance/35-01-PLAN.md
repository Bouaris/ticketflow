---
phase: 35-architecture-performance
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/ai-client.ts
  - src/lib/ai-config.ts
  - src/lib/ai-maintenance.ts
  - src/lib/ai.ts
  - src/lib/index.ts
autonomous: true
requirements: [FIX-09]
must_haves:
  truths:
    - "No single ai-*.ts file in src/lib/ exceeds 800 lines"
    - "All existing imports from '../lib/ai' and './ai' continue to resolve without error"
    - "pnpm build passes with zero TypeScript errors"
    - "Existing test suite remains green"
  artifacts:
    - path: "src/lib/ai-client.ts"
      provides: "SDK singletons, API key CRUD, secure storage init, resetClient"
      min_lines: 100
    - path: "src/lib/ai-config.ts"
      provides: "getProvider, setProvider, getEffectiveAIConfig, resolveModelForProvider, getProviderDisplayName, getSelectedModel, setSelectedModel"
      min_lines: 80
    - path: "src/lib/ai-maintenance.ts"
      provides: "analyzeBacklogFormat, correctBacklogFormat, BacklogMaintenanceResult"
      min_lines: 200
    - path: "src/lib/ai.ts"
      provides: "Thin composition layer re-exporting from sub-modules + keeping generation/refinement/analysis logic"
      max_lines: 800
  key_links:
    - from: "src/lib/ai.ts"
      to: "src/lib/ai-client.ts"
      via: "import { getGroqClient, getGeminiClient, getOpenAIClient, getClientConfig } from './ai-client'"
      pattern: "from './ai-client'"
    - from: "src/lib/ai.ts"
      to: "src/lib/ai-config.ts"
      via: "import { getProvider, getEffectiveAIConfig, resolveModelForProvider } from './ai-config'"
      pattern: "from './ai-config'"
    - from: "src/lib/index.ts"
      to: "src/lib/ai.ts"
      via: "Barrel re-exports still resolve through ai.ts"
      pattern: "from './ai'"
---

<objective>
Split the 2234-line `ai.ts` god file into 3 focused modules plus a thin composition layer.

Purpose: Resolve SMELL-006 (god file at 2229+ lines causing merge conflicts and cognitive overload). Ensure no single file exceeds 800 lines while preserving all existing import paths.

Output: `ai-client.ts` (SDK singletons + key management), `ai-config.ts` (provider/model configuration), `ai-maintenance.ts` (backlog format analysis/correction), and a slimmed `ai.ts` (generation, refinement, analysis + re-exports from sub-modules).
</objective>

<execution_context>
@C:/Users/Boris/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Boris/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/lib/ai.ts
@src/lib/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extract ai-client.ts and ai-config.ts from ai.ts</name>
  <files>src/lib/ai-client.ts, src/lib/ai-config.ts, src/lib/ai.ts</files>
  <action>
Create `src/lib/ai-client.ts` containing:
- All imports needed by client code: `groq-sdk`, `@google/generative-ai`, `openai`, `secure-storage`, `STORAGE_KEYS`, `getCustomProviderApiKeyKey`, `getModelStorageKey`, `ai-provider-registry`
- The `AIClientConfig` interface
- Functions: `getApiKeyStorageKey` (private), `getApiKey`, `setApiKey`, `clearApiKey`, `initSecureStorage`, `hasApiKey`, `getClientConfig`
- Singleton client management: `groqClient`, `geminiClient`, `openaiClientCache` module-level vars + `getGroqClient`, `getGeminiClient`, `getOpenAIClient` (private), `getOpenAICacheKey` (private), `resetClient`
- Export `getGroqClient`, `getGeminiClient`, `getOpenAIClient` for internal use by ai.ts generation functions (these were previously private in ai.ts; now they must be exported from ai-client.ts but NOT from the public barrel)

Create `src/lib/ai-config.ts` containing:
- Imports: `STORAGE_KEYS`, `getModelStorageKey` from storage, `AI_CONFIG` from config, `getProviderById` from ai-provider-registry
- Type re-exports: `AIProvider`, `ProviderId`
- Functions: `getProvider`, `setProvider`, `getSelectedModel`, `setSelectedModel`, `getEffectiveAIConfig`, `resolveModelForProvider`, `getProviderDisplayName`

Update `src/lib/ai.ts`:
- Remove all code that was extracted to ai-client.ts and ai-config.ts
- Add imports from `./ai-client` and `./ai-config`
- Re-export everything from ai-client and ai-config so existing `import { X } from '../lib/ai'` paths continue to work: `export { getProvider, setProvider, getApiKey, setApiKey, clearApiKey, hasApiKey, getClientConfig, resetClient, initSecureStorage, getEffectiveAIConfig, resolveModelForProvider, getProviderDisplayName, getSelectedModel, setSelectedModel } from './ai-config'` and similar for ai-client exports
- Re-export types: `export type { AIProvider, ProviderId }` from ai-config
- Keep in ai.ts: `AIOptions` interface, `ImageData` interface, `CompletionOptions`, `generateCompletion` (uses client getters from ai-client), `ChatCompletionMessage`, `generateChatCompletion`, `generateCompletionWithRetry`, `testProviderConnection`, `refineItem`, `generateItemFromDescription`, `suggestImprovements`, `buildTypeClassificationSection`, `buildTypeEnum`, `analyzeBacklog` and related types/functions, all re-exports from ai-telemetry/ai-retry
- The `generateCompletion` function calls `getGroqClient`, `getGeminiClient`, `getOpenAIClient` — import these from `./ai-client`
- Similarly `generateChatCompletion` calls the same client getters
  </action>
  <verify>Run `pnpm build` — must pass with zero errors. Verify ai.ts is under 1600 lines (after this task, before maintenance extraction).</verify>
  <done>ai-client.ts and ai-config.ts exist with the extracted code. ai.ts re-exports all public symbols. No import path changes needed in any consumer file. Build passes.</done>
</task>

<task type="auto">
  <name>Task 2: Extract ai-maintenance.ts and verify line counts</name>
  <files>src/lib/ai-maintenance.ts, src/lib/ai.ts, src/lib/index.ts</files>
  <action>
Create `src/lib/ai-maintenance.ts` containing:
- The entire "BACKLOG MAINTENANCE" section from ai.ts (lines ~1468-1800): `BacklogMaintenanceResult` interface, `MAINTENANCE_PROMPT_FR`, `MAINTENANCE_PROMPT_EN`, `analyzeBacklogFormat` function, `correctBacklogFormat` function
- Required imports from ai.ts: `generateCompletionWithRetry` (import from './ai'), `getEffectiveAIConfig` (import from './ai-config'), `resolveModelForProvider` (import from './ai-config')
- Required imports from types/ai: `MaintenanceResponseSchema`, `safeParseAIResponse`, `type MaintenanceIssue`
- Import `getCurrentLocale`, `getTranslations` from i18n
- Import `recordTelemetry`, `type TelemetryErrorType` from ai-telemetry

Update `src/lib/ai.ts`:
- Remove the BACKLOG MAINTENANCE section entirely
- Add re-export: `export { analyzeBacklogFormat, correctBacklogFormat, type BacklogMaintenanceResult } from './ai-maintenance'`

Update `src/lib/index.ts`:
- No changes needed (barrel already imports from './ai', and the re-exports will chain through)

After extraction, verify final line counts:
- ai-client.ts: ~200 lines
- ai-config.ts: ~100 lines
- ai-maintenance.ts: ~350 lines
- ai.ts: should be under 800 lines (target: ~1500 original - 200 client - 100 config - 350 maintenance = ~850, may need to also extract prompts or further trim)

If ai.ts still exceeds 800 lines after the three extractions, also extract the `BULK SUGGESTIONS` section (suggestImprovements + SUGGESTIONS prompts, ~115 lines) into `ai-maintenance.ts` since suggestions are logically related to maintenance. This should bring ai.ts under 800.
  </action>
  <verify>Run `pnpm build` — must pass. Run `pnpm test` — all tests must pass. Count lines: no ai-*.ts file in src/lib/ exceeds 800 lines (check with file line count).</verify>
  <done>ai-maintenance.ts exists with maintenance/correction logic. ai.ts is under 800 lines. All 4 ai module files compile. Build and tests pass. No external import paths changed.</done>
</task>

</tasks>

<verification>
1. `pnpm build` passes with zero TypeScript errors
2. `pnpm test` — existing test suite remains green
3. Line count verification: `ai.ts` < 800, `ai-client.ts` < 800, `ai-config.ts` < 800, `ai-maintenance.ts` < 800
4. Grep for `from '../lib/ai'` and `from './ai'` — all existing imports still resolve
5. No new exports leak internal client getters (getGroqClient etc.) through the barrel `lib/index.ts`
</verification>

<success_criteria>
- ai.ts split into 3+ focused modules (ai-client.ts, ai-config.ts, ai-maintenance.ts)
- No single file in the ai module family exceeds 800 lines
- All existing import paths continue to work without changes to consumer files
- Build passes; tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/35-architecture-performance/35-01-SUMMARY.md`
</output>
