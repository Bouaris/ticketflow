---
phase: 35-architecture-performance
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/ai-client.ts
  - src/lib/ai-config.ts
  - src/lib/ai-maintenance.ts
  - src/lib/ai-analysis.ts
  - src/lib/ai-prompts.ts
  - src/lib/ai.ts
  - src/lib/index.ts
autonomous: true
requirements: [FIX-09]
must_haves:
  truths:
    - "No single ai-*.ts file in src/lib/ exceeds 800 lines"
    - "All existing imports from '../lib/ai' and './ai' continue to resolve without error"
    - "pnpm build passes with zero TypeScript errors"
    - "Existing test suite remains green"
    - "No circular ES module dependency: ai-maintenance.ts and ai-analysis.ts do NOT import from './ai'"
  artifacts:
    - path: "src/lib/ai-client.ts"
      provides: "SDK singletons, API key CRUD, secure storage init, resetClient, generateCompletion, generateChatCompletion, generateCompletionWithRetry"
      min_lines: 500
    - path: "src/lib/ai-config.ts"
      provides: "getProvider, setProvider, getEffectiveAIConfig, resolveModelForProvider, getProviderDisplayName, getSelectedModel, setSelectedModel"
      min_lines: 80
    - path: "src/lib/ai-maintenance.ts"
      provides: "analyzeBacklogFormat, correctBacklogFormat, BacklogMaintenanceResult, suggestImprovements"
      min_lines: 200
    - path: "src/lib/ai-analysis.ts"
      provides: "analyzeBacklog, AnalyzeBacklogResult, AnalyzeBacklogOptions, ANALYZE_BACKLOG_PROMPT_FR, ANALYZE_BACKLOG_PROMPT_EN"
      min_lines: 300
    - path: "src/lib/ai-prompts.ts"
      provides: "GENERATE_ITEM_PROMPT_FR, GENERATE_ITEM_PROMPT_EN, getGenerateItemPrompt, REFINE_ITEM_PROMPT_FR, REFINE_ITEM_PROMPT_EN, getRefineItemPrompt"
      min_lines: 250
    - path: "src/lib/ai.ts"
      provides: "Thin composition layer re-exporting from sub-modules + keeping generation/refinement business logic"
      max_lines: 500
  key_links:
    - from: "src/lib/ai.ts"
      to: "src/lib/ai-client.ts"
      via: "import { getGroqClient, getGeminiClient, getOpenAIClient, getClientConfig, generateCompletionWithRetry } from './ai-client'"
      pattern: "from './ai-client'"
    - from: "src/lib/ai.ts"
      to: "src/lib/ai-config.ts"
      via: "import { getProvider, getEffectiveAIConfig, resolveModelForProvider } from './ai-config'"
      pattern: "from './ai-config'"
    - from: "src/lib/ai-maintenance.ts"
      to: "src/lib/ai-client.ts"
      via: "import { generateCompletionWithRetry } from './ai-client'"
      pattern: "from './ai-client'"
    - from: "src/lib/ai-analysis.ts"
      to: "src/lib/ai-client.ts"
      via: "import { generateCompletionWithRetry } from './ai-client'"
      pattern: "from './ai-client'"
    - from: "src/lib/ai.ts"
      to: "src/lib/ai-analysis.ts"
      via: "import { analyzeBacklog } from './ai-analysis'"
      pattern: "from './ai-analysis'"
    - from: "src/lib/ai.ts"
      to: "src/lib/ai-prompts.ts"
      via: "import { getGenerateItemPrompt, getRefineItemPrompt } from './ai-prompts'"
      pattern: "from './ai-prompts'"
    - from: "src/lib/index.ts"
      to: "src/lib/ai.ts"
      via: "Barrel re-exports still resolve through ai.ts"
      pattern: "from './ai'"
---

<objective>
Split the 2235-line `ai.ts` god file into 5 focused modules plus a thin composition layer.

Purpose: Resolve SMELL-006 (god file at 2235 lines causing merge conflicts and cognitive overload). Ensure no single file exceeds 800 lines while preserving all existing import paths.

Output: `ai-client.ts` (SDK singletons + key management + completion core ~560 lines), `ai-config.ts` (provider/model configuration ~72 lines), `ai-maintenance.ts` (backlog format analysis/correction + bulk suggestions ~450 lines), `ai-analysis.ts` (backlog analysis with bilingual prompts ~433 lines), `ai-prompts.ts` (generation + refinement prompt template literals ~320 lines), and a slimmed `ai.ts` (generation, refinement logic + re-exports, target ~330 lines).

IMPORTANT — Circular dependency prevention: `ai.ts` re-exports from `ai-maintenance.ts` and `ai-analysis.ts`. Therefore those modules MUST NOT import from `'./ai'` (which would create `ai.ts -> ai-maintenance.ts -> ai.ts` cycles). The completion core (`generateCompletion`, `generateChatCompletion`, `generateCompletionWithRetry`) is placed in `ai-client.ts` so that all downstream modules import from `'./ai-client'` — a leaf module with no back-imports.
</objective>

<execution_context>
@C:/Users/Boris/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Boris/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/lib/ai.ts
@src/lib/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extract ai-client.ts (SDK singletons + completion core) and ai-config.ts from ai.ts</name>
  <files>src/lib/ai-client.ts, src/lib/ai-config.ts, src/lib/ai.ts</files>
  <action>
Create `src/lib/ai-client.ts` containing TWO logical sections:

**Section A: SDK singletons and API key management**
- All imports needed by client code: `groq-sdk`, `@google/generative-ai`, `openai`, `secure-storage`, `STORAGE_KEYS`, `getCustomProviderApiKeyKey`, `getModelStorageKey`, `ai-provider-registry`
- The `AIClientConfig` interface
- Functions: `getApiKeyStorageKey` (private), `getApiKey`, `setApiKey`, `clearApiKey`, `initSecureStorage`, `hasApiKey`, `getClientConfig`
- Singleton client management: `groqClient`, `geminiClient`, `openaiClientCache` module-level vars + `getGroqClient`, `getGeminiClient`, `getOpenAIClient`, `getOpenAICacheKey` (private), `resetClient`
- Export `getGroqClient`, `getGeminiClient`, `getOpenAIClient` for internal use by generation functions in ai.ts (NOT re-exported through the public barrel)

**Section B: Completion core (CRITICAL — prevents circular dependency)**
Move these functions from ai.ts into ai-client.ts:
- `CompletionOptions` interface (lines ~337-344 in current ai.ts)
- `generateCompletion` function (lines ~345-517, ~173 lines) — private async function that calls `getGroqClient`, `getGeminiClient`, `getOpenAIClient` (now local to the same file)
- `ChatCompletionMessage` type and `generateChatCompletion` function (lines ~518-690, ~173 lines) — uses same client getters
- `generateCompletionWithRetry` function (lines ~691-742, ~52 lines) — wraps generateCompletion with retry logic

Export `generateCompletionWithRetry` and `generateChatCompletion` (these are used by ai-maintenance.ts, ai-analysis.ts, and ai.ts). Keep `generateCompletion` private (not exported) since it is only called by the retry wrapper and chat completion.

Why this matters: `ai.ts` re-exports from `ai-maintenance.ts` and `ai-analysis.ts`. Those modules need `generateCompletionWithRetry`. If they import it from `'./ai'`, this creates a circular dependency: `ai.ts -> ai-maintenance.ts -> ai.ts`. By placing the completion core in `ai-client.ts` (a leaf module that imports only from external packages and config modules), the cycle is broken:
- `ai-client.ts` imports: groq-sdk, openai, generative-ai, ai-config, ai-telemetry, ai-retry (leaf deps only)
- `ai-maintenance.ts` imports: `./ai-client` (for generateCompletionWithRetry), `./ai-config`
- `ai-analysis.ts` imports: `./ai-client` (for generateCompletionWithRetry), `./ai-config`
- `ai.ts` imports: `./ai-client`, `./ai-config`, `./ai-maintenance`, `./ai-analysis`, `./ai-prompts` (no cycles)

Also import into ai-client.ts any dependencies that generateCompletion/generateChatCompletion need:
- `getEffectiveAIConfig`, `resolveModelForProvider` from `./ai-config`
- `recordTelemetry`, `type TelemetryErrorType` from `./ai-telemetry`
- `withRetry` from `./ai-retry` (used by generateCompletionWithRetry)
- `getTranslations` from i18n
- `ImageData` interface — move to ai-client.ts alongside generateCompletion which uses it

Estimated ai-client.ts size: ~166 (SDK/key mgmt) + ~398 (completion core) = ~560 lines.

Create `src/lib/ai-config.ts` containing:
- Imports: `STORAGE_KEYS`, `getModelStorageKey` from storage, `AI_CONFIG` from config, `getProviderById` from ai-provider-registry
- Type re-exports: `AIProvider`, `ProviderId`
- Functions: `getProvider`, `setProvider`, `getSelectedModel`, `setSelectedModel`, `getEffectiveAIConfig`, `resolveModelForProvider`, `getProviderDisplayName`

Update `src/lib/ai.ts`:
- Remove all code that was extracted to ai-client.ts and ai-config.ts (including generateCompletion, generateChatCompletion, generateCompletionWithRetry, CompletionOptions, ChatCompletionMessage, ImageData)
- Add imports from `./ai-client`: `generateCompletionWithRetry`, `generateChatCompletion`, `getGroqClient`, `getGeminiClient`, `getOpenAIClient`, `getClientConfig`
- Add imports from `./ai-config`: `getEffectiveAIConfig`, `resolveModelForProvider`, etc.
- Re-export everything from ai-client and ai-config so existing `import { X } from '../lib/ai'` paths continue to work:
  - `export { getProvider, setProvider, getApiKey, setApiKey, clearApiKey, hasApiKey, getClientConfig, resetClient, initSecureStorage, getEffectiveAIConfig, resolveModelForProvider, getProviderDisplayName, getSelectedModel, setSelectedModel } from './ai-config'` (and similar for ai-client exports)
  - `export { generateCompletionWithRetry, generateChatCompletion } from './ai-client'`
  - `export type { CompletionOptions, ChatCompletionMessage, ImageData } from './ai-client'`
- Re-export types: `export type { AIProvider, ProviderId }` from ai-config
- Keep in ai.ts: `AIOptions` interface, `testProviderConnection`, `refineItem`, `generateItemFromDescription`, `suggestImprovements`, `buildTypeClassificationSection`, `buildTypeEnum`, `analyzeBacklog` and related types/functions, all re-exports from ai-telemetry/ai-retry
- `testProviderConnection` calls `generateCompletion` — since generateCompletion is now private in ai-client.ts, either: (a) export a `testProviderConnection` helper from ai-client.ts too, or (b) make testProviderConnection call `generateCompletionWithRetry` instead. Option (a) is cleaner: move `testProviderConnection` (lines ~743-843, ~101 lines) into ai-client.ts alongside the completion functions it depends on. Re-export from ai.ts.
  </action>
  <verify>Run `pnpm build` — must pass with zero errors. Verify ai.ts is under 1200 lines (after this task, before maintenance/analysis/prompts extraction). Verify no circular imports: ai-client.ts does NOT import from './ai'.</verify>
  <done>ai-client.ts and ai-config.ts exist with the extracted code. ai-client.ts contains SDK singletons + completion core + testProviderConnection (~660 lines). ai.ts re-exports all public symbols. No import path changes needed in any consumer file. No circular dependencies. Build passes.</done>
</task>

<task type="auto">
  <name>Task 2: Extract ai-prompts.ts from ai.ts</name>
  <files>src/lib/ai-prompts.ts, src/lib/ai.ts</files>
  <action>
Create `src/lib/ai-prompts.ts` containing:
- `GENERATE_ITEM_PROMPT_FR` and `GENERATE_ITEM_PROMPT_EN` template literals (lines ~1067-1221 in original ai.ts, ~155 lines)
- `getGenerateItemPrompt()` function that returns the locale-appropriate prompt (line ~1222)
- `REFINE_ITEM_PROMPT_FR` and `REFINE_ITEM_PROMPT_EN` template literals (from refinement section, lines ~750-843, ~94 lines)
- `getRefineItemPrompt()` function that returns the locale-appropriate refinement prompt
- Imports: `getCurrentLocale` from i18n
- These are pure string constants with no runtime dependencies beyond locale

Update ai.ts:
- Remove all extracted prompt template literals and getter functions
- Add imports from `./ai-prompts`: `import { getGenerateItemPrompt, getRefineItemPrompt } from './ai-prompts'`
- In `generateItemFromDescription`, replace inline prompt reference with the imported `getGenerateItemPrompt()`
- In `refineItem`, replace inline prompt reference with the imported `getRefineItemPrompt()`
- Add re-exports if these were previously exported: `export { getGenerateItemPrompt, getRefineItemPrompt } from './ai-prompts'`
  </action>
  <verify>Run `pnpm build` — must pass. Verify ai-prompts.ts exists with the prompt constants. Verify ai.ts no longer contains GENERATE_ITEM_PROMPT_FR or REFINE_ITEM_PROMPT_FR.</verify>
  <done>ai-prompts.ts contains all prompt template literals (~320 lines). ai.ts uses imported prompt getters. Build passes.</done>
</task>

<task type="auto">
  <name>Task 3: Extract ai-maintenance.ts and ai-analysis.ts; verify final line counts</name>
  <files>src/lib/ai-maintenance.ts, src/lib/ai-analysis.ts, src/lib/ai.ts, src/lib/index.ts</files>
  <action>
**Extraction 1: ai-maintenance.ts (~450 lines)**

Create `src/lib/ai-maintenance.ts` containing:
- The "BACKLOG MAINTENANCE" section from ai.ts (lines ~1468-1802 in original): `BacklogMaintenanceResult` interface, `MAINTENANCE_PROMPT_FR`, `MAINTENANCE_PROMPT_EN`, `analyzeBacklogFormat` function, `correctBacklogFormat` function
- The "BULK SUGGESTIONS" section from ai.ts (lines ~1352-1467 in original): `SUGGESTIONS_PROMPT_FR` / `SUGGESTIONS_PROMPT_EN` template literals, `suggestImprovements` function — logically related to maintenance
- CRITICAL import: `generateCompletionWithRetry` from `'./ai-client'` (NOT from `'./ai'` — this prevents circular dependency)
- Import `getEffectiveAIConfig`, `resolveModelForProvider` from `'./ai-config'`
- Import from types/ai: `MaintenanceResponseSchema`, `SuggestionsResponseSchema`, `safeParseAIResponse`, `type MaintenanceIssue`
- Import `getCurrentLocale`, `getTranslations` from i18n
- Import `recordTelemetry`, `type TelemetryErrorType` from ai-telemetry
- Import `BacklogItem` from types/backlog
- Import `AIOptions` type — either define locally or import from './ai' as a type-only import (type-only imports do NOT create runtime circular deps: `import type { AIOptions } from './ai'` is safe because TypeScript erases it at compile time)
- Import `buildPromptWithContext` from ai-context, `getCriteriaInstructions` from ai-criteria

**Extraction 2: ai-analysis.ts (~433 lines)**

Create `src/lib/ai-analysis.ts` containing:
- The entire "BACKLOG ANALYSIS (LT-002)" section from ai.ts (lines ~1803-2235 in original): `AnalyzeBacklogResult` interface, `AnalyzeBacklogOptions` interface, `ANALYZE_BACKLOG_PROMPT_FR`, `ANALYZE_BACKLOG_PROMPT_EN`, `getAnalyzeBacklogPrompt()` helper, `analyzeBacklog` function
- The re-export block: `export type { BacklogAnalysisResponse, ItemPriorityScore, ItemGroup, BlockingBug }` (re-exported from `../types/ai`)
- CRITICAL import: `generateCompletionWithRetry` from `'./ai-client'` (NOT from `'./ai'` — this prevents circular dependency)
- Import `getEffectiveAIConfig`, `resolveModelForProvider` from `'./ai-config'`
- Import from types/ai: `BacklogAnalysisResponseSchema`, `safeParseAIResponse`, and type imports for `BacklogAnalysisResponse`, `ItemPriorityScore`, `ItemGroup`, `BlockingBug`
- Import `getCurrentLocale`, `getTranslations` from i18n
- Import `recordTelemetry`, `type TelemetryErrorType` from ai-telemetry
- Import `BacklogItem` from types/backlog, `TypeDefinition` from types/typeConfig
- Import `track` from telemetry

**Update ai.ts:**
- Remove all code that was extracted to ai-maintenance.ts and ai-analysis.ts
- Add re-exports to preserve all existing import paths:
  - `export { analyzeBacklogFormat, correctBacklogFormat, type BacklogMaintenanceResult, suggestImprovements } from './ai-maintenance'`
  - `export { analyzeBacklog, type AnalyzeBacklogResult, type AnalyzeBacklogOptions } from './ai-analysis'`
  - `export type { BacklogAnalysisResponse, ItemPriorityScore, ItemGroup, BlockingBug } from './ai-analysis'`

**Update src/lib/index.ts:**
- No changes needed (barrel already imports from './ai', and the re-exports chain through)

**Line count verification (mandatory):**
After all extractions across Tasks 1-3, ai.ts should contain approximately:
- Imports + re-exports block (~40 lines)
- AIOptions interface (~10 lines)
- refineItem function body without prompt (~140 lines, down from ~238 after prompt extraction)
- generateItemFromDescription function body without prompt (~90 lines, down from ~127 after prompt extraction)
- buildTypeClassificationSection + buildTypeEnum (~30 lines)
- Total: ~310-350 lines — well under 800 ceiling

Verify NO circular dependencies exist:
- `ai-client.ts` must NOT import from `'./ai'`, `'./ai-maintenance'`, or `'./ai-analysis'`
- `ai-maintenance.ts` must NOT import from `'./ai'` (runtime imports only; `import type` is allowed)
- `ai-analysis.ts` must NOT import from `'./ai'` (runtime imports only; `import type` is allowed)
  </action>
  <verify>Run `pnpm build` — must pass. Run `pnpm test` — all tests must pass. Count lines of each file: `wc -l src/lib/ai.ts src/lib/ai-client.ts src/lib/ai-config.ts src/lib/ai-maintenance.ts src/lib/ai-analysis.ts src/lib/ai-prompts.ts` — no file exceeds 800 lines. Verify no circular imports: `grep -n "from './ai'" src/lib/ai-maintenance.ts src/lib/ai-analysis.ts` should return only `import type` lines (if any), never runtime imports.</verify>
  <done>ai-maintenance.ts and ai-analysis.ts exist with their extracted code. Both import generateCompletionWithRetry from './ai-client' (not './ai'). ai.ts is definitively under 500 lines. All 6 ai module files compile. No circular ES module dependencies. Build and tests pass. No external import paths changed.</done>
</task>

</tasks>

<verification>
1. `pnpm build` passes with zero TypeScript errors
2. `pnpm test` — existing test suite remains green
3. Line count verification: `ai.ts` < 500, `ai-client.ts` < 800, `ai-config.ts` < 800, `ai-maintenance.ts` < 800, `ai-analysis.ts` < 800, `ai-prompts.ts` < 800
4. Grep for `from '../lib/ai'` and `from './ai'` — all existing imports still resolve
5. No new exports leak internal client getters (getGroqClient etc.) through the barrel `lib/index.ts`
6. No circular dependencies: `grep "from './ai'" src/lib/ai-maintenance.ts src/lib/ai-analysis.ts` returns no runtime imports
</verification>

<success_criteria>
- ai.ts split into 5 focused modules (ai-client.ts, ai-config.ts, ai-maintenance.ts, ai-analysis.ts, ai-prompts.ts)
- No single file in the ai module family exceeds 800 lines
- No circular ES module dependencies between ai.ts and its sub-modules
- All existing import paths continue to work without changes to consumer files
- Build passes; tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/35-architecture-performance/35-01-SUMMARY.md`
</output>
