---
phase: 35-architecture-performance
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/hooks/useWorkspaceBulkOps.ts
  - src/hooks/useWorkspaceTypeSync.ts
  - src/hooks/useWorkspaceItemActions.ts
  - src/hooks/useWorkspaceModals.ts
  - src/components/workspace/ProjectWorkspace.tsx
autonomous: true
requirements: [FIX-10]
must_haves:
  truths:
    - "ProjectWorkspace.tsx is under 600 lines"
    - "4 new hooks exist: useWorkspaceBulkOps, useWorkspaceTypeSync, useWorkspaceItemActions, useWorkspaceModals"
    - "TypeConfig sync effect dependencies are documented with inline comments explaining stability guarantees"
    - "pnpm build passes with zero TypeScript errors"
    - "All workspace functionality (CRUD, bulk ops, type sync, modals) works identically"
  artifacts:
    - path: "src/hooks/useWorkspaceBulkOps.ts"
      provides: "Multi-select + bulk delete/archive/priority/effort/type operations"
      min_lines: 80
    - path: "src/hooks/useWorkspaceTypeSync.ts"
      provides: "TypeConfig <-> SQLite sync (Step 1 + Step 2 effects) with documented deps"
      min_lines: 60
    - path: "src/hooks/useWorkspaceItemActions.ts"
      provides: "CRUD handlers: handleUpdateItem, confirmDeleteItem, confirmArchive, handleRestoreFromArchive, handleDeleteFromArchive, handlePurgeArchive, handleSaveItem, handleQuickValidate, handleQuickExport"
      min_lines: 100
    - path: "src/hooks/useWorkspaceModals.ts"
      provides: "Modal state: editor, export, archive confirm, delete confirm, bulk delete, bulk archive, error notification, quick action toast"
      min_lines: 50
    - path: "src/components/workspace/ProjectWorkspace.tsx"
      provides: "Slim orchestrator composing the 4 hooks + rendering"
      max_lines: 600
  key_links:
    - from: "src/components/workspace/ProjectWorkspace.tsx"
      to: "src/hooks/useWorkspaceBulkOps.ts"
      via: "const bulkOps = useWorkspaceBulkOps(...)"
      pattern: "useWorkspaceBulkOps"
    - from: "src/components/workspace/ProjectWorkspace.tsx"
      to: "src/hooks/useWorkspaceTypeSync.ts"
      via: "useWorkspaceTypeSync(...)"
      pattern: "useWorkspaceTypeSync"
    - from: "src/hooks/useWorkspaceTypeSync.ts"
      to: "src/db/queries/type-configs.ts"
      via: "import { bulkUpsertTypeConfigs, deleteTypeConfig } from"
      pattern: "bulkUpsertTypeConfigs"
---

<objective>
Extract 4 hooks from the 1569-line `ProjectWorkspace.tsx` to bring it under 600 lines.

Purpose: Resolve SMELL-007 (god component with 30+ useState/useCallback, persistent merge conflict hotspot) and partially resolve SMELL-005 (document TypeConfig sync effect dependencies).

Output: 4 focused hooks (`useWorkspaceBulkOps`, `useWorkspaceTypeSync`, `useWorkspaceItemActions`, `useWorkspaceModals`) and a slim orchestrator component under 600 lines.
</objective>

<execution_context>
@C:/Users/Boris/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Boris/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/components/workspace/ProjectWorkspace.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extract useWorkspaceModals and useWorkspaceItemActions hooks</name>
  <files>src/hooks/useWorkspaceModals.ts, src/hooks/useWorkspaceItemActions.ts, src/components/workspace/ProjectWorkspace.tsx</files>
  <action>
**Create `src/hooks/useWorkspaceModals.ts`:**

Extract ALL modal/dialog/notification state from ProjectWorkspace:
- `isEditorOpen`, `setIsEditorOpen`
- `editingItem`, `setEditingItem`
- `exportModal`, `setExportModal` (with its `{ isOpen, item, markdown }` type)
- `archiveConfirmModal`, `setArchiveConfirmModal`
- `deleteConfirmModal`, `setDeleteConfirmModal`
- `errorNotification`, `setErrorNotification` (with auto-clear setTimeout)
- `isArchiving`, `setIsArchiving`
- `isDeleting`, `setIsDeleting`
- `isHelpModalOpen`, `setIsHelpModalOpen`
- `quickActionToast`, `setQuickActionToast` (with auto-clear setTimeout)
- `bulkDeleteConfirm`, `setBulkDeleteConfirm`
- `idsToDelete`, `setIdsToDelete`
- `bulkArchiveConfirm`, `setBulkArchiveConfirm`
- `idsToArchive`, `setIdsToArchive`
- `isPaletteOpen`, `setIsPaletteOpen`
- `paletteQuery`, `setPaletteQuery`
- `isQuickCaptureOpen`, `setIsQuickCaptureOpen`
- `isBulkImportOpen`, `setIsBulkImportOpen`
- `isAIAnalysisPanelOpen`, `setIsAIAnalysisPanelOpen`

Return a typed object with all state values and setters. The hook takes no parameters (pure local state).

Type the return interface explicitly: `UseWorkspaceModalsReturn`.

**Create `src/hooks/useWorkspaceItemActions.ts`:**

Extract item CRUD action handlers:
- `handleUpdateItem` — calls `backlog.updateItem(...)`, needs backlog from params
- `confirmDeleteItem` — calls `dbDeleteItemDirect`, `backlog.removeItem`, handles screenshots cleanup, calls `track(...)`. Needs `deleteConfirmModal` state + `backlog` + `screenshotFolder` from params.
- `confirmArchive` — calls `insertArchivedItem`, `dbDeleteItemDirect`, `backlog.removeItem`. Needs `archiveConfirmModal` state + `backlog`.
- `handleRestoreFromArchive` — calls `dbUpdateItemDirect`, `backlog.refreshItems`. Needs `backlog`.
- `handleDeleteFromArchive` — calls `deleteArchivedItem` + screenshot cleanup. Needs `screenshotFolder`.
- `handlePurgeArchive` — calls `purgeAllArchivedItems`.
- `handleSaveItem` — calls `backlog.createItem` or `backlog.updateItem`. Needs `backlog` + `editingItem` state.
- `handleQuickValidate` — toggles all criteria checked/unchecked. Needs `backlog`.
- `handleQuickExport` — calls `buildItemMarkdown` + clipboard. Needs `quickActionToast` setter.
- `handleExportItem` — sets exportModal state.
- `handleArchiveItem` — sets archiveConfirmModal state.
- `handleDeleteRequest` — sets deleteConfirmModal state.
- `handleEditItem` — sets editingItem + isEditorOpen.
- `handleCreateItem` — sets editingItem(null) + isEditorOpen.
- `handleOpenBulkImport` — sets isBulkImportOpen.
- `handleBulkImportCreated` — calls backlog.refreshItems, closes modal.

The hook accepts params object: `{ backlog, modals, screenshotFolder, projectPath }` where `modals` is the return of `useWorkspaceModals`, `backlog` is `UseBacklogDBReturn`, `screenshotFolder` is `UseScreenshotFolderReturn`.

Use `useCallback` with correct dependency arrays for all handlers.

Type the return interface: `UseWorkspaceItemActionsReturn`.

**Update ProjectWorkspace.tsx:**
- Remove all extracted state and handlers
- Import and call `useWorkspaceModals()` and `useWorkspaceItemActions({ backlog, modals, screenshotFolder, projectPath })`
- Destructure return values where needed in JSX
- Ensure all existing prop drilling to child components remains identical
  </action>
  <verify>Run `pnpm build` — must pass with zero errors. ProjectWorkspace should be noticeably smaller.</verify>
  <done>useWorkspaceModals.ts and useWorkspaceItemActions.ts exist. ProjectWorkspace imports and uses them. Build passes.</done>
</task>

<task type="auto">
  <name>Task 2: Extract useWorkspaceBulkOps and useWorkspaceTypeSync hooks</name>
  <files>src/hooks/useWorkspaceBulkOps.ts, src/hooks/useWorkspaceTypeSync.ts, src/components/workspace/ProjectWorkspace.tsx</files>
  <action>
**Create `src/hooks/useWorkspaceBulkOps.ts`:**

Extract all bulk operation handlers:
- `retryOnBusy` utility (useCallback wrapping the retry-with-delay logic)
- `handleBulkPriority` — iterates selected IDs, calls backlog.updateItem with retryOnBusy
- `handleBulkEffort` — same pattern
- `handleBulkType` — same pattern
- `handleBulkDeleteRequest` — sets bulkDeleteConfirm + idsToDelete state
- `confirmBulkDelete` — iterates IDs, calls dbDeleteItemDirect + backlog.removeItem
- `handleBulkValidate` — toggles all criteria for selected items
- `handleBulkArchiveRequest` — sets bulkArchiveConfirm + idsToArchive state
- `confirmBulkArchive` — iterates IDs, calls insertArchivedItem + dbDeleteItemDirect + backlog.removeItem

The hook accepts params: `{ backlog, modals, multiSelect }` where multiSelect provides `selectedIds` and `clearSelection`.

Return typed interface: `UseWorkspaceBulkOpsReturn`.

**Create `src/hooks/useWorkspaceTypeSync.ts`:**

Extract the TypeConfig sync logic (the two useEffects + refs):
- `prevTypesRef`, `typesInitFromDbRef`, `dbSnapshotRef` — all useRef
- Step 1 useEffect: sync SQLite types -> typeConfig hook on DB load
- Step 2 useEffect: persist type config changes to SQLite

The hook accepts params: `{ backlog, typeConfig, projectPath }`.

**CRITICAL for SMELL-005**: Add inline documentation comments to each eslint-disable explaining WHY each omitted dependency is safe:
```typescript
// eslint-disable-line react-hooks/exhaustive-deps
// Omitted deps rationale:
// - typeConfig.initializeWithTypes: stable function reference from useTypeConfig (never changes)
// - projectPath: stable for this component mount (component re-mounts via key={projectPath})
// - prevTypesRef, typesInitFromDbRef, dbSnapshotRef: useRef objects with stable .current identity
```

Apply same documentation pattern to Step 2 effect.

Returns nothing (side-effect only hook), or optionally returns `{ typesInitFromDb: boolean }` if needed by other code.

**Update ProjectWorkspace.tsx:**
- Remove all extracted bulk ops handlers and type sync effects/refs
- Import and call `useWorkspaceBulkOps({ backlog, modals, multiSelect })` and `useWorkspaceTypeSync({ backlog, typeConfig, projectPath })`
- Wire bulk ops return values to BulkActionBar and shortcut actions
- Verify ProjectWorkspace.tsx is now under 600 lines
  </action>
  <verify>Run `pnpm build` — must pass. Run `pnpm test` — all tests pass. Count lines in ProjectWorkspace.tsx — must be under 600.</verify>
  <done>4 hooks extracted. ProjectWorkspace.tsx is under 600 lines. TypeConfig sync deps are documented inline. Build and tests pass.</done>
</task>

</tasks>

<verification>
1. `pnpm build` passes with zero TypeScript errors
2. `pnpm test` — existing test suite remains green
3. ProjectWorkspace.tsx is under 600 lines
4. 4 new hook files exist in src/hooks/
5. TypeConfig sync effect dependencies have inline documentation explaining stability guarantees
6. All workspace functionality preserved (CRUD, bulk ops, type sync, modals, keyboard shortcuts)
</verification>

<success_criteria>
- ProjectWorkspace.tsx reduced to under 600 lines via 4 extracted hooks
- TypeConfig sync effect dependencies documented with inline rationale comments
- All existing workspace behavior preserved
- Build passes; tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/35-architecture-performance/35-02-SUMMARY.md`
</output>
