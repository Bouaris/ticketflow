---
phase: 35-architecture-performance
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - src/hooks/useAIFeedbackStats.ts
  - src/components/settings/AISettingsModal.tsx
  - src/components/settings/ProviderCard.tsx
autonomous: true
requirements: [FIX-11, FIX-13]
must_haves:
  truths:
    - "AISettingsModal does not import getOrCreateProject or getFeedbackStats directly"
    - "useAIFeedbackStats hook encapsulates all database fetching logic"
    - "ProviderCard providerUrls record is at module scope (not recreated on render)"
    - "ProviderCard inline SVG info icon is replaced with InfoIcon from Icons.tsx"
    - "pnpm build passes with zero TypeScript errors"
  artifacts:
    - path: "src/hooks/useAIFeedbackStats.ts"
      provides: "Hook that fetches feedback stats given projectPath, returns { stats, loading }"
      min_lines: 20
    - path: "src/components/settings/AISettingsModal.tsx"
      provides: "Uses useAIFeedbackStats instead of direct DB calls"
    - path: "src/components/settings/ProviderCard.tsx"
      provides: "Module-scope statics, InfoIcon import, no inline SVG"
  key_links:
    - from: "src/components/settings/AISettingsModal.tsx"
      to: "src/hooks/useAIFeedbackStats.ts"
      via: "const { stats } = useAIFeedbackStats(projectPath, isOpen)"
      pattern: "useAIFeedbackStats"
    - from: "src/components/settings/ProviderCard.tsx"
      to: "src/components/ui/Icons.tsx"
      via: "import { InfoIcon } from '../ui/Icons'"
      pattern: "InfoIcon"
---

<objective>
Extract business logic from AISettingsModal into a dedicated hook and clean up ProviderCard static objects and inline SVG.

Purpose: Resolve SMELL-008 (database query functions called directly in UI component — untestable without real SQLite) and SMELL-014/SMELL-015 (static object recreation on render + inline SVG violating icon rule).

Output: `useAIFeedbackStats` hook, cleaned AISettingsModal, and polished ProviderCard.
</objective>

<execution_context>
@C:/Users/Boris/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Boris/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/components/settings/AISettingsModal.tsx
@src/components/settings/ProviderCard.tsx
@src/hooks/useAIFeedback.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extract useAIFeedbackStats hook from AISettingsModal</name>
  <files>src/hooks/useAIFeedbackStats.ts, src/components/settings/AISettingsModal.tsx</files>
  <action>
**Create `src/hooks/useAIFeedbackStats.ts`:**

```typescript
import { useState, useEffect } from 'react';
import { getFeedbackStats, type FeedbackStats } from '../lib/ai-feedback';
import { getOrCreateProject } from '../db/queries/projects';

/**
 * Fetches AI feedback stats for a project.
 * Encapsulates the getOrCreateProject + getFeedbackStats database queries
 * so UI components don't need direct database access.
 *
 * Follows the useAIFeedback pattern from the existing codebase.
 */
export function useAIFeedbackStats(projectPath: string | undefined, isOpen: boolean) {
  const [stats, setStats] = useState<FeedbackStats | null>(null);

  useEffect(() => {
    if (!isOpen || !projectPath) {
      return;
    }
    const projectName = projectPath.split(/[\\/]/).pop() || 'Project';
    getOrCreateProject(projectPath, projectName)
      .then(projectId => getFeedbackStats(projectId))
      .then(setStats)
      .catch(() => setStats(null));
  }, [isOpen, projectPath]);

  return { stats };
}
```

**Update `src/components/settings/AISettingsModal.tsx`:**

1. Remove imports: `getFeedbackStats`, `type FeedbackStats`, `getOrCreateProject`
2. Remove the `feedbackStats` useState and the useEffect that calls getOrCreateProject/getFeedbackStats (lines ~30, ~38-46)
3. Add import: `import { useAIFeedbackStats } from '../../hooks/useAIFeedbackStats';`
4. Replace with: `const { stats: feedbackStats } = useAIFeedbackStats(projectPath, isOpen);`
5. The rest of the JSX referencing `feedbackStats` remains unchanged

Verify the modal still renders feedback stats section correctly when projectPath is provided.
  </action>
  <verify>Run `pnpm build` — must pass. Verify AISettingsModal.tsx no longer imports `getOrCreateProject` or `getFeedbackStats` directly (grep for these imports in the file — should be zero matches).</verify>
  <done>useAIFeedbackStats hook exists. AISettingsModal uses the hook instead of direct DB calls. Build passes.</done>
</task>

<task type="auto">
  <name>Task 2: Move ProviderCard statics to module scope and replace inline SVG</name>
  <files>src/components/settings/ProviderCard.tsx</files>
  <action>
**Move `providerUrls` to module scope:**

The `providerUrls` record (lines ~66-70) is currently inside the component function body. Move it to module scope right after the existing `PROVIDER_COLORS` constant:

```typescript
// Module-scope provider URLs — avoids re-creating on every render
const PROVIDER_URLS: Record<string, string> = {
  groq: 'https://console.groq.com/keys',
  gemini: 'https://makersuite.google.com/app/apikey',
  openai: 'https://platform.openai.com/api-keys',
};
```

Update usage inside the component from `providerUrls[provider.id]` to `PROVIDER_URLS[provider.id]`. Remove the old `providerUrls` local variable and `providerUrl` local variable — use `PROVIDER_URLS[provider.id]` directly where `providerUrl` was referenced (in the `handleGetKey` function and the `{providerUrl && ...}` JSX conditional).

**Replace inline SVG with InfoIcon:**

Add `InfoIcon` to the existing Icons import (the file already imports `GroqIcon, GeminiIcon, OpenAIIcon, CheckIcon`):
```typescript
import { GroqIcon, GeminiIcon, OpenAIIcon, CheckIcon, InfoIcon } from '../ui/Icons';
```

Replace the inline SVG block (lines ~163-167):
```tsx
<svg className="w-3.5 h-3.5 text-blue-500 cursor-help" viewBox="0 0 14 14" fill="none" xmlns="http://www.w3.org/2000/svg">
  <circle cx="7" cy="7" r="6.5" stroke="currentColor" strokeWidth="1" />
  <text x="7" y="10.5" textAnchor="middle" fill="currentColor" fontSize="9" fontWeight="bold">i</text>
</svg>
```

With:
```tsx
<InfoIcon className="w-3.5 h-3.5 text-blue-500 cursor-help" />
```

Note: PROVIDER_COLORS is already at module scope (was moved in Phase 33). Confirm this is still the case — if so, no additional work needed for the colors constant.
  </action>
  <verify>Run `pnpm build` — must pass. Grep ProviderCard.tsx for `<svg` — should return zero matches. Grep for `const providerUrls` inside the function body — should return zero matches.</verify>
  <done>ProviderCard has module-scope PROVIDER_URLS, no inline SVG, uses InfoIcon. Build passes.</done>
</task>

</tasks>

<verification>
1. `pnpm build` passes with zero TypeScript errors
2. `pnpm test` — existing test suite remains green
3. AISettingsModal.tsx does NOT import `getOrCreateProject` or `getFeedbackStats`
4. ProviderCard.tsx has no `<svg>` elements (all icons from Icons.tsx)
5. ProviderCard.tsx PROVIDER_URLS is at module scope (outside function body)
</verification>

<success_criteria>
- AISettingsModal does not directly call database query functions
- useAIFeedbackStats hook extracts the DB logic cleanly
- ProviderCard static objects at module scope; inline SVG replaced with InfoIcon
- Build passes; tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/35-architecture-performance/35-03-SUMMARY.md`
</output>
