---
phase: 33-type-safety-critical-fixes
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/telemetry.ts
  - src/components/workspace/ProjectWorkspace.tsx
  - src/constants/storage.ts
  - src/hooks/useAIQuestioning.ts
  - src/components/onboarding/OnboardingWizard.tsx
autonomous: true
requirements: [FIX-02, FIX-03, FIX-04]
gap_closure: true

must_haves:
  truths:
    - "Calling initTelemetry() twice does NOT duplicate window.addEventListener registrations"
    - "chatPanel.loadHistory is in the useEffect dependency array in ProjectWorkspace — no stale closure on project switch"
    - "ticketflow-questioning-mode and ticketflow-locale are defined in STORAGE_KEYS constant"
    - "All 4+ usage sites import from constants instead of hardcoding string literals"
    - "`pnpm build` passes with zero TypeScript errors"
  artifacts:
    - path: "src/lib/telemetry.ts"
      provides: "Module-level errorTrackingSetUp guard in setupErrorTracking()"
      contains: "errorTrackingSetUp"
    - path: "src/constants/storage.ts"
      provides: "QUESTIONING_MODE and LOCALE keys in STORAGE_KEYS"
      contains: "QUESTIONING_MODE"
    - path: "src/components/workspace/ProjectWorkspace.tsx"
      provides: "chatPanel.loadHistory in useEffect dependency array"
      contains: "chatPanel.loadHistory"
    - path: "src/hooks/useAIQuestioning.ts"
      provides: "Import of STORAGE_KEYS for questioning mode key"
      contains: "STORAGE_KEYS"
    - path: "src/components/onboarding/OnboardingWizard.tsx"
      provides: "Import of STORAGE_KEYS for locale key"
      contains: "STORAGE_KEYS"
  key_links:
    - from: "src/hooks/useAIQuestioning.ts"
      to: "src/constants/storage.ts"
      via: "STORAGE_KEYS.QUESTIONING_MODE import"
      pattern: "STORAGE_KEYS\\.QUESTIONING_MODE"
    - from: "src/components/settings/AISettingsModal.tsx"
      to: "src/constants/storage.ts"
      via: "STORAGE_KEYS.QUESTIONING_MODE import"
      pattern: "STORAGE_KEYS\\.QUESTIONING_MODE"
    - from: "src/components/workspace/ProjectWorkspace.tsx"
      to: "src/constants/storage.ts"
      via: "STORAGE_KEYS.LOCALE import"
      pattern: "STORAGE_KEYS\\.LOCALE"
---

<objective>
Fix telemetry idempotency bug, add missing useEffect dependency, and centralize two hardcoded storage keys.

Purpose: Close SMELL-010 (duplicate event listeners inflate PostHog error counts), SMELL-004 (stale closure on project switch), DEAD-008 + SMELL-009 (DRY violation with divergence risk on storage key strings).
Output: Idempotent telemetry init, correct React dependency array, centralized storage keys imported everywhere.
</objective>

<execution_context>
@C:/Users/Boris/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Boris/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/lib/telemetry.ts
@src/components/workspace/ProjectWorkspace.tsx
@src/constants/storage.ts
@src/hooks/useAIQuestioning.ts
@src/components/settings/AISettingsModal.tsx
@src/components/onboarding/OnboardingWizard.tsx
@src/hooks/useChatPanel.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Make initTelemetry() idempotent and fix useEffect dependency</name>
  <files>src/lib/telemetry.ts, src/components/workspace/ProjectWorkspace.tsx</files>
  <action>
**telemetry.ts (SMELL-010):**

1. Add a module-level guard variable after the existing module-level state section (after line 51):

```typescript
/** Guard to prevent duplicate error tracking listeners (SMELL-010 fix) */
let errorTrackingSetUp = false;
```

2. Gate the `setupErrorTracking()` function body (lines 209-225). Wrap the existing body with:

```typescript
function setupErrorTracking(): void {
  if (errorTrackingSetUp) return;
  errorTrackingSetUp = true;

  window.addEventListener('unhandledrejection', (event) => {
    // ... existing handler unchanged ...
  });

  window.addEventListener('error', (event) => {
    // ... existing handler unchanged ...
  });
}
```

3. Update the JSDoc comment on `initTelemetry()` (line 238) to remove the caveat about handlers accumulating:

Change: "This function is safe to call multiple times (idempotent via the error tracking setup — handlers accumulate but are guarded by consent check)."
To: "This function is safe to call multiple times (idempotent — module-level guard prevents duplicate error tracking listeners)."

**ProjectWorkspace.tsx (SMELL-004):**

1. The `chatPanel.loadHistory` is already stabilized with `useCallback` in `useChatPanel.ts` (deps: `[projectPath, projectId]`). It is safe to add to the dependency array.

2. Replace the useEffect block at lines 173-177:

Change:
```typescript
  useEffect(() => {
    if (isChatOpen && backlog.projectId) {
      chatPanel.loadHistory();
    }
  }, [isChatOpen, backlog.projectId]); // eslint-disable-line react-hooks/exhaustive-deps
```

To:
```typescript
  useEffect(() => {
    if (isChatOpen && backlog.projectId) {
      chatPanel.loadHistory();
    }
  }, [isChatOpen, backlog.projectId, chatPanel.loadHistory]);
```

Note: Remove the `eslint-disable-line` comment — the dependency array is now complete.
  </action>
  <verify>Run `pnpm build` — must pass. Grep for `eslint-disable-line react-hooks/exhaustive-deps` in ProjectWorkspace.tsx — must return zero matches for this specific useEffect. Grep for `errorTrackingSetUp` in telemetry.ts — must find the guard.</verify>
  <done>`initTelemetry()` is idempotent via module-level guard; `chatPanel.loadHistory` is in the dependency array with no eslint suppression; `pnpm build` passes.</done>
</task>

<task type="auto">
  <name>Task 2: Centralize questioning-mode and locale storage keys in STORAGE_KEYS</name>
  <files>src/constants/storage.ts, src/hooks/useAIQuestioning.ts, src/components/settings/AISettingsModal.tsx, src/components/onboarding/OnboardingWizard.tsx, src/components/workspace/ProjectWorkspace.tsx</files>
  <action>
**storage.ts:**

1. Add two new keys to the `STORAGE_KEYS` object, after the `ONBOARDING_COMPLETE` entry (around line 42):

```typescript
  // AI Questioning Mode
  QUESTIONING_MODE: 'ticketflow-questioning-mode',

  // User Locale Preference
  LOCALE: 'ticketflow-locale',
```

**useAIQuestioning.ts (SMELL-009):**

1. Add import at top: `import { STORAGE_KEYS } from '../constants/storage';`
2. Remove the local constant `const QUESTIONING_STORAGE_KEY = 'ticketflow-questioning-mode';` (line 29).
3. Replace all usages of `QUESTIONING_STORAGE_KEY` with `STORAGE_KEYS.QUESTIONING_MODE`. There is one usage at line 74:
   - `localStorage.getItem(QUESTIONING_STORAGE_KEY)` → `localStorage.getItem(STORAGE_KEYS.QUESTIONING_MODE)`

**AISettingsModal.tsx (DEAD-008, part 1):**

Note: This file is also modified by plan 33-01 (different lines). The changes here are on lines 33 and 57 which are unrelated to the `as any` fix on lines 60-63.

1. Add import at top: `import { STORAGE_KEYS } from '../../constants/storage';`
2. Replace hardcoded string on line 33:
   - `localStorage.getItem('ticketflow-questioning-mode')` → `localStorage.getItem(STORAGE_KEYS.QUESTIONING_MODE)`
3. Replace hardcoded string on line 57:
   - `localStorage.setItem('ticketflow-questioning-mode', ...)` → `localStorage.setItem(STORAGE_KEYS.QUESTIONING_MODE, ...)`

**OnboardingWizard.tsx (DEAD-008, part 2):**

1. Add import at top: `import { STORAGE_KEYS } from '../../constants/storage';`
2. Replace hardcoded string on line 192:
   - `localStorage.setItem('ticketflow-locale', loc.code)` → `localStorage.setItem(STORAGE_KEYS.LOCALE, loc.code)`

**ProjectWorkspace.tsx (DEAD-008, part 3):**

1. Add import at top: `import { STORAGE_KEYS } from '../../constants/storage';`
2. Replace hardcoded string on line 162:
   - `localStorage.getItem('ticketflow-locale')` → `localStorage.getItem(STORAGE_KEYS.LOCALE)`
  </action>
  <verify>Run `pnpm build` — must pass. Grep for hardcoded `'ticketflow-questioning-mode'` across all `.ts` and `.tsx` files — must return zero matches (only in storage.ts definition). Grep for hardcoded `'ticketflow-locale'` across all `.ts` and `.tsx` files — must return zero matches (only in storage.ts definition).</verify>
  <done>STORAGE_KEYS has QUESTIONING_MODE and LOCALE; all 4+ usage sites import from constants; local QUESTIONING_STORAGE_KEY removed from useAIQuestioning.ts; `pnpm build` passes.</done>
</task>

</tasks>

<verification>
1. `pnpm build` passes with zero errors
2. `grep -rn "errorTrackingSetUp" src/lib/telemetry.ts` → finds the guard variable and check
3. `grep -rn "eslint-disable-line react-hooks/exhaustive-deps" src/components/workspace/ProjectWorkspace.tsx` → zero matches for the loadHistory useEffect (there may be other eslint-disable comments elsewhere in the file — only the loadHistory one should be removed)
4. `grep -rn "'ticketflow-questioning-mode'" src/ --include="*.ts" --include="*.tsx"` → only in `src/constants/storage.ts`
5. `grep -rn "'ticketflow-locale'" src/ --include="*.ts" --include="*.tsx"` → only in `src/constants/storage.ts`
6. `grep -rn "QUESTIONING_STORAGE_KEY" src/` → zero matches (local constant removed)
</verification>

<success_criteria>
- `initTelemetry()` calling `setupErrorTracking()` twice results in only one set of event listeners
- `chatPanel.loadHistory` is in the useEffect dependency array with no eslint suppression
- `STORAGE_KEYS.QUESTIONING_MODE` and `STORAGE_KEYS.LOCALE` exist in storage.ts
- All hardcoded `'ticketflow-questioning-mode'` and `'ticketflow-locale'` strings are replaced with STORAGE_KEYS imports across all files
- `pnpm build` passes clean
</success_criteria>

<output>
After completion, create `.planning/phases/33-type-safety-critical-fixes/33-02-SUMMARY.md`
</output>
