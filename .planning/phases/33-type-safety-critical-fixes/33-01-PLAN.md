---
phase: 33-type-safety-critical-fixes
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/settings/AISettingsModal.tsx
  - src/lib/ai-bulk.ts
  - src/components/settings/ProviderCard.tsx
autonomous: true
requirements: [FIX-01]
gap_closure: true

must_haves:
  truths:
    - "Zero `as any` casts remain in AISettingsModal provider selection"
    - "`ticket: any` in ai-bulk.ts replaced with Zod-inferred type"
    - "ProviderCard color lookup uses typed Map or exhaustive record, not string index with silent fallback"
    - "`pnpm build` passes with zero TypeScript errors"
  artifacts:
    - path: "src/components/settings/AISettingsModal.tsx"
      provides: "Type-safe provider selection using isBuiltInProvider guard"
      contains: "isBuiltInProvider"
    - path: "src/lib/ai-bulk.ts"
      provides: "Zod-inferred ticket type in map callback"
      contains: "BulkGenerateResponse"
    - path: "src/components/settings/ProviderCard.tsx"
      provides: "Type-safe color lookup with BuiltInProviderId key"
      contains: "BuiltInProviderId"
  key_links:
    - from: "src/components/settings/AISettingsModal.tsx"
      to: "src/lib/ai-provider-registry.ts"
      via: "isBuiltInProvider type guard import"
      pattern: "isBuiltInProvider"
    - from: "src/lib/ai-bulk.ts"
      to: "src/types/ai.ts"
      via: "BulkGenerateResponse type import"
      pattern: "BulkGenerateResponse"
    - from: "src/components/settings/ProviderCard.tsx"
      to: "src/types/aiProvider.ts"
      via: "BuiltInProviderId type import"
      pattern: "BuiltInProviderId"
---

<objective>
Eliminate all `as any` casts and untyped parameters in AI provider selection, bulk extraction mapping, and provider card color lookup.

Purpose: Close SMELL-001, SMELL-002, SMELL-003 — replace runtime-unsafe type casts with proper compile-time type guards so TypeScript catches property typos and invalid provider IDs.
Output: Three files with zero `as any` casts and fully type-safe provider/ticket handling.
</objective>

<execution_context>
@C:/Users/Boris/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Boris/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/components/settings/AISettingsModal.tsx
@src/lib/ai-bulk.ts
@src/components/settings/ProviderCard.tsx
@src/types/aiProvider.ts
@src/lib/ai-provider-registry.ts
@src/types/ai.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Type-safe provider selection in AISettingsModal and ProviderCard color lookup</name>
  <files>src/components/settings/AISettingsModal.tsx, src/components/settings/ProviderCard.tsx</files>
  <action>
**AISettingsModal.tsx (SMELL-001):**

1. Add import: `import { isBuiltInProvider } from '../../lib/ai-provider-registry';`
2. Add import: `import type { BuiltInProviderId } from '../../types/aiProvider';`
3. Replace the `handleProviderSelect` function (lines 60-63):

```typescript
const handleProviderSelect = (providerId: string) => {
  if (!isBuiltInProvider(providerId)) return; // guard against unknown IDs
  const validId = providerId as BuiltInProviderId;
  setSelectedProvider(validId);
  setProvider(validId);
};
```

This replaces `providerId as any` with a proper runtime type guard (`isBuiltInProvider`) followed by a safe narrowing cast. The `isBuiltInProvider` function already exists in `ai-provider-registry.ts` and checks against `BUILT_IN_PROVIDERS`.

**ProviderCard.tsx (SMELL-003):**

1. Add import: `import type { BuiltInProviderId } from '../../types/aiProvider';`
2. Replace the untyped color lookup (lines 53-57) with a typed record:

```typescript
const PROVIDER_COLORS: Record<BuiltInProviderId, { border: string; bg: string; text: string; icon: string }> = {
  groq: { border: 'border-orange-500', bg: 'bg-orange-50', text: 'text-orange-700', icon: 'text-orange-600' },
  gemini: { border: 'border-blue-500', bg: 'bg-blue-50', text: 'text-blue-700', icon: 'text-blue-600' },
  openai: { border: 'border-emerald-500', bg: 'bg-emerald-50', text: 'text-emerald-700', icon: 'text-emerald-600' },
};
```

Move this to **module scope** (outside the component, above the `ProviderCard` function) to avoid re-creating on every render.

3. Inside the component, replace the current `const colors = { ... }[provider.id] || fallback` with:

```typescript
const fallbackColors = { border: 'border-purple-500', bg: 'bg-purple-50', text: 'text-purple-700', icon: 'text-purple-600' };
const colors = (provider.id in PROVIDER_COLORS)
  ? PROVIDER_COLORS[provider.id as BuiltInProviderId]
  : fallbackColors;
```

This uses `in` operator as a type guard before accessing the typed record, eliminating the string-index silent fallback.
  </action>
  <verify>Run `pnpm build` — must pass with zero TypeScript errors. Grep for `as any` in both files — must return zero matches.</verify>
  <done>AISettingsModal has zero `as any` casts; ProviderCard uses `Record<BuiltInProviderId, ...>` with explicit type guard; `pnpm build` passes.</done>
</task>

<task type="auto">
  <name>Task 2: Replace `ticket: any` with Zod-inferred type in ai-bulk.ts</name>
  <files>src/lib/ai-bulk.ts</files>
  <action>
**ai-bulk.ts (SMELL-002):**

1. Add import at the top of the file (alongside existing `BulkGenerateResponseSchema` import from `'../types/ai'`):

```typescript
import { BulkGenerateResponseSchema, type BulkGenerateResponse } from '../types/ai';
```

Note: `BulkGenerateResponse` is already exported from `src/types/ai.ts` as `z.infer<typeof BulkGenerateResponseSchema>`.

2. Replace the mapping on line 670:

Change:
```typescript
const proposals: BulkProposal[] = result.data.tickets.map((ticket: any, index: number) => ({
```

To:
```typescript
const proposals: BulkProposal[] = result.data.tickets.map((ticket, index) => ({
```

Since `result.data` is typed by `BulkGenerateResponseSchema` (the `generateCompletionWithRetry` function returns `{ data: z.infer<typeof Schema> }`), `ticket` will be automatically inferred as `z.infer<typeof GenerateItemResponseSchema>`. Remove the explicit `: any` annotation entirely — TypeScript will infer the correct type from the array element.

3. If TypeScript cannot infer the type from `result.data` (because `generateCompletionWithRetry` returns a generic), use the explicit type:

```typescript
type BulkTicket = BulkGenerateResponse['tickets'][number];
const proposals: BulkProposal[] = result.data.tickets.map((ticket: BulkTicket, index: number) => ({
```

Verify that all property accesses on `ticket` (title, description, userStory, specs, criteria, suggestedType, suggestedPriority, suggestedSeverity, suggestedEffort, suggestedModule, emoji, dependencies, constraints) are valid against the Zod schema. They should all match — the schema defines these exact fields.
  </action>
  <verify>Run `pnpm build` — must pass with zero TypeScript errors. Grep for `ticket: any` in ai-bulk.ts — must return zero matches.</verify>
  <done>`ticket: any` replaced with Zod-inferred type; TypeScript catches property typos at compile time; `pnpm build` passes.</done>
</task>

</tasks>

<verification>
1. `pnpm build` passes with zero errors
2. `grep -rn "as any" src/components/settings/AISettingsModal.tsx` → 0 results
3. `grep -rn "ticket: any" src/lib/ai-bulk.ts` → 0 results
4. `grep -rn "as any" src/components/settings/ProviderCard.tsx` → 0 results (was already 0, confirm no regressions)
</verification>

<success_criteria>
- Zero `as any` casts in AISettingsModal provider selection code
- `ticket: any` in ai-bulk.ts replaced with Zod-inferred type
- ProviderCard color lookup uses `Record<BuiltInProviderId, ...>` with type guard
- All three files compile without TypeScript errors
- `pnpm build` passes clean
</success_criteria>

<output>
After completion, create `.planning/phases/33-type-safety-critical-fixes/33-01-SUMMARY.md`
</output>
