---
phase: 33-type-safety-critical-fixes
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/settings/AISettingsModal.tsx
  - src/lib/ai-bulk.ts
  - src/components/settings/ProviderCard.tsx
  - src/lib/ai-provider-registry.ts
autonomous: true
requirements: [FIX-01]
gap_closure: true

must_haves:
  truths:
    - "Zero `as any` casts remain in AISettingsModal provider selection"
    - "`ticket: any` in ai-bulk.ts replaced with Zod-inferred type"
    - "ProviderCard color lookup uses typed Map or exhaustive record, not string index with silent fallback"
    - "`isBuiltInProvider` is a type predicate — no residual `as BuiltInProviderId` cast needed"
    - "AISettingsModal uses STORAGE_KEYS.QUESTIONING_MODE instead of hardcoded string"
    - "`pnpm build` passes with zero TypeScript errors"
  artifacts:
    - path: "src/components/settings/AISettingsModal.tsx"
      provides: "Type-safe provider selection using isBuiltInProvider type predicate + STORAGE_KEYS import"
      contains: "isBuiltInProvider"
    - path: "src/lib/ai-provider-registry.ts"
      provides: "isBuiltInProvider upgraded to type predicate (id is BuiltInProviderId)"
      contains: "id is BuiltInProviderId"
    - path: "src/lib/ai-bulk.ts"
      provides: "Zod-inferred ticket type in map callback"
      contains: "BulkGenerateResponse"
    - path: "src/components/settings/ProviderCard.tsx"
      provides: "Type-safe color lookup with BuiltInProviderId key"
      contains: "BuiltInProviderId"
  key_links:
    - from: "src/components/settings/AISettingsModal.tsx"
      to: "src/lib/ai-provider-registry.ts"
      via: "isBuiltInProvider type predicate import"
      pattern: "isBuiltInProvider"
    - from: "src/components/settings/AISettingsModal.tsx"
      to: "src/constants/storage.ts"
      via: "STORAGE_KEYS.QUESTIONING_MODE import"
      pattern: "STORAGE_KEYS\\.QUESTIONING_MODE"
    - from: "src/lib/ai-bulk.ts"
      to: "src/types/ai.ts"
      via: "BulkGenerateResponse type import"
      pattern: "BulkGenerateResponse"
    - from: "src/components/settings/ProviderCard.tsx"
      to: "src/types/aiProvider.ts"
      via: "BuiltInProviderId type import"
      pattern: "BuiltInProviderId"
---

<objective>
Eliminate all `as any` casts and untyped parameters in AI provider selection, bulk extraction mapping, and provider card color lookup.

Purpose: Close SMELL-001, SMELL-002, SMELL-003 — replace runtime-unsafe type casts with proper compile-time type guards so TypeScript catches property typos and invalid provider IDs.
Output: Four files with zero `as any` casts, a type predicate for `isBuiltInProvider`, and centralized storage keys in AISettingsModal.
</objective>

<execution_context>
@C:/Users/Boris/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Boris/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/components/settings/AISettingsModal.tsx
@src/lib/ai-bulk.ts
@src/components/settings/ProviderCard.tsx
@src/types/aiProvider.ts
@src/lib/ai-provider-registry.ts
@src/types/ai.ts
@src/constants/storage.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Type-safe provider selection in AISettingsModal, ProviderCard color lookup, type predicate upgrade, and storage key centralization</name>
  <files>src/lib/ai-provider-registry.ts, src/components/settings/AISettingsModal.tsx, src/components/settings/ProviderCard.tsx</files>
  <action>
**ai-provider-registry.ts (type predicate upgrade):**

1. Change the `isBuiltInProvider` signature from returning `boolean` to a type predicate:

Change:
```typescript
export function isBuiltInProvider(id: string): boolean {
```

To:
```typescript
export function isBuiltInProvider(id: string): id is BuiltInProviderId {
```

The function body remains unchanged — it already checks `BUILT_IN_PROVIDERS.some(p => p.id === id)`. The type predicate tells TypeScript to narrow the type automatically after the guard check.

**AISettingsModal.tsx (SMELL-001 + DEAD-008 storage keys):**

1. Add import: `import { isBuiltInProvider } from '../../lib/ai-provider-registry';`
2. Add import: `import { STORAGE_KEYS } from '../../constants/storage';`
3. Replace the `handleProviderSelect` function (lines 60-63):

```typescript
const handleProviderSelect = (providerId: string) => {
  if (!isBuiltInProvider(providerId)) return; // guard narrows to BuiltInProviderId
  setSelectedProvider(providerId);
  setProvider(providerId);
};
```

Because `isBuiltInProvider` is now a type predicate (`id is BuiltInProviderId`), after the guard check TypeScript automatically narrows `providerId` to `BuiltInProviderId`. No `as` cast is needed at all.

4. Replace hardcoded storage key on line 33:
   - `localStorage.getItem('ticketflow-questioning-mode')` → `localStorage.getItem(STORAGE_KEYS.QUESTIONING_MODE)`
5. Replace hardcoded storage key on line 57:
   - `localStorage.setItem('ticketflow-questioning-mode', ...)` → `localStorage.setItem(STORAGE_KEYS.QUESTIONING_MODE, ...)`

**ProviderCard.tsx (SMELL-003):**

1. Add import: `import type { BuiltInProviderId } from '../../types/aiProvider';`
2. Replace the untyped color lookup (lines 53-57) with a typed record:

```typescript
const PROVIDER_COLORS: Record<BuiltInProviderId, { border: string; bg: string; text: string; icon: string }> = {
  groq: { border: 'border-orange-500', bg: 'bg-orange-50', text: 'text-orange-700', icon: 'text-orange-600' },
  gemini: { border: 'border-blue-500', bg: 'bg-blue-50', text: 'text-blue-700', icon: 'text-blue-600' },
  openai: { border: 'border-emerald-500', bg: 'bg-emerald-50', text: 'text-emerald-700', icon: 'text-emerald-600' },
};
```

Move this to **module scope** (outside the component, above the `ProviderCard` function) to avoid re-creating on every render.

3. Inside the component, replace the current `const colors = { ... }[provider.id] || fallback` with:

```typescript
const fallbackColors = { border: 'border-purple-500', bg: 'bg-purple-50', text: 'text-purple-700', icon: 'text-purple-600' };
const colors = (provider.id in PROVIDER_COLORS)
  ? PROVIDER_COLORS[provider.id as BuiltInProviderId]
  : fallbackColors;
```

This uses `in` operator as a type guard before accessing the typed record, eliminating the string-index silent fallback.
  </action>
  <verify>Run `pnpm build` — must pass with zero TypeScript errors. Grep for `as any` in both files — must return zero matches. Grep for `id is BuiltInProviderId` in ai-provider-registry.ts — must find the type predicate. Grep for `'ticketflow-questioning-mode'` in AISettingsModal.tsx — must return zero matches.</verify>
  <done>AISettingsModal has zero `as any` casts and uses STORAGE_KEYS for questioning mode; `isBuiltInProvider` is a type predicate eliminating residual casts; ProviderCard uses `Record<BuiltInProviderId, ...>` with explicit type guard; `pnpm build` passes.</done>
</task>

<task type="auto">
  <name>Task 2: Replace `ticket: any` with Zod-inferred type in ai-bulk.ts</name>
  <files>src/lib/ai-bulk.ts</files>
  <action>
**ai-bulk.ts (SMELL-002):**

1. Add import at the top of the file (alongside existing `BulkGenerateResponseSchema` import from `'../types/ai'`):

```typescript
import { BulkGenerateResponseSchema, type BulkGenerateResponse } from '../types/ai';
```

Note: `BulkGenerateResponse` is already exported from `src/types/ai.ts` as `z.infer<typeof BulkGenerateResponseSchema>`.

2. Replace the mapping on line 670:

Change:
```typescript
const proposals: BulkProposal[] = result.data.tickets.map((ticket: any, index: number) => ({
```

To:
```typescript
const proposals: BulkProposal[] = result.data.tickets.map((ticket, index) => ({
```

Since `result.data` is typed by `BulkGenerateResponseSchema` (the `generateCompletionWithRetry` function returns `{ data: z.infer<typeof Schema> }`), `ticket` will be automatically inferred as `z.infer<typeof GenerateItemResponseSchema>`. Remove the explicit `: any` annotation entirely — TypeScript will infer the correct type from the array element.

3. If TypeScript cannot infer the type from `result.data` (because `generateCompletionWithRetry` returns a generic), use the explicit type:

```typescript
type BulkTicket = BulkGenerateResponse['tickets'][number];
const proposals: BulkProposal[] = result.data.tickets.map((ticket: BulkTicket, index: number) => ({
```

Verify that all property accesses on `ticket` (title, description, userStory, specs, criteria, suggestedType, suggestedPriority, suggestedSeverity, suggestedEffort, suggestedModule, emoji, dependencies, constraints) are valid against the Zod schema. They should all match — the schema defines these exact fields.
  </action>
  <verify>Run `pnpm build` — must pass with zero TypeScript errors. Grep for `ticket: any` in ai-bulk.ts — must return zero matches.</verify>
  <done>`ticket: any` replaced with Zod-inferred type; TypeScript catches property typos at compile time; `pnpm build` passes.</done>
</task>

</tasks>

<verification>
1. `pnpm build` passes with zero errors
2. `grep -rn "as any" src/components/settings/AISettingsModal.tsx` → 0 results
3. `grep -rn "ticket: any" src/lib/ai-bulk.ts` → 0 results
4. `grep -rn "as any" src/components/settings/ProviderCard.tsx` → 0 results (was already 0, confirm no regressions)
5. `grep -rn "id is BuiltInProviderId" src/lib/ai-provider-registry.ts` → finds the type predicate
6. `grep -rn "'ticketflow-questioning-mode'" src/components/settings/AISettingsModal.tsx` → 0 results (replaced with STORAGE_KEYS)
</verification>

<success_criteria>
- Zero `as any` casts in AISettingsModal provider selection code
- `isBuiltInProvider` is a type predicate (`id is BuiltInProviderId`) — no residual cast needed
- AISettingsModal uses `STORAGE_KEYS.QUESTIONING_MODE` instead of hardcoded string
- `ticket: any` in ai-bulk.ts replaced with Zod-inferred type
- ProviderCard color lookup uses `Record<BuiltInProviderId, ...>` with type guard
- All four files compile without TypeScript errors
- `pnpm build` passes clean
</success_criteria>

<output>
After completion, create `.planning/phases/33-type-safety-critical-fixes/33-01-SUMMARY.md`
</output>
