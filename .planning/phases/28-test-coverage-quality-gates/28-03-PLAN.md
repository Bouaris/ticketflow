---
phase: 28-test-coverage-quality-gates
plan: 03
type: execute
wave: 2
depends_on: [28-01, 28-02]
files_modified:
  - .github/workflows/ci.yml
autonomous: true
requirements: [TINF-03]
must_haves:
  truths:
    - "A GitHub Actions CI workflow runs unit tests on every push to master"
    - "The CI workflow runs unit tests on every pull request targeting master"
    - "The CI workflow runs pnpm test:coverage which enforces the 70% threshold"
    - "The CI workflow is separate from release.yml (different trigger, different purpose)"
    - "pnpm test:coverage passes locally with all 4 module thresholds met"
  artifacts:
    - path: ".github/workflows/ci.yml"
      provides: "GitHub Actions CI workflow for tests and coverage"
      contains: "pnpm test:coverage"
  key_links:
    - from: ".github/workflows/ci.yml"
      to: "vitest.config.ts"
      via: "pnpm test:coverage reads thresholds from vitest config"
      pattern: "test:coverage"
    - from: ".github/workflows/ci.yml"
      to: "package.json"
      via: "pnpm install + pnpm test:coverage scripts"
      pattern: "pnpm install"
---

<objective>
Create a GitHub Actions CI workflow that runs unit tests and coverage checks on every push and PR to master, and validate that all coverage thresholds pass end-to-end.

Purpose: This is the final quality gate. The CI workflow ensures no regression can merge without passing tests and meeting the 70% coverage threshold on the 4 critical lib modules.

Output: `.github/workflows/ci.yml` workflow file, verified locally via `pnpm test:coverage` passing all thresholds.
</objective>

<execution_context>
@C:/Users/Boris/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Boris/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/28-test-coverage-quality-gates/28-RESEARCH.md
@.planning/phases/28-test-coverage-quality-gates/28-01-SUMMARY.md
@.planning/phases/28-test-coverage-quality-gates/28-02-SUMMARY.md

@.github/workflows/release.yml
@vitest.config.ts
@package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create GitHub Actions CI workflow</name>
  <files>.github/workflows/ci.yml</files>
  <action>
Create `.github/workflows/ci.yml` with the following configuration.

Mirror the existing `release.yml` patterns for pnpm/Node setup but with test-specific concerns:

```yaml
name: CI

on:
  push:
    branches: [master]
  pull_request:
    branches: [master]

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install

      - name: Run tests with coverage
        run: pnpm test:coverage
```

Key decisions:
- **ubuntu-latest** (not windows-latest): Tests run in jsdom environment, no OS-specific behavior. Ubuntu is faster and cheaper. The HTML reporter crash is Windows-only and already fixed (removed in Plan 01), but ubuntu avoids it entirely.
- **pnpm/action-setup@v2 + version: 9**: Matches existing release.yml pattern exactly.
- **Node 20**: Matches existing release.yml pattern.
- **cache: 'pnpm'**: Speeds up subsequent runs by caching the pnpm store.
- **pnpm test:coverage**: This single command runs all tests AND enforces the per-file coverage thresholds configured in vitest.config.ts. If any threshold fails, the command exits non-zero and the CI job fails.
- **No Rust toolchain needed**: Unlike release.yml, this workflow only runs JS tests — no Tauri build.
- **No coverage badge**: Skip for now (adds complexity with artifact upload and shields.io URL).
- **Separate from release.yml**: release.yml triggers on tag push only, this triggers on branch push/PR. Different triggers, different purposes.
  </action>
  <verify>Verify the YAML is valid: `python -c "import yaml; yaml.safe_load(open('.github/workflows/ci.yml'))"` or `node -e "const fs=require('fs'); const y=require('yaml'); y.parse(fs.readFileSync('.github/workflows/ci.yml','utf8')); console.log('Valid YAML')"` — if yaml module not available, just verify the file exists and has correct structure by reading it.</verify>
  <done>.github/workflows/ci.yml exists with push/PR triggers on master, pnpm 9 + Node 20 setup, and `pnpm test:coverage` step.</done>
</task>

<task type="auto">
  <name>Task 2: Validate all coverage thresholds pass locally</name>
  <files></files>
  <action>
Run the full test suite with coverage and verify end-to-end:

1. Run `pnpm test:coverage` and capture output
2. Verify ALL tests pass (zero failures)
3. Verify the coverage table shows:
   - `src/lib/parser.ts` — lines >= 70%
   - `src/lib/serializer.ts` — lines >= 70%
   - `src/lib/ai-retry.ts` — lines >= 70%
   - `src/lib/ai-health.ts` — lines >= 70%
4. Verify no threshold violation message (exit code 0)
5. Run `pnpm build` to confirm no TypeScript errors

If any threshold fails:
- Check which module is below 70%
- The issue is likely in Plan 02's test coverage — identify which functions/branches are not covered
- Add targeted tests to bring coverage above threshold
- Re-run `pnpm test:coverage` until all thresholds pass

This is the final validation that the CI workflow WOULD pass if run on GitHub Actions.
  </action>
  <verify>`pnpm test:coverage` exits with code 0. `pnpm build` exits with code 0. All 4 module thresholds met.</verify>
  <done>Full test suite passes with coverage. All 4 per-file thresholds at >= 70% lines. Build clean. CI workflow would pass.</done>
</task>

</tasks>

<verification>
1. `.github/workflows/ci.yml` exists and is valid YAML
2. CI workflow triggers on push to master AND pull_request to master
3. CI workflow runs `pnpm test:coverage` (not just `pnpm test`)
4. CI workflow is completely separate from `release.yml` (different file, different triggers)
5. `pnpm test:coverage` passes locally with exit code 0
6. All 4 module thresholds met: parser >= 70%, serializer >= 70%, ai-retry >= 70%, ai-health >= 70%
7. `pnpm build` passes
</verification>

<success_criteria>
- .github/workflows/ci.yml runs tests+coverage on push/PR to master
- pnpm test:coverage exits 0 with all 4 per-file thresholds met
- pnpm build passes
- No regressions — all existing tests still pass
</success_criteria>

<output>
After completion, create `.planning/phases/28-test-coverage-quality-gates/28-03-SUMMARY.md`
</output>
