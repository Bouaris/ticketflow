---
phase: 28-test-coverage-quality-gates
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/__tests__/parser.test.ts
  - src/__tests__/serializer.test.ts
  - vitest.config.ts
autonomous: true
requirements: [TCOV-01, TCOV-02, TINF-04]
must_haves:
  truths:
    - "Parser tests cover idempotency invariant: parse(serialize(parse(md))) deepEquals parse(md)"
    - "Parser tests cover fused section separators (---## pattern)"
    - "Parser tests cover empty sections without items"
    - "Parser tests cover Unicode content (accents, special characters)"
    - "Serializer tests cover serialize(parse(md)) round-trip invariant"
    - "Serializer tests cover parse(serialize(parse(md))) idempotency invariant"
    - "Vitest coverage thresholds are configured at 70% lines for parser.ts, serializer.ts, ai-retry.ts, ai-health.ts"
    - "pnpm test:coverage does not crash on Windows (HTML reporter removed)"
  artifacts:
    - path: "src/__tests__/parser.test.ts"
      provides: "Round-trip and edge case parser tests"
      contains: "parse(serialize(parse"
    - path: "src/__tests__/serializer.test.ts"
      provides: "Round-trip idempotency serializer tests"
      contains: "serialize(parse"
    - path: "vitest.config.ts"
      provides: "Per-file 70% line coverage thresholds"
      contains: "thresholds"
  key_links:
    - from: "vitest.config.ts"
      to: "src/lib/parser.ts"
      via: "coverage threshold config"
      pattern: "parser\\.ts.*lines.*70"
    - from: "vitest.config.ts"
      to: "src/lib/serializer.ts"
      via: "coverage threshold config"
      pattern: "serializer\\.ts.*lines.*70"
---

<objective>
Augment existing parser and serializer test suites with the specific edge-case tests and round-trip invariants required by TCOV-01/TCOV-02, and configure Vitest per-file coverage thresholds at 70% lines for the four critical lib modules.

Purpose: Parser and serializer already have partial test suites (85%/94% line coverage). This plan adds the SPECIFIC tests mandated by the requirements (idempotency, Unicode, fused separators, empty sections) and wires up the threshold enforcement.

Output: Augmented parser.test.ts and serializer.test.ts with 6+ new tests, vitest.config.ts with per-file thresholds and Windows crash fix.
</objective>

<execution_context>
@C:/Users/Boris/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Boris/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/28-test-coverage-quality-gates/28-RESEARCH.md

@src/__tests__/parser.test.ts
@src/__tests__/serializer.test.ts
@src/lib/parser.ts
@src/lib/serializer.ts
@vitest.config.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Augment parser.test.ts with round-trip and edge case tests</name>
  <files>src/__tests__/parser.test.ts</files>
  <action>
Add a new describe block at the end of parser.test.ts titled "parseBacklog - Round-Trip & Edge Cases" with these tests (continue numbering from 29):

**Test 29: parse(serialize(parse(md))) idempotency invariant**
- Use the existing `MULTI_SECTION_BACKLOG` fixture
- Parse it once: `const result1 = parseBacklog(MULTI_SECTION_BACKLOG)`
- Import `serializeBacklog` from `../lib/serializer`
- Serialize: `const serialized = serializeBacklog(result1)`
- Re-parse: `const result2 = parseBacklog(serialized)`
- Assert: `result2.sections.length === result1.sections.length`
- Assert: `getAllItems(result2).map(i => i.id)` deepEquals `getAllItems(result1).map(i => i.id)`
- For each item pair, assert title and description match

**Test 30: handles Unicode content in titles and descriptions**
- Create a fixture with Unicode: `# Backlog\n\n## 1. BUGS\n\n### BUG-001 | Probleme d'encodage UTF-8\n**Description:** Texte avec accents eaue et caracteres speciaux: euro sign, copyright, registered\n\n---\n`
- Parse and assert item exists, description contains the special characters
- Also test that the title parses correctly with the apostrophe

**Test 31: handles fused section separators (---## pattern)**
- Create a fixture: `# Backlog\n\n---## 1. BUGS\n\n### BUG-001 | Fused test\n**Description:** Test\n\n---\n`
- Parse and assert sections.length >= 1
- Assert the section title is 'BUGS' and the item parses correctly

**Test 32: handles empty sections without items**
- Create fixture with two sections where the first has no items:
  ```
  # Backlog\n\n## 1. EMPTY SECTION\n\n## 2. FEATURES\n\n### CT-001 | Feature\n**Description:** Test\n\n---\n
  ```
- Parse and assert sections.length === 2
- Assert first section has zero BacklogItem entries (filter out raw-section/table-group types)
- Assert second section has one item with id CT-001

NOTE: Import `serializeBacklog` from `../lib/serializer` at the top of the file (add to existing imports).
  </action>
  <verify>Run `pnpm test src/__tests__/parser.test.ts` — all 32 tests pass (28 existing + 4 new).</verify>
  <done>Parser test file has 4 new tests covering idempotency invariant, Unicode, fused separators, and empty sections — all passing.</done>
</task>

<task type="auto">
  <name>Task 2: Augment serializer.test.ts with round-trip tests and configure coverage thresholds</name>
  <files>src/__tests__/serializer.test.ts, vitest.config.ts</files>
  <action>
**Part A — serializer.test.ts: Add round-trip invariant tests**

Add a new describe block at the end of serializer.test.ts titled "Round-Trip Invariants" with these tests (continue numbering from 26):

**Test 26: serialize(parse(md)) produces valid markdown that re-parses identically**
- Import `parseBacklog, getAllItems` from `../lib/parser`
- Define a multi-section markdown fixture (or reuse existing createMinimalBacklog approach but with actual markdown string)
- Parse: `const parsed = parseBacklog(md)`
- Serialize: `const serialized = serializeBacklog(parsed)`
- Re-parse: `const reparsed = parseBacklog(serialized)`
- Assert: section count matches
- Assert: item IDs match (using getAllItems)

**Test 27: parse(serialize(parse(md))) idempotency — item data is stable across cycles**
- Parse a markdown string with multiple items across sections
- Serialize, re-parse
- For each item: assert title, type, id match between first parse and second parse
- This proves the serialize->parse cycle is stable (no data drift)

**Part B — vitest.config.ts: Configure per-file coverage thresholds**

1. Change the `reporter` array from `['text', 'json', 'html']` to `['text', 'json']` — this fixes the Windows HTML reporter crash (TypeError: input.replace is not a function in pathe v2).

2. Add a `thresholds` property inside the existing `coverage` config:
```typescript
thresholds: {
  'src/lib/parser.ts': { lines: 70, functions: 70 },
  'src/lib/serializer.ts': { lines: 70, functions: 70 },
  'src/lib/ai-retry.ts': { lines: 70, functions: 70 },
  'src/lib/ai-health.ts': { lines: 70, functions: 70 },
},
```

This uses Vitest 4's per-glob threshold support. The threshold is scoped to these 4 specific files, not the entire src/lib/ directory (which includes untestable Tauri-coupled modules at 0%).

NOTE: The ai-retry.ts and ai-health.ts thresholds will initially fail until Plan 02 adds their test files. This is expected — Plan 03 does the final validation. The threshold config must be in place NOW so Plan 02's executor sees the threshold requirement.
  </action>
  <verify>
Run `pnpm test src/__tests__/serializer.test.ts` — all 27 tests pass (25 existing + 2 new).
Run `pnpm test:coverage 2>&1 | head -5` — no HTML reporter crash (exits normally, may show threshold failures for ai-retry/ai-health which is expected until Plan 02).
  </verify>
  <done>Serializer test file has 2 new round-trip tests passing. vitest.config.ts has per-file 70% thresholds for 4 modules and no HTML reporter. `pnpm test:coverage` no longer crashes on Windows.</done>
</task>

</tasks>

<verification>
1. `pnpm test src/__tests__/parser.test.ts` — 32 tests pass
2. `pnpm test src/__tests__/serializer.test.ts` — 27 tests pass
3. `pnpm test:coverage` — runs without crash, shows coverage table with thresholds section
4. Parser coverage >= 70% lines, serializer coverage >= 70% lines (both already above threshold)
5. `pnpm build` — passes (no TypeScript errors from new imports)
</verification>

<success_criteria>
- Parser test file has tests numbered 29-32 covering: idempotency, Unicode, fused separators, empty sections
- Serializer test file has tests numbered 26-27 covering: round-trip and idempotency invariants
- vitest.config.ts has per-file thresholds at 70% for parser, serializer, ai-retry, ai-health
- vitest.config.ts reporters are ['text', 'json'] (no 'html')
- All existing tests still pass (zero regressions)
</success_criteria>

<output>
After completion, create `.planning/phases/28-test-coverage-quality-gates/28-01-SUMMARY.md`
</output>
