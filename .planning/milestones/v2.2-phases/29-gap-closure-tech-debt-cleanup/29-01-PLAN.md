---
phase: 29-gap-closure-tech-debt-cleanup
plan: "01"
type: execute
wave: 1
depends_on: []
files_modified:
  - src-tauri/src/telemetry.rs
  - .planning/phases/26-infrastructure-transport-foundation/26-02-SUMMARY.md
autonomous: true
requirements: []
gap_closure: true
must_haves:
  truths:
    - "startup_flush delivers queued offline events on app startup when VITE_POSTHOG_KEY is set at build time"
    - "BatchPayload struct no longer exists in telemetry.rs — zero dead Rust code"
    - "26-02-SUMMARY.md frontmatter includes requirements-completed listing TELE-04 and TELE-08"
    - "All 17 REQUIREMENTS.md checkboxes are [x] (verified, no edit needed)"
  artifacts:
    - path: "src-tauri/src/telemetry.rs"
      provides: "Fixed startup_flush with compile-time POSTHOG_API_KEY, BatchPayload removed"
      contains: "option_env!"
    - path: ".planning/phases/26-infrastructure-transport-foundation/26-02-SUMMARY.md"
      provides: "requirements-completed frontmatter field"
      contains: "requirements-completed"
  key_links:
    - from: "src-tauri/src/telemetry.rs (POSTHOG_API_KEY const)"
      to: "flush_queue call in startup_flush"
      via: "option_env! macro reads VITE_POSTHOG_KEY at compile time"
      pattern: "option_env!.*VITE_POSTHOG_KEY"
---

<objective>
Fix the startup_flush no-op bug so queued offline telemetry events are actually delivered on app launch, remove the dead BatchPayload struct, and update stale documentation frontmatter.

Purpose: Close all tech debt items from the v2.2 milestone audit — one functional gap (startup_flush always passes empty api_key to flush_queue) and documentation gaps (missing SUMMARY frontmatter).

Output: Clean telemetry.rs with working startup flush, accurate 26-02-SUMMARY.md frontmatter.
</objective>

<execution_context>
@C:/Users/Boris/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Boris/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/29-gap-closure-tech-debt-cleanup/29-RESEARCH.md
@src-tauri/src/telemetry.rs
@.planning/phases/26-infrastructure-transport-foundation/26-02-SUMMARY.md
@.planning/REQUIREMENTS.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix startup_flush and remove dead BatchPayload struct</name>
  <files>src-tauri/src/telemetry.rs</files>
  <action>
Three changes in `src-tauri/src/telemetry.rs`:

1. **Add compile-time API key constant** after the existing constants block (after line 12, before the Types section):
```rust
/// PostHog API key read at compile time from VITE_POSTHOG_KEY env var.
/// `None` when the env var is not set (dev builds without telemetry).
const POSTHOG_API_KEY: Option<&str> = option_env!("VITE_POSTHOG_KEY");
```

2. **Replace the `startup_flush` function body** (lines 160-168). Replace the current implementation that passes `""` to `flush_queue` with:
```rust
pub async fn startup_flush(state: tauri::State<'_, TelemetryState>) {
    let Some(api_key) = POSTHOG_API_KEY else {
        return; // No key compiled in — graceful no-op (dev/test without key)
    };
    if api_key.is_empty() {
        return;
    }
    let client = reqwest::Client::new();
    flush_queue(&state.pool, &client, &state.api_host, api_key).await;
}
```

3. **Delete the `BatchPayload` struct** (lines 37-42, including the doc comment on line 37):
```rust
/// The batch payload accepted by the `ph_send_batch` command.
#[derive(Debug, Deserialize)]
pub struct BatchPayload {
    pub events: Vec<PhEvent>,
    pub api_key: String,
}
```
This struct is defined but never referenced anywhere in the codebase. The `ph_send_batch` command uses flat parameters (`events: Vec<PhEvent>, api_key: String`) directly.

Also remove the blank line that follows the deleted struct to keep spacing clean.

**Do NOT modify** `flush_queue`, `queue_events`, `ph_send_batch`, or any other function — only the three changes above.
  </action>
  <verify>
Run `pnpm build` from the project root to verify TypeScript compilation still passes (no frontend regression).

Then verify the Rust code compiles by checking the telemetry.rs file contains:
- `const POSTHOG_API_KEY: Option<&str> = option_env!("VITE_POSTHOG_KEY");`
- `startup_flush` uses `POSTHOG_API_KEY` (not `""`)
- `BatchPayload` struct is absent

Use grep to confirm `BatchPayload` appears nowhere in the codebase:
```bash
grep -r "BatchPayload" src-tauri/
```
Should return zero results.
  </verify>
  <done>
`startup_flush` reads the PostHog API key from `option_env!("VITE_POSTHOG_KEY")` and passes it to `flush_queue` — queued offline events are delivered on app startup when the key is compiled in. The dead `BatchPayload` struct is removed. `pnpm build` passes.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update 26-02-SUMMARY.md frontmatter and verify REQUIREMENTS.md</name>
  <files>.planning/phases/26-infrastructure-transport-foundation/26-02-SUMMARY.md</files>
  <action>
Two actions:

1. **Add `requirements-completed` field to 26-02-SUMMARY.md frontmatter.** Insert `requirements-completed: [TELE-04, TELE-08]` inside the YAML frontmatter block (between the `---` delimiters). Place it after the `decisions` list and before the `metrics` block:

```yaml
decisions:
  - "Separate telemetry.db avoids schema coupling with tauri-plugin-sql which has no Rust-side API"
  - "reqwest with rustls-tls and default-features = false avoids native-tls dependency"
  - "startup_flush skips delivery when api_key is empty — key comes from frontend per-batch"
  - "WAL journal mode on telemetry.db ensures crash-safe persistence"
  - "mockIPC payload typed as InvokeArgs (not Record<string, unknown>) to match @tauri-apps/api types"
requirements-completed: [TELE-04, TELE-08]
metrics:
```

Do NOT modify any other part of the file.

2. **Verify REQUIREMENTS.md** — Read `.planning/REQUIREMENTS.md` and confirm all 17 checkboxes (TELE-01 through TELE-08, TINF-01 through TINF-04, TCOV-01 through TCOV-05) are `[x]`. This is a read-only verification — research confirmed all are already checked. No edit should be needed.
  </action>
  <verify>
Read `26-02-SUMMARY.md` and confirm `requirements-completed: [TELE-04, TELE-08]` appears inside the frontmatter block.

Read `REQUIREMENTS.md` and count `[x]` occurrences — should be exactly 17 in the v2.2 section. Count `[ ]` occurrences — should be 0 in the v2.2 section.
  </verify>
  <done>
`26-02-SUMMARY.md` has `requirements-completed: [TELE-04, TELE-08]` in its frontmatter. All 17 REQUIREMENTS.md checkboxes are confirmed `[x]`.
  </done>
</task>

</tasks>

<verification>
1. `src-tauri/src/telemetry.rs` contains `option_env!("VITE_POSTHOG_KEY")` near the top constants
2. `startup_flush` function uses `POSTHOG_API_KEY` variable, NOT an empty string `""`
3. `BatchPayload` does not appear anywhere in `src-tauri/`
4. `pnpm build` exits 0
5. `26-02-SUMMARY.md` frontmatter contains `requirements-completed: [TELE-04, TELE-08]`
6. All 17 v2.2 requirement checkboxes in REQUIREMENTS.md are `[x]`
</verification>

<success_criteria>
- startup_flush uses compile-time POSTHOG_API_KEY from option_env! to flush queued events
- BatchPayload struct is deleted from telemetry.rs
- 26-02-SUMMARY.md has requirements-completed frontmatter field
- REQUIREMENTS.md has all 17 checkboxes marked [x]
- pnpm build passes without errors
</success_criteria>

<output>
After completion, create `.planning/phases/29-gap-closure-tech-debt-cleanup/29-01-SUMMARY.md`
</output>
