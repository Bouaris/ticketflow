---
phase: 24-validation-generation-ux
plan: 03
type: execute
wave: 2
depends_on: [24-02]
files_modified:
  - src/components/editor/ItemEditorModal.tsx
  - src/components/editor/AIGenerationMode.tsx
  - src/i18n/types.ts
  - src/i18n/locales/en.ts
  - src/i18n/locales/fr.ts
autonomous: true

must_haves:
  truths:
    - "User sees loading spinner and progress text during AI generation (not silent operation)"
    - "Progress text cycles through 3 stages: analyzing, generating structure, finalizing"
    - "User can cancel in-flight AI generation with a visible Cancel button"
    - "Cancellation triggers AbortController.abort() which propagates through ai.ts signal to SDK"
    - "Cancelled operations do NOT show error toast (isAbortError check)"
    - "Provider selector in ticket creation modal overrides default provider in the generation call"
    - "AI errors display user-friendly messages with retry option"
    - "All new UI strings are internationalized (FR + EN)"
  artifacts:
    - path: "src/components/editor/AIGenerationMode.tsx"
      provides: "Progress text display and enhanced cancel button"
    - path: "src/components/editor/ItemEditorModal.tsx"
      provides: "Signal propagation to generateItemFromDescription, error feedback with retry"
    - path: "src/i18n/types.ts"
      provides: "New i18n keys for generation UX"
    - path: "src/i18n/locales/en.ts"
      provides: "English translations for generation UX"
    - path: "src/i18n/locales/fr.ts"
      provides: "French translations for generation UX"
  key_links:
    - from: "src/components/editor/ItemEditorModal.tsx"
      to: "src/lib/ai.ts generateItemFromDescription"
      via: "signal from AbortController passed in options"
      pattern: "signal.*controller.*signal"
    - from: "src/components/editor/ItemEditorModal.tsx"
      to: "src/lib/abort.ts isAbortError"
      via: "Error handling distinguishes cancellation from real errors"
      pattern: "isAbortError"
    - from: "src/components/editor/AIGenerationMode.tsx"
      to: "ItemEditorModal"
      via: "progressText prop and onCancel callback"
      pattern: "progressText|onCancel"
---

<objective>
Implement the generation UX improvements: progress text during AI operations, proper cancel button wiring through AbortSignal, provider override fix, error feedback with retry, and complete i18n for Phase 24.

Purpose: Fulfill GENX-01 (loading/progress), GENX-02 (cancel), GENX-03 (provider override), GENX-05 (error messages with retry), and INTL-03 (i18n keys). This is the user-facing UX layer that ties together the infrastructure from Plans 01 and 02.

Output: Enhanced generation flow with visible progress, cancellation, error feedback, and full i18n.
</objective>

<execution_context>
@C:/Users/Boris/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Boris/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/24-validation-generation-ux/24-RESEARCH.md
@.planning/phases/24-validation-generation-ux/24-02-SUMMARY.md
@src/components/editor/ItemEditorModal.tsx
@src/components/editor/AIGenerationMode.tsx
@src/lib/abort.ts
@src/i18n/types.ts
@src/i18n/locales/en.ts
@src/i18n/locales/fr.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add progress text, cancel wiring, error feedback, and provider override fix in editor components</name>
  <files>
    src/components/editor/ItemEditorModal.tsx
    src/components/editor/AIGenerationMode.tsx
  </files>
  <action>
**Part A: Update AIGenerationMode.tsx**

1. **Add `progressText` prop** to `AIGenerationModeProps`:
   ```typescript
   /** Progress text shown during generation */
   progressText?: string | null;
   ```

2. **Update the generating state UI** in the action buttons section. Currently (around line 144-155), the generate button shows `<Spinner size="sm" color="white" /> {t.ai.generating}` when `isGenerating`. Replace the generating display to include progress text:
   ```tsx
   {isGenerating ? (
     <>
       <Spinner size="sm" color="white" />
       {progressText || t.ai.generating}
     </>
   ) : (
     <>
       <SparklesIcon />
       {t.ai.generateWith} {getProviderLabel(provider)}
     </>
   )}
   ```

3. **Destructure `progressText`** from props in the component function parameters.

**Part B: Update ItemEditorModal.tsx**

1. **Add `progressText` state:**
   ```typescript
   const [progressText, setProgressText] = useState<string | null>(null);
   ```

2. **Import `isAbortError`** from `../../lib/abort`.

3. **Update `executeGeneration` function** (around line 440):

   a. After setting `isGenerating(true)` and creating the AbortController, add progress text cycling:
   ```typescript
   setProgressText(t.ai.progressAnalyzing);

   // Cycle progress text every 2s
   const progressInterval = setInterval(() => {
     setProgressText(prev => {
       if (prev === t.ai.progressAnalyzing) return t.ai.progressGenerating;
       if (prev === t.ai.progressGenerating) return t.ai.progressFinalizing;
       return prev;
     });
   }, 2000);
   ```

   b. **CRITICAL FIX (GENX-03): Pass signal to generateItemFromDescription.** The `generateItemFromDescription` function accepts `AIOptions` which extends `BaseAIOptions`. Currently (line 453):
   ```typescript
   const result = await generateItemFromDescription(promptText, {
     provider: selectedProvider,
     projectPath,
     availableTypes: types,
     items,
     projectId: projectId ?? undefined,
     typeConfigs: types,
     images: imageData.length > 0 ? imageData : undefined,
   });
   ```

   The `provider: selectedProvider` is already passed, which IS the override from the toggle. Looking at `generateItemFromDescription` (ai.ts line 1123-1125):
   ```typescript
   const { provider, modelId } = getEffectiveAIConfig(options?.projectPath);
   const effectiveProvider = options?.provider || provider;
   ```
   So `options.provider` IS used as override. The bug was previously that the provider wasn't being passed, but looking at the current code, it IS being passed. Let me verify more carefully...

   Actually, looking at the code flow: `selectedProvider` state is initialized from `getProvider()` (line 219). The `ProviderToggle` in `AIGenerationMode` calls `onProviderChange` which sets `selectedProvider`. Then `executeGeneration` passes `provider: selectedProvider`. So the override IS wired.

   **BUT WAIT:** The `AIOptions` interface does NOT have a `signal` field. `AIOptions` extends `BaseAIOptions`:
   ```typescript
   export interface AIOptions extends BaseAIOptions {
     projectId?: number;
     items?: BacklogItem[];
     typeConfigs?: TypeDefinition[];
     images?: ImageData[];
   }
   ```

   And `BaseAIOptions` (from ai-context.ts) likely doesn't have signal either. So we need to check if `generateItemFromDescription` passes options through to `generateCompletionWithRetry` which now accepts signal via `CompletionOptions`.

   Looking at `generateItemFromDescription` (line 1173):
   ```typescript
   const result = await generateCompletionWithRetry(
     prompt,
     GenerateItemResponseSchema,
     { provider: effectiveProvider, modelId, images: options?.images }
   );
   ```

   The third argument is `CompletionOptions` which now has `signal`. But `options?.signal` is not being forwarded! We need to:

   a. Add `signal?: AbortSignal` to the `AIOptions` interface
   b. Forward `signal` in the `generateCompletionWithRetry` call inside `generateItemFromDescription`
   c. Do the same for `refineItem` and other AI functions that accept `AIOptions`

   **Actually, modifying AIOptions in ai.ts would change the Plan 02 file.** Since Plan 02 is wave 1 and this is wave 2, Plan 02 will have already run. We CAN modify ai.ts here to add signal to AIOptions and forward it.

   **UPDATE files_modified:** Add `src/lib/ai.ts` to the list. Actually, looking at Plan 02's files_modified, it only lists `src/lib/ai.ts`. Plans from different waves CAN modify the same file since they run sequentially. Plan 03 depends_on Plan 02, so this is safe.

   In `src/lib/ai.ts`:
   - Add `signal?: AbortSignal;` to `AIOptions` interface
   - In `generateItemFromDescription`, forward signal:
     ```typescript
     const result = await generateCompletionWithRetry(
       prompt,
       GenerateItemResponseSchema,
       { provider: effectiveProvider, modelId, images: options?.images, signal: options?.signal }
     );
     ```
   - In `refineItem`, forward signal similarly:
     ```typescript
     const result = await generateCompletionWithRetry(
       prompt,
       RefineResponseSchema,
       { provider: effectiveProvider, modelId, signal: options?.signal }
     );
     ```
   - In `suggestImprovements`, forward signal:
     ```typescript
     const result = await generateCompletionWithRetry(
       prompt,
       SuggestionsResponseSchema,
       { provider: effectiveProvider, modelId, signal: options?.signal }
     );
     ```

   c. Pass signal from AbortController in `executeGeneration`:
   ```typescript
   const result = await generateItemFromDescription(promptText, {
     provider: selectedProvider,
     projectPath,
     availableTypes: types,
     items,
     projectId: projectId ?? undefined,
     typeConfigs: types,
     images: imageData.length > 0 ? imageData : undefined,
     signal: controller.signal,  // NEW: enable cancellation
   });
   ```

   d. **Update error handling** to distinguish cancellation from real errors. Replace the abort check (line 464) and the alert (line 529):

   After the `generateItemFromDescription` call, instead of:
   ```typescript
   if (controller.signal.aborted) {
     setIsGenerating(false);
     return;
   }
   ```

   Wrap the entire generation in try/catch:
   ```typescript
   try {
     const result = await generateItemFromDescription(promptText, {
       ...options,
       signal: controller.signal,
     });

     if (result.success && result.item) {
       // ... existing success handling ...
     } else {
       // Show error with retry option
       setGenerationError(result.error || t.aiErrors.unknownError);
     }
   } catch (error) {
     if (isAbortError(error)) {
       // User cancelled — silent, no error shown
       return;
     }
     setGenerationError(error instanceof Error ? error.message : t.aiErrors.unknownError);
   } finally {
     clearInterval(progressInterval);
     setIsGenerating(false);
     setProgressText(null);
     abortControllerRef.current = null;
   }
   ```

   e. **Add generation error state** and retry:
   ```typescript
   const [generationError, setGenerationError] = useState<string | null>(null);
   ```

   Add a retry function:
   ```typescript
   const handleRetryGeneration = useCallback(() => {
     setGenerationError(null);
     handleGenerateFromAI();
   }, [handleGenerateFromAI]);
   ```

   Clear error on new generation or modal open (in the useEffect that resets state when `isOpen` changes, add `setGenerationError(null)`).

4. **Pass `progressText` to AIGenerationMode:**
   In the JSX where `<AIGenerationMode>` is rendered, add the prop:
   ```tsx
   <AIGenerationMode
     ...existing props
     progressText={progressText}
   />
   ```

5. **Add error feedback UI** in AIGenerationMode or as inline in the AI mode section. Add error display BELOW the AIGenerationMode component when in AI mode:
   ```tsx
   {aiMode && generationError && (
     <div className="max-w-2xl mx-auto mt-4 px-4 py-3 rounded-xl bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800">
       <div className="flex items-start gap-3">
         <div className="flex-1">
           <p className="text-sm font-medium text-red-800 dark:text-red-300">
             {t.ai.generationFailed}
           </p>
           <p className="text-xs text-red-600 dark:text-red-400 mt-1">
             {generationError}
           </p>
         </div>
         <button
           onClick={handleRetryGeneration}
           className="px-3 py-1.5 text-xs font-medium text-red-700 dark:text-red-300 bg-red-100 dark:bg-red-800/40 hover:bg-red-200 dark:hover:bg-red-800/60 rounded-lg transition-colors"
         >
           {t.ai.retry}
         </button>
       </div>
     </div>
   )}
   ```

6. **Update `handleCancelGeneration`** to also clear progress text:
   ```typescript
   const handleCancelGeneration = useCallback(() => {
     abortControllerRef.current?.abort();
     setIsGenerating(false);
     setProgressText(null);
     abortControllerRef.current = null;
   }, []);
   ```
  </action>
  <verify>
1. `pnpm build` passes
2. AIGenerationMode accepts and displays `progressText` prop
3. ItemEditorModal passes `signal` to generateItemFromDescription
4. Cancel button aborts controller and clears progress text
5. Error display shows with retry button when generation fails
6. isAbortError prevents error toast on user cancellation
  </verify>
  <done>
AIGenerationMode shows progress text that cycles through 3 stages during generation. ItemEditorModal passes AbortController signal to generateItemFromDescription. Cancel aborts the signal which propagates to SDK. Failed generations show error with retry button. Cancelled operations are silent (no error toast). Provider selector override works (was already working, confirmed).
  </done>
</task>

<task type="auto">
  <name>Task 2: Add i18n keys for generation UX (INTL-03)</name>
  <files>
    src/i18n/types.ts
    src/i18n/locales/en.ts
    src/i18n/locales/fr.ts
  </files>
  <action>
Add all i18n keys needed for Phase 24 generation UX. These keys are consumed by Task 1's UI changes.

**1. Update `src/i18n/types.ts`:**

In the `ai` section of the Translations interface, add:
```typescript
progressAnalyzing: string;
progressGenerating: string;
progressFinalizing: string;
generationFailed: string;
retry: string;
generationCancelled: string;
```

**2. Update `src/i18n/locales/en.ts`:**

In the `ai` section, add:
```typescript
progressAnalyzing: 'Analyzing your request...',
progressGenerating: 'Generating ticket structure...',
progressFinalizing: 'Finalizing details...',
generationFailed: 'Generation failed',
retry: 'Retry',
generationCancelled: 'Generation cancelled',
```

**3. Update `src/i18n/locales/fr.ts`:**

In the `ai` section, add:
```typescript
progressAnalyzing: 'Analyse de votre demande...',
progressGenerating: 'Generation de la structure du ticket...',
progressFinalizing: 'Finalisation des details...',
generationFailed: 'Echec de la generation',
retry: 'Reessayer',
generationCancelled: 'Generation annulee',
```

**Note:** Verify that the `ai` section exists in the Translations interface. Looking at the types.ts file, find the `ai` section and add the new keys there. If the section has different nesting, adapt accordingly.

Also verify no duplicate keys — the `editor.cancelGeneration` key already exists (used in AIGenerationMode cancel button label), so do not duplicate it.
  </action>
  <verify>
1. `pnpm build` passes (TypeScript enforces all keys present in both locales)
2. Search for `progressAnalyzing` in types.ts, en.ts, fr.ts — all three files have it
3. No duplicate keys
  </verify>
  <done>
All Phase 24 generation UX i18n keys added: progress stages (3 keys), error feedback (2 keys), cancellation (1 key). Both FR and EN locales complete. TypeScript compilation verifies completeness.
  </done>
</task>

</tasks>

<verification>
1. `pnpm build` passes without TypeScript errors
2. AIGenerationMode displays cycling progress text during generation
3. Cancel button triggers abort which propagates through signal to SDK
4. Cancelled operations show no error (isAbortError check)
5. Failed generations show error message with retry button
6. Retry button re-triggers generation
7. Provider selector in modal IS used as override (confirmed existing behavior)
8. Signal is passed from ItemEditorModal → generateItemFromDescription → generateCompletionWithRetry → generateCompletion → SDK
9. AIOptions interface has `signal?: AbortSignal`
10. All new strings have FR + EN translations
</verification>

<success_criteria>
- Progress text visible during AI generation (3 cycling stages)
- Cancel button works and silently aborts without error toast
- Error feedback shows with retry option
- Provider override confirmed working
- Complete i18n coverage for Phase 24 (FR + EN)
- `pnpm build` passes
</success_criteria>

<output>
After completion, create `.planning/phases/24-validation-generation-ux/24-03-SUMMARY.md`
</output>
