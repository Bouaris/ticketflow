---
milestone: v2.1
audited: 2026-02-16T23:00:00Z
status: gaps_found
scores:
  requirements: 16/18
  phases: 3/3
  integration: 16/18
  flows: 2/4
gaps:
  requirements:
    - "GENX-03: Provider override sends wrong modelId — Groq called with gemini-2.0-flash"
    - "PROV-01: No model selector in AI Settings — user cannot choose model per provider"
  integration:
    - "getEffectiveAIConfig returns global modelId even when provider is overridden (8 functions affected)"
    - "ProviderToggle hardcoded to 3 built-in providers — custom providers not selectable in generation"
  flows:
    - "Flow 2 BROKEN: Provider override generates with wrong model → API 404 error"
    - "Flow 4 NOT IMPLEMENTED: No model selection UI or persistence"
tech_debt:
  - phase: 22-provider-registry-core-refactor
    items:
      - "getEffectiveAIConfig(_projectPath?) keeps unused parameter for backward compat (16 call sites)"
      - "Custom providers default to conservative capabilities (structuredOutput: false, multimodal: false)"
  - phase: 24-validation-generation-ux
    items:
      - "Health check has no retry logic (fails on first error — intentional fail-fast design)"
      - "Deferred: latency stats dashboard in AI Settings (avg latency per provider)"
      - "Deferred: telemetry tracking for health check success/failure rates"
---

# v2.1 "AI Refresh" — Milestone Audit Report (Re-Audit)

**Audited:** 2026-02-16T23:00:00Z
**Status:** GAPS FOUND
**Score:** 16/18 requirements satisfied (2 gaps: 1 broken, 1 partial)

**Re-audit trigger:** User-reported bugs during manual testing — provider override not working, model selection missing.

## Milestone Definition of Done

**Goal:** Refactor AI settings UX — separate app settings from AI config, add custom provider support, fix provider override logic, improve generation feedback.

**Verdict:** Settings split and custom provider CRUD work correctly. However, **provider override is broken** (wrong model sent to API) and **model selection is missing** from the UI. These are core goals of the milestone.

## Phase Verification Summary

| Phase | Name | Plans | Status | Score | Requirements |
|-------|------|-------|--------|-------|-------------|
| 22 | Provider Registry & Core Refactor | 3/3 | PASSED | 10/10 truths | PROV-06, INTL-01, INTL-02 |
| 23 | Settings UI Split & Provider Config | 3/3 | GAPS | 5/5 truths, 1 missing feature | SETT-01..04, PROV-01 (partial), PROV-02..03, PROV-05 |
| 24 | Validation & Generation UX | 3/3 | GAPS | 8/8 truths, 1 broken flow | PROV-04, GENX-01..02, GENX-03 (broken), GENX-04..05, INTL-03 |

## Critical Gaps

### Gap 1: Provider Override Sends Wrong Model (GENX-03) — P0

**Severity:** CRITICAL — blocks provider override entirely
**User symptom:** Selecting Groq/OpenAI in ticket creation still generates with Gemini (or causes API 404)

**Root cause:** In `src/lib/ai.ts`, `getEffectiveAIConfig()` returns the **global** provider's model. When a different provider is selected in the UI, only the provider ID is overridden — the model stays as the global provider's model.

```typescript
// ai.ts line 1183-1184 (generateItemFromDescription)
const { provider, modelId } = getEffectiveAIConfig(options?.projectPath);
const effectiveProvider = options?.provider || provider;
// BUG: modelId = 'gemini-2.0-flash' (from global), effectiveProvider = 'groq' (from override)
// Result: Groq API called with model 'gemini-2.0-flash' → 404 error
```

**Affected functions (8 total):**

| Function | File | Lines |
|----------|------|-------|
| generateItemFromDescription | ai.ts | 1183-1184 |
| refineItem | ai.ts | ~811-812 |
| suggestImprovements | ai.ts | ~1347-1348 |
| analyzeBacklogFormat | ai.ts | ~1646-1647 |
| correctBacklogFormat | ai.ts | ~1698-1699 |
| analyzeBacklog | ai.ts | ~2015-2016 |
| analyzeBacklog telemetry | ai.ts | ~2143-2144 |
| detectDependencies | ai-dependencies.ts | ~194-195, 244-245 |

**Fix:** When provider is overridden, resolve model from that provider's registry entry:

```typescript
const effectiveProvider = options?.provider || getProvider();
const providerConfig = getProviderById(effectiveProvider);
const effectiveModel = options?.modelId || providerConfig?.defaultModel || fallbackModel;
```

### Gap 2: No Model Selector in AI Settings (PROV-01) — P1

**Severity:** HIGH — requirement partially unmet
**User symptom:** "On a plus l'option pour selectionner le model"

**Root cause:** `ProviderCard.tsx` only has API key input + test connection. No model dropdown despite:
- Registry has `models[]` array per provider (4 models for Groq, 3 for Gemini, 3 for OpenAI)
- `getDefaultModelForProvider()` exists in registry but is NOT consumed by any UI
- Requirement PROV-01 explicitly says "with API key **and model**"

**Missing:**
1. Model dropdown in ProviderCard (UI)
2. Per-provider model persistence in localStorage (storage)
3. `getEffectiveAIConfig` should read persisted model choice (logic)

## Requirements Coverage

### Settings Architecture (4/4)

| Req | Description | Phase | Status |
|-----|-------------|-------|--------|
| SETT-01 | App Settings separate from AI Settings | 23 | SATISFIED |
| SETT-02 | Dedicated AI Settings panel from header | 23 | SATISFIED |
| SETT-03 | Project-level AI selector removed | 23 | SATISFIED |
| SETT-04 | AI config migrated to new AI Settings panel | 23 | SATISFIED |

### Provider Management (5/6)

| Req | Description | Phase | Status |
|-----|-------------|-------|--------|
| PROV-01 | Configure built-in providers with API key and model | 23 | **PARTIAL** — API key works, model selector missing |
| PROV-02 | Add custom OpenAI-compatible providers | 23 | SATISFIED |
| PROV-03 | Edit and delete custom providers | 23 | SATISFIED |
| PROV-04 | Test provider connection with latency + error details | 24 | SATISFIED |
| PROV-05 | Provider status indicator (configured/not) | 23 | SATISFIED |
| PROV-06 | CSP updated for custom HTTPS endpoints | 22 | SATISFIED |

### Generation UX (4/5)

| Req | Description | Phase | Status |
|-----|-------------|-------|--------|
| GENX-01 | Loading spinner and progress text during generation | 24 | SATISFIED |
| GENX-02 | Cancel in-flight AI generation | 24 | SATISFIED |
| GENX-03 | Provider selector actually overrides default | 24 | **NOT SATISFIED** — sends wrong modelId, causes API errors |
| GENX-04 | Gemini free tier recommendation tooltip | 24 | SATISFIED |
| GENX-05 | User-friendly error messages with retry | 24 | SATISFIED |

### Internals (3/3)

| Req | Description | Phase | Status |
|-----|-------------|-------|--------|
| INTL-01 | Provider registry centralizes all provider logic | 22 | SATISFIED |
| INTL-02 | Client singleton cache supports custom baseURL | 22 | SATISFIED |
| INTL-03 | i18n keys for all new AI settings UI (FR + EN) | 24 | SATISFIED |

## Cross-Phase Integration

**Integration checker:** 16/18 connections verified, 2 broken.

| From | To | Connection | Status |
|------|----|-----------|--------|
| Phase 22 registry | Phase 23 AISettingsModal | BUILT_IN_PROVIDERS import | WIRED |
| Phase 22 registry | Phase 23 ProviderCard | ProviderConfig type | WIRED |
| Phase 22 registry | Phase 23 CustomProviderForm | validateCustomProvider, addCustomProvider | WIRED |
| Phase 22 registry | Phase 23 CustomProviderList | loadCustomProviders, removeCustomProvider | WIRED |
| Phase 22 registry models[] | Phase 23 ProviderCard UI | **model selector dropdown** | **MISSING** |
| Phase 22 getDefaultModelForProvider | Phase 24 ai.ts override | **model resolution for overridden provider** | **BROKEN** |
| Phase 22 ai.ts | Phase 24 ai-health.ts | testProviderConnection export | WIRED |
| Phase 22 CSP | Phase 24 health check | HTTPS endpoints allowed | WIRED |
| Phase 23 ProviderCard | Phase 24 ai-health.ts | testProviderHealth import | WIRED |
| Phase 24 signal | Phase 22 ai.ts | AbortSignal in CompletionOptions | WIRED |
| Phase 23 App.tsx | Phase 23 Header | onOpenAISettings callback | WIRED |
| Phase 23 Header | Phase 23 ProjectWorkspace | showAISettingsBadge prop | WIRED |

## E2E User Flows

| Flow | Description | Steps | Status |
|------|-------------|-------|--------|
| 1 | Configure New Provider | Header → AISettings → ProviderCard → Save → Test → Badge clears | COMPLETE |
| 2 | Add Custom Provider | AISettings → Custom tab → Form → Validate → Save → List updated | COMPLETE |
| 3 | Generate with Provider Override | New Item → Select provider → Prompt → Generate | **BROKEN** — wrong model sent |
| 4 | Model Selection | AISettings → Provider → Select model → Save → Used in generation | **NOT IMPLEMENTED** |
| 5 | Cancel Generation | Start generation → Cancel → Abort signal → Silent return | COMPLETE |

### Flow 3 Failure Detail

```
1. User has Gemini as default (global config, model: gemini-2.0-flash)
2. User opens ticket creation → ProviderToggle shows Gemini highlighted
3. User clicks "Groq" in toggle → setSelectedProvider('groq') → visual update OK
4. User clicks "Generer avec Groq"
5. generateItemFromDescription({ provider: 'groq' }) called
6. getEffectiveAIConfig() returns { provider: 'gemini', modelId: 'gemini-2.0-flash' }
7. effectiveProvider = 'groq' (overridden correctly)
8. modelId = 'gemini-2.0-flash' (NOT overridden — BUG)
9. generateCompletion({ provider: 'groq', modelId: 'gemini-2.0-flash' })
10. Groq API called with model 'gemini-2.0-flash' → 404 "model not found"
```

## Tech Debt (Non-Critical)

### Phase 22: Provider Registry
- `getEffectiveAIConfig(_projectPath?)` keeps unused parameter for backward compat (16 call sites)
- Custom providers default to conservative capabilities (structuredOutput: false, multimodal: false)
- ProviderToggle hardcoded to 3 built-in providers (custom providers not selectable in generation)

### Phase 24: Generation UX
- Health check has no retry logic (intentional fail-fast design)
- Deferred: latency stats dashboard (PROV-07)
- Deferred: telemetry tracking for health check (PROV-09)

**Total: 5 tech debt items + 2 critical gaps.**

## Code Metrics

| Metric | Value |
|--------|-------|
| Files created | 8 |
| Files modified | 24 |
| Files deleted | 3 (SettingsModal.tsx, useProjectAIConfig.ts, projectAIConfig.ts) |
| Net lines changed | +756 |
| Plans executed | 9 |
| Commits | 15 |
| i18n keys added | 38 (20 Phase 23 + 18 Phase 24) |
| Build status | PASSED (1581 modules, 0 TS errors) |

## Conclusion

Milestone v2.1 "AI Refresh" has **2 gaps** that need closure:

1. **P0 — Provider override broken** (GENX-03): The `getEffectiveAIConfig` pattern sends the global provider's model when a different provider is selected. Affects 8 functions in ai.ts and ai-dependencies.ts. Fix is straightforward: resolve model from overridden provider's registry entry.

2. **P1 — Model selection missing** (PROV-01 partial): ProviderCard has no model dropdown. The registry already has `models[]` arrays and `getDefaultModelForProvider()`, but no UI consumes them. Needs: model dropdown in ProviderCard, localStorage persistence, and `getEffectiveAIConfig` integration.

**What works well:**
- Settings split (SETT-01..04): Clean separation, good UX
- Custom providers (PROV-02..03): Full CRUD with Zod validation
- Provider registry (INTL-01..02): Solid architecture, single source of truth
- Generation UX (GENX-01, 02, 04, 05): Progress, cancel, errors, Gemini badge all work
- CSP and health checks (PROV-04, 06): Properly wired

---

*Re-audited: 2026-02-16T23:00:00Z (supersedes previous audit from 21:00:00Z)*
*Trigger: User-reported bugs during manual testing*
*Integration checker: Claude Sonnet 4.5 (gsd-integration-checker)*
*Orchestrator: Claude Opus 4.6 (audit-milestone)*
